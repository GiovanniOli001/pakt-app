<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#f97316">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="PAKT">
  <meta name="application-name" content="PAKT">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="description" content="PAKT - Lunch. Chores. Done. The smart lunchbox planner for Aussie families.">
  
  <title>ğŸ± PAKT</title>
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-D98VXQ2XM2"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-D98VXQ2XM2');
  </script>
  
  <!-- App Icons -->
  <link rel="icon" href="/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/icon-192.png">
  <link rel="manifest" href="/manifest.json">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
  
  <!-- Register Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW failed', err));
      });
    }
  </script>
  
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    html, body, #root { height: 100%; width: 100%; margin: 0; padding: 0; }
    body { font-family: 'Fredoka', sans-serif; background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 50%, #fed7d7 100%); }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="react">
// Destructure React hooks for browser use
const { useState, useEffect, useRef, useCallback } = React;

// Analytics tracking helper
const trackEvent = (eventName, params = {}) => {
  if (typeof gtag !== 'undefined') {
    gtag('event', eventName, params);
    console.log('[Analytics]', eventName, params);
  }
};

// Throttled tracking - max once per 60 seconds per event type
const lastTracked = {};
const trackEventThrottled = (eventName, params = {}) => {
  const now = Date.now();
  if (lastTracked[eventName] && now - lastTracked[eventName] < 60000) {
    return; // Skip if tracked in last 60 seconds
  }
  lastTracked[eventName] = now;
  trackEvent(eventName, params);
};

// Bento Icon SVG Component - matches the app icon
const BentoIcon = ({ size = 32, className = '' }) => (
  <svg width={size} height={size} viewBox="0 0 100 100" className={className}>
    <rect x="10" y="18" width="80" height="64" rx="8" fill="#f97316" stroke="#c2410c" strokeWidth="3"/>
    <rect x="14" y="22" width="72" height="56" rx="5" fill="#fef3c7"/>
    <line x1="48" y1="22" x2="48" y2="78" stroke="#f97316" strokeWidth="2"/>
    <line x1="14" y1="50" x2="48" y2="50" stroke="#f97316" strokeWidth="2"/>
    <circle cx="31" cy="36" r="10" fill="#4ade80"/>
    <circle cx="31" cy="64" r="10" fill="#fbbf24"/>
    <circle cx="66" cy="50" r="14" fill="#f87171"/>
  </svg>
);



// App Version
const APP_VERSION = '0.6.0';

// Dietary Mode Presets
const DIETARY_MODES = {
  none: { name: 'No Filter', icon: 'ğŸ½ï¸', excludeAllergens: [], excludeCategories: [] },
  vegetarian: { name: 'Vegetarian', icon: 'ğŸ¥¬', excludeAllergens: [], excludeItems: ['chicken', 'beef', 'lamb', 'pork', 'fish', 'prawn', 'tuna', 'salmon', 'ham', 'salami', 'bacon', 'meatball', 'sausage', 'frankfurt', 'turkey', 'roast beef', 'roast chicken', 'roast lamb', 'drumstick', 'wing', 'steak', 'mince', 'schnitzel', 'nugget', 'kebab', 'meatloaf', 'bolognese', 'carbonara'] },
  vegan: { name: 'Vegan', icon: 'ğŸŒ±', excludeAllergens: ['dairy', 'eggs'], excludeItems: ['chicken', 'beef', 'lamb', 'pork', 'fish', 'prawn', 'tuna', 'salmon', 'ham', 'salami', 'bacon', 'meatball', 'sausage', 'frankfurt', 'turkey', 'roast beef', 'roast chicken', 'roast lamb', 'drumstick', 'wing', 'steak', 'mince', 'schnitzel', 'cheese', 'yogurt', 'yoghurt', 'milk', 'cream', 'butter', 'egg', 'honey', 'mayo', 'mayonnaise', 'nugget', 'kebab', 'meatloaf', 'bolognese', 'carbonara', 'custard', 'quiche'] },
  halal: { name: 'Halal', icon: 'â˜ªï¸', excludeAllergens: [], excludeItems: ['pork', 'ham', 'bacon', 'salami', 'prosciutto', 'gelatin', 'frankfurt', 'pepperoni'] },
  nutFreeSchool: { name: 'Nut-Free School', icon: 'ğŸš«ğŸ¥œ', excludeAllergens: ['peanuts', 'tree nuts'], excludeItems: ['peanut', 'almond', 'cashew', 'walnut', 'nutella', 'pistachio', 'macadamia', 'pecan', 'hazelnut'] },
  dairyFree: { name: 'Dairy-Free', icon: 'ğŸ¥›ğŸš«', excludeAllergens: ['dairy'], excludeItems: ['cheese', 'yogurt', 'yoghurt', 'milk', 'cream', 'butter', 'custard', 'ice cream'] },
  glutenFree: { name: 'Gluten-Free', icon: 'ğŸŒ¾ğŸš«', excludeAllergens: ['gluten'], excludeItems: ['bread', 'pasta', 'cracker', 'wrap', 'sandwich', 'muffin', 'cookie', 'cake', 'pastry', 'croissant', 'noodle', 'couscous', 'pizza'] },
};

// Food data organized by the 6 food groups (Pick'n'Mix system)
// Each item now has specific ingredients for the shopping list
const FOOD_DATABASE = {
  fruit: {
    name: 'Fruit',
    emoji: 'ğŸ',
    color: '#FF6B6B',
    items: [
      { id: 'apple-sliced', name: 'Sliced Apple', emoji: 'ğŸ', allergens: [], ingredients: [{ name: 'Apple', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Wash apple', 'Cut into quarters, remove core', 'Slice into wedges', 'Squeeze lemon juice to prevent browning (optional)'], tip: 'ğŸ’¡ Pack with a rubber band around to keep slices together' } },
      { id: 'banana', name: 'Banana', emoji: 'ğŸŒ', allergens: [], ingredients: [{ name: 'Banana', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '30 secs', steps: ['Peel and pack whole, or slice if preferred'], tip: 'ğŸ’¡ Choose slightly green bananas - they won\'t go brown as fast' } },
      { id: 'grapes-red', name: 'Red Grapes', emoji: 'ğŸ‡', allergens: [], ingredients: [{ name: 'Red Grapes', qty: 1, unit: 'handful', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Wash grapes thoroughly', 'Remove from stems', 'Pat dry and pack'], tip: 'ğŸ’¡ Cut in half lengthways for children under 5' } },
      { id: 'grapes-green', name: 'Green Grapes', emoji: 'ğŸ‡', allergens: [], ingredients: [{ name: 'Green Grapes', qty: 1, unit: 'handful', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Wash grapes thoroughly', 'Remove from stems', 'Pat dry and pack'], tip: 'ğŸ’¡ Cut in half lengthways for children under 5' } },
      { id: 'orange-segments', name: 'Orange Segments', emoji: 'ğŸŠ', allergens: [], ingredients: [{ name: 'Orange', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '3 mins', steps: ['Cut top and bottom off orange', 'Slice off peel following the curve', 'Cut between membranes to release segments'], tip: 'ğŸ’¡ Do this the night before - segments keep well in the fridge' } },
      { id: 'mandarin', name: 'Mandarin', emoji: 'ğŸŠ', allergens: [], ingredients: [{ name: 'Mandarin', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '30 secs', steps: ['Pack whole - kids can peel themselves!'], tip: 'ğŸ’¡ Easy-peel varieties are best for little hands' } },
      { id: 'strawberries', name: 'Fresh Strawberries', emoji: 'ğŸ“', allergens: [], ingredients: [{ name: 'Strawberries', qty: 6, unit: '', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Wash strawberries', 'Remove stems', 'Cut large ones in half', 'Pat dry before packing'], tip: 'ğŸ’¡ Don\'t wash until ready to pack - they stay fresher' } },
      { id: 'watermelon-cubes', name: 'Watermelon Cubes', emoji: 'ğŸ‰', allergens: [], ingredients: [{ name: 'Watermelon', qty: 1, unit: 'cup cubed', category: 'Produce' }], recipe: { prepTime: '3 mins', steps: ['Cut watermelon slice', 'Remove rind', 'Cut into bite-sized cubes', 'Pack in leak-proof container'], tip: 'ğŸ’¡ Remove seeds or buy seedless variety' } },
      { id: 'kiwi-sliced', name: 'Sliced Kiwi', emoji: 'ğŸ¥', allergens: [], ingredients: [{ name: 'Kiwi Fruit', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Cut off both ends', 'Slide spoon between flesh and skin', 'Rotate to remove skin', 'Slice into rounds'], tip: 'ğŸ’¡ Or cut in half and pack a spoon - kids scoop it out!' } },
      { id: 'pear-sliced', name: 'Sliced Pear', emoji: 'ğŸ', allergens: [], ingredients: [{ name: 'Pear', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Wash pear', 'Cut into quarters, remove core', 'Slice into wedges', 'Squeeze lemon juice to prevent browning'], tip: 'ğŸ’¡ Slightly firm pears travel better than ripe ones' } },
      { id: 'blueberries', name: 'Blueberries', emoji: 'ğŸ«', allergens: [], ingredients: [{ name: 'Blueberries', qty: 1, unit: 'punnet', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Rinse blueberries', 'Pat dry gently', 'Pack in small container'], tip: 'ğŸ’¡ Great frozen on hot days - they\'ll thaw by lunchtime' } },
      { id: 'mango-sliced', name: 'Sliced Mango', emoji: 'ğŸ¥­', allergens: [], ingredients: [{ name: 'Mango', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '3 mins', steps: ['Stand mango upright, slice down each side of the stone', 'Score flesh in a grid pattern', 'Push skin to invert and cut off cubes'], tip: 'ğŸ’¡ Frozen mango chunks work great and are less messy!' } },
      { id: 'rockmelon-cubes', name: 'Rockmelon Cubes', emoji: 'ğŸˆ', allergens: [], ingredients: [{ name: 'Rockmelon', qty: 1, unit: 'cup cubed', category: 'Produce' }], recipe: { prepTime: '3 mins', steps: ['Cut rockmelon in half, scoop out seeds', 'Cut into wedges', 'Slice off rind', 'Cut into bite-sized cubes'], tip: 'ğŸ’¡ Use a melon baller for fun shapes!' } },
      { id: 'fruit-salad', name: 'Mixed Fruit Salad', emoji: 'ğŸ¥—', allergens: [], ingredients: [{ name: 'Apple', qty: 1, unit: '', category: 'Produce' }, { name: 'Orange', qty: 1, unit: '', category: 'Produce' }, { name: 'Grapes', qty: 1, unit: 'handful', category: 'Produce' }], recipe: { prepTime: '5 mins', steps: ['Chop apple into small cubes', 'Segment orange over bowl to catch juice', 'Halve grapes', 'Mix together - orange juice stops browning!'], tip: 'ğŸ’¡ Make a big batch Sunday night for the whole week' } },
      { id: 'dried-apricots', name: 'Dried Apricots', emoji: 'ğŸŸ ', allergens: [], ingredients: [{ name: 'Dried Apricots', qty: 5, unit: '', category: 'Pantry' }], recipe: { prepTime: '30 secs', steps: ['Count out 5 apricots', 'Pack in small container or wrap'], tip: 'ğŸ’¡ No prep needed - great pantry staple for busy mornings!' } },
      { id: 'sultanas', name: 'Sultanas', emoji: 'ğŸŸ¤', allergens: [], ingredients: [{ name: 'Sultanas', qty: 1, unit: 'small box', category: 'Pantry' }], recipe: { prepTime: '30 secs', steps: ['Pack a small box or portion into container'], tip: 'ğŸ’¡ Buy snack-sized boxes for zero prep!' } },
      { id: 'passionfruit', name: 'Passionfruit Halves', emoji: 'ğŸŸ¡', allergens: [], ingredients: [{ name: 'Passionfruit', qty: 2, unit: '', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Cut passionfruit in half', 'Pack with a small spoon'], tip: 'ğŸ’¡ Aussie favourite - tangy and delicious!' } },
      { id: 'lychees', name: 'Peeled Lychees', emoji: 'ğŸ”´', allergens: [], ingredients: [{ name: 'Lychees', qty: 6, unit: '', category: 'Produce' }], recipe: { prepTime: '3 mins', steps: ['Peel lychees', 'Remove seeds for younger kids', 'Pack in container'], tip: 'ğŸ’¡ In season in summer - kids love the unique flavour!' } },
      { id: 'dragon-fruit', name: 'Dragon Fruit Cubes', emoji: 'ğŸ©·', allergens: [], ingredients: [{ name: 'Dragon Fruit', qty: 0.5, unit: '', category: 'Produce' }], recipe: { prepTime: '3 mins', steps: ['Cut dragon fruit in half', 'Scoop out flesh', 'Cut into cubes'], tip: 'ğŸ’¡ Looks amazing and tastes mild and sweet!' } },
      { id: 'persimmon', name: 'Sliced Persimmon', emoji: 'ğŸŸ ', allergens: [], ingredients: [{ name: 'Persimmon', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Wash persimmon', 'Remove stem', 'Slice into wedges'], tip: 'ğŸ’¡ Must be super ripe and soft - like jelly inside!' } },
      { id: 'nectarine', name: 'Sliced Nectarine', emoji: 'ğŸ‘', allergens: [], ingredients: [{ name: 'Nectarine', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Wash nectarine', 'Cut in half, remove stone', 'Slice into wedges'], tip: 'ğŸ’¡ Aussie stone fruit season Dec-Feb!' } },
      { id: 'plum', name: 'Sliced Plum', emoji: 'ğŸŸ£', allergens: [], ingredients: [{ name: 'Plum', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Wash plum', 'Cut in half, remove stone', 'Slice into wedges'], tip: 'ğŸ’¡ Queen Garnets are extra sweet!' } },
      { id: 'cherries', name: 'Fresh Cherries', emoji: 'ğŸ’', allergens: [], ingredients: [{ name: 'Cherries', qty: 10, unit: '', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Wash cherries', 'Pack with stems on', 'Remind kids about pits!'], tip: 'ğŸ’¡ Tasmanian cherries are the best - summer treat!' } },
      { id: 'fig', name: 'Fresh Figs', emoji: 'ğŸŸ¤', allergens: [], ingredients: [{ name: 'Fresh Figs', qty: 2, unit: '', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Wash figs gently', 'Pack whole or halved'], tip: 'ğŸ’¡ Eat the whole thing - skin and all!' } },
      { id: 'frozen-mango-cheeks', name: 'Frozen Mango Cheeks', emoji: 'ğŸ¥­', allergens: [], ingredients: [{ name: 'Frozen Mango', qty: 0.5, unit: 'cup', category: 'Frozen' }], recipe: { prepTime: '30 secs', steps: ['Grab from freezer', 'Pack frozen - thaws by lunchtime'], tip: 'ğŸ’¡ Woolies frozen mango is just as good as fresh!' } },
      { id: 'apple-pink-lady', name: 'Pink Lady Apple', emoji: 'ğŸ', allergens: [], ingredients: [{ name: 'Pink Lady Apple', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '30 secs', steps: ['Wash and pack whole or sliced'], tip: 'ğŸ’¡ Aussie favourite - sweet and crisp!' } },
      { id: 'apple-granny-smith', name: 'Granny Smith Apple', emoji: 'ğŸ', allergens: [], ingredients: [{ name: 'Granny Smith Apple', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '30 secs', steps: ['Wash and pack whole or sliced'], tip: 'ğŸ’¡ Tart and crunchy - stays crisp longer!' } },
      { id: 'banana-lady-finger', name: 'Lady Finger Banana', emoji: 'ğŸŒ', allergens: [], ingredients: [{ name: 'Lady Finger Banana', qty: 2, unit: '', category: 'Produce' }], recipe: { prepTime: '30 secs', steps: ['Pack whole - perfect kid size!'], tip: 'ğŸ’¡ Smaller and sweeter than regular bananas!' } },
      { id: 'pineapple-chunks', name: 'Fresh Pineapple Chunks', emoji: 'ğŸ', allergens: [], ingredients: [{ name: 'Pineapple', qty: 1, unit: 'cup', category: 'Produce' }], recipe: { prepTime: '5 mins', steps: ['Cut off top and bottom', 'Slice off skin', 'Remove core and cut into chunks'], tip: 'ğŸ’¡ Buy pre-cut from Woolies for zero prep!' } },
      { id: 'honeydew-cubes', name: 'Honeydew Melon Cubes', emoji: 'ğŸˆ', allergens: [], ingredients: [{ name: 'Honeydew Melon', qty: 1, unit: 'cup', category: 'Produce' }], recipe: { prepTime: '3 mins', steps: ['Cut in half, remove seeds', 'Cut into cubes'], tip: 'ğŸ’¡ Light green and super sweet!' } },
      { id: 'raspberries', name: 'Fresh Raspberries', emoji: 'ğŸ”´', allergens: [], ingredients: [{ name: 'Raspberries', qty: 1, unit: 'punnet', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Gently rinse and pat dry', 'Pack in container'], tip: 'ğŸ’¡ Delicate - pack on top of other items!' } },
      { id: 'blackberries', name: 'Fresh Blackberries', emoji: 'ğŸ«', allergens: [], ingredients: [{ name: 'Blackberries', qty: 1, unit: 'punnet', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Rinse gently and pack'], tip: 'ğŸ’¡ High in antioxidants!' } },
      { id: 'apricot-fresh', name: 'Fresh Apricot', emoji: 'ğŸŸ ', allergens: [], ingredients: [{ name: 'Apricot', qty: 2, unit: '', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Wash and pack whole or halved'], tip: 'ğŸ’¡ Summer stone fruit - Dec to Feb!' } },
      { id: 'peach-sliced', name: 'Sliced Peach', emoji: 'ğŸ‘', allergens: [], ingredients: [{ name: 'Peach', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Cut in half, remove stone', 'Slice into wedges'], tip: 'ğŸ’¡ White peaches are extra sweet!' } },
      { id: 'star-fruit', name: 'Star Fruit Slices', emoji: 'â­', allergens: [], ingredients: [{ name: 'Star Fruit', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Wash and slice into star shapes'], tip: 'ğŸ’¡ Fun shape - kids love it!' } },
      { id: 'pomegranate-seeds', name: 'Pomegranate Seeds', emoji: 'ğŸ”´', allergens: [], ingredients: [{ name: 'Pomegranate', qty: 0.5, unit: '', category: 'Produce' }], recipe: { prepTime: '5 mins', steps: ['Cut in half', 'Tap seeds out over bowl'], tip: 'ğŸ’¡ Buy pre-seeded packs from Coles!' } },
      { id: 'fruit-cup-mango', name: 'Mango Fruit Cup', emoji: 'ğŸ¥­', allergens: [], ingredients: [{ name: 'Mango Fruit Cup', qty: 1, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack with a spoon'], tip: 'ğŸ’¡ Goulburn Valley brand is great!' } },
      { id: 'frozen-berries-mix', name: 'Frozen Berry Mix', emoji: 'ğŸ“', allergens: [], ingredients: [{ name: 'Frozen Berries', qty: 0.5, unit: 'cup', category: 'Frozen' }], recipe: { prepTime: '30 secs', steps: ['Pack frozen - thaws by lunch'], tip: 'ğŸ’¡ Woolies Select frozen berries are good value!' } },
    ]
  },
  vegetables: {
    name: 'Veggies',
    emoji: 'ğŸ¥•',
    color: '#4ECDC4',
    items: [
      { id: 'carrot-sticks', name: 'Carrot Sticks', emoji: 'ğŸ¥•', allergens: [], ingredients: [{ name: 'Carrots', qty: 1, unit: 'medium', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Wash and peel carrot', 'Cut off ends', 'Slice into sticks about finger-width'], tip: 'ğŸ’¡ Soak in ice water for 10 mins for extra crunch!' } },
      { id: 'cucumber-slices', name: 'Cucumber Slices', emoji: 'ğŸ¥’', allergens: [], ingredients: [{ name: 'Lebanese Cucumber', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Wash cucumber', 'Slice into rounds or sticks', 'No need to peel Lebanese cucumbers!'], tip: 'ğŸ’¡ Lebanese cucumbers have smaller seeds and thinner skin' } },
      { id: 'cherry-tomatoes', name: 'Cherry Tomatoes', emoji: 'ğŸ…', allergens: [], ingredients: [{ name: 'Cherry Tomatoes', qty: 6, unit: '', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Wash tomatoes', 'Pack whole or halve for younger kids'], tip: 'ğŸ’¡ Cut in half for children under 3 (choking hazard whole)' } },
      { id: 'capsicum-strips-red', name: 'Red Capsicum Strips', emoji: 'ğŸ«‘', allergens: [], ingredients: [{ name: 'Red Capsicum', qty: 0.5, unit: '', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Cut capsicum in half', 'Remove seeds and white membrane', 'Slice into strips'], tip: 'ğŸ’¡ Red capsicum is sweeter than green - kids love it!' } },
      { id: 'capsicum-strips-yellow', name: 'Yellow Capsicum Strips', emoji: 'ğŸ«‘', allergens: [], ingredients: [{ name: 'Yellow Capsicum', qty: 0.5, unit: '', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Cut capsicum in half', 'Remove seeds and white membrane', 'Slice into strips'], tip: 'ğŸ’¡ Mix colours for a rainbow veggie cup!' } },
      { id: 'celery-sticks', name: 'Celery Sticks', emoji: 'ğŸ¥¬', allergens: [], ingredients: [{ name: 'Celery', qty: 2, unit: 'stalks', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Wash celery stalks', 'Trim ends', 'Cut into shorter sticks if needed'], tip: 'ğŸ’¡ Remove strings by snapping end and pulling down' } },
      { id: 'celery-ants-log', name: 'Ants on a Log', emoji: 'ğŸ¥¬', allergens: ['peanuts'], ingredients: [{ name: 'Celery', qty: 2, unit: 'stalks', category: 'Produce' }, { name: 'Peanut Butter', qty: 1, unit: 'tbsp', category: 'Pantry' }, { name: 'Sultanas', qty: 1, unit: 'tbsp', category: 'Pantry' }], recipe: { prepTime: '3 mins', steps: ['Wash and cut celery into sticks', 'Fill groove with peanut butter', 'Press sultanas into peanut butter'], tip: 'ğŸ’¡ Use sun butter for nut-free version!' } },
      { id: 'corn-cob', name: 'Mini Corn Cob', emoji: 'ğŸŒ½', allergens: [], ingredients: [{ name: 'Mini Corn Cobs', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '5 mins', steps: ['Boil or microwave corn until tender (3-4 mins)', 'Let cool completely', 'Pack whole or cut in half'], tip: 'ğŸ’¡ Cook the night before - cold corn is delicious!' } },
      { id: 'broccoli-florets', name: 'Broccoli Florets', emoji: 'ğŸ¥¦', allergens: [], ingredients: [{ name: 'Broccoli', qty: 4, unit: 'florets', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Wash broccoli', 'Cut into small florets', 'Pack raw or blanch for 1 min if preferred'], tip: 'ğŸ’¡ Call them "little trees" - kids eat more!' } },
      { id: 'snow-peas', name: 'Snow Peas', emoji: 'ğŸ«›', allergens: [], ingredients: [{ name: 'Snow Peas', qty: 8, unit: '', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Wash snow peas', 'Snap off stem end and pull string', 'Pack whole'], tip: 'ğŸ’¡ Super crunchy and naturally sweet - no cooking needed!' } },
      { id: 'sugar-snap-peas', name: 'Sugar Snap Peas', emoji: 'ğŸ«›', allergens: [], ingredients: [{ name: 'Sugar Snap Peas', qty: 8, unit: '', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Wash snap peas', 'Remove string from seam if tough', 'Pack whole'], tip: 'ğŸ’¡ Even crunchier than snow peas - great for dipping!' } },
      { id: 'edamame', name: 'Edamame Beans', emoji: 'ğŸ«˜', allergens: ['soy'], ingredients: [{ name: 'Edamame (frozen)', qty: 0.5, unit: 'cup', category: 'Frozen' }], recipe: { prepTime: '3 mins', steps: ['Boil frozen edamame for 3 mins', 'Drain and cool', 'Sprinkle with a tiny bit of salt', 'Pack in pods or shelled'], tip: 'ğŸ’¡ Kids love popping them out of the pods!' } },
      { id: 'veggie-sticks-hummus', name: 'Veggie Sticks & Hummus', emoji: 'ğŸ¥•', allergens: ['sesame'], ingredients: [{ name: 'Carrots', qty: 1, unit: '', category: 'Produce' }, { name: 'Cucumber', qty: 0.5, unit: '', category: 'Produce' }, { name: 'Hummus', qty: 2, unit: 'tbsp', category: 'Deli' }], recipe: { prepTime: '3 mins', steps: ['Cut carrots and cucumber into sticks', 'Put hummus in small container', 'Pack veggies separately to keep crisp'], tip: 'ğŸ’¡ Use a bento box with built-in dip section!' } },
      { id: 'sweet-potato-coins', name: 'Roasted Sweet Potato Coins', emoji: 'ğŸ ', allergens: [], ingredients: [{ name: 'Sweet Potato', qty: 0.5, unit: '', category: 'Produce' }], recipe: { prepTime: '25 mins (night before)', steps: ['Slice sweet potato into coins', 'Toss with olive oil', 'Roast at 200Â°C for 20 mins', 'Cool and refrigerate'], tip: 'ğŸ’¡ Delicious cold - naturally sweet!' } },
      { id: 'avocado-slices', name: 'Avocado Slices', emoji: 'ğŸ¥‘', allergens: [], ingredients: [{ name: 'Avocado', qty: 0.5, unit: '', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Cut avocado in half', 'Remove pit', 'Slice and squeeze lemon on top'], tip: 'ğŸ’¡ Pack in airtight container with lemon to stop browning!' } },
      { id: 'zucchini-sticks', name: 'Zucchini Sticks', emoji: 'ğŸ¥’', allergens: [], ingredients: [{ name: 'Zucchini', qty: 1, unit: 'small', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Wash zucchini', 'Cut into sticks', 'Pack raw - no cooking needed'], tip: 'ğŸ’¡ Mild flavour - great for dipping!' } },
      { id: 'beetroot-slices', name: 'Baby Beetroot Slices', emoji: 'ğŸŸ£', allergens: [], ingredients: [{ name: 'Baby Beetroot (pre-cooked)', qty: 2, unit: '', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Drain and slice baby beetroot', 'Pack in leak-proof container'], tip: 'ğŸ’¡ Buy pre-cooked from Woolies - no mess!' } },
      { id: 'cauliflower-florets', name: 'Cauliflower Florets', emoji: 'ğŸ¥¬', allergens: [], ingredients: [{ name: 'Cauliflower', qty: 4, unit: 'florets', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Wash cauliflower', 'Cut into small florets', 'Pack raw'], tip: 'ğŸ’¡ Try with a cheese dip!' } },
      { id: 'baby-carrots', name: 'Baby Carrots', emoji: 'ğŸ¥•', allergens: [], ingredients: [{ name: 'Baby Carrots', qty: 6, unit: '', category: 'Produce' }], recipe: { prepTime: '30 secs', steps: ['Rinse and pack - no cutting needed!'], tip: 'ğŸ’¡ Perfect snack size from Woolies!' } },
      { id: 'cucumber-lebanese', name: 'Whole Lebanese Cucumber', emoji: 'ğŸ¥’', allergens: [], ingredients: [{ name: 'Lebanese Cucumber', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '30 secs', steps: ['Wash and pack whole'], tip: 'ğŸ’¡ Smaller and crunchier than regular cukes!' } },
      { id: 'grape-tomatoes', name: 'Grape Tomatoes', emoji: 'ğŸ…', allergens: [], ingredients: [{ name: 'Grape Tomatoes', qty: 8, unit: '', category: 'Produce' }], recipe: { prepTime: '30 secs', steps: ['Rinse and pack'], tip: 'ğŸ’¡ Sweeter and firmer than cherry tomatoes!' } },
      { id: 'capsicum-mini', name: 'Mini Capsicums', emoji: 'ğŸ«‘', allergens: [], ingredients: [{ name: 'Mini Capsicums', qty: 2, unit: '', category: 'Produce' }], recipe: { prepTime: '30 secs', steps: ['Wash and pack whole or halved'], tip: 'ğŸ’¡ Sweet and no seeds to remove!' } },
      { id: 'corn-kernels', name: 'Corn Kernels Cup', emoji: 'ğŸŒ½', allergens: [], ingredients: [{ name: 'Corn Kernels', qty: 0.5, unit: 'cup', category: 'Pantry' }], recipe: { prepTime: '1 min', steps: ['Drain tinned corn', 'Pack in small container'], tip: 'ğŸ’¡ Edgell corn has no added salt option!' } },
      { id: 'peas-frozen', name: 'Frozen Peas (thawed)', emoji: 'ğŸŸ¢', allergens: [], ingredients: [{ name: 'Frozen Peas', qty: 0.5, unit: 'cup', category: 'Frozen' }], recipe: { prepTime: '1 min', steps: ['Thaw frozen peas', 'Pack as finger food'], tip: 'ğŸ’¡ Sweet and fun to eat one by one!' } },
      { id: 'beans-green', name: 'Green Beans', emoji: 'ğŸ«›', allergens: [], ingredients: [{ name: 'Green Beans', qty: 8, unit: '', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Trim ends', 'Pack raw or blanch 1 min'], tip: 'ğŸ’¡ Crunchy and full of nutrients!' } },
      { id: 'asparagus-tips', name: 'Asparagus Tips', emoji: 'ğŸ¥¬', allergens: [], ingredients: [{ name: 'Asparagus', qty: 4, unit: 'spears', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Snap off woody ends', 'Blanch 1-2 mins', 'Cool and pack'], tip: 'ğŸ’¡ Aussie asparagus season Sep-Dec!' } },
      { id: 'mushroom-button', name: 'Baby Button Mushrooms', emoji: 'ğŸ„', allergens: [], ingredients: [{ name: 'Button Mushrooms', qty: 4, unit: '', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Wipe clean with damp cloth', 'Pack whole'], tip: 'ğŸ’¡ Some kids love them raw!' } },
      { id: 'radish-slices', name: 'Radish Slices', emoji: 'ğŸ”´', allergens: [], ingredients: [{ name: 'Radishes', qty: 3, unit: '', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Wash and trim ends', 'Slice into rounds'], tip: 'ğŸ’¡ Peppery crunch - great with dip!' } },
      { id: 'spinach-baby', name: 'Baby Spinach Leaves', emoji: 'ğŸ¥¬', allergens: [], ingredients: [{ name: 'Baby Spinach', qty: 1, unit: 'handful', category: 'Produce' }], recipe: { prepTime: '30 secs', steps: ['Wash and pack'], tip: 'ğŸ’¡ Add to sandwiches or eat as is!' } },
      { id: 'olives-black', name: 'Black Olives', emoji: 'ğŸ«’', allergens: [], ingredients: [{ name: 'Black Olives', qty: 6, unit: '', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Pack pitted olives'], tip: 'ğŸ’¡ Good fats and kids either love or hate them!' } },
      { id: 'pickles-baby', name: 'Baby Pickles', emoji: 'ğŸ¥’', allergens: [], ingredients: [{ name: 'Baby Pickles', qty: 3, unit: '', category: 'Pantry' }], recipe: { prepTime: '30 secs', steps: ['Pack straight from jar'], tip: 'ğŸ’¡ Tangy and crunchy!' } },
      { id: 'veggie-cups-coles', name: 'Veggie Snack Cup', emoji: 'ğŸ¥•', allergens: [], ingredients: [{ name: 'Pre-cut Veggie Cup', qty: 1, unit: '', category: 'Produce' }], recipe: { prepTime: '10 secs', steps: ['Grab from fridge section and go!'], tip: 'ğŸ’¡ Coles & Woolies have ready-to-eat cups!' } },
    ]
  },
  dairy: {
    name: 'Dairy',
    emoji: 'ğŸ§€',
    color: '#FFE66D',
    items: [
      { id: 'cheese-stick', name: 'Cheese Stick', emoji: 'ğŸ§€', allergens: ['dairy'], ingredients: [{ name: 'Cheese Sticks', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Grab from fridge and pack!'], tip: 'ğŸ’¡ Keep in insulated lunch bag with ice pack' } },
      { id: 'cheese-cubes-cheddar', name: 'Cheddar Cheese Cubes', emoji: 'ğŸ§€', allergens: ['dairy'], ingredients: [{ name: 'Cheddar Cheese Block', qty: 30, unit: 'g', category: 'Dairy' }], recipe: { prepTime: '1 min', steps: ['Cut cheese block into bite-sized cubes', 'Pack in small container'], tip: 'ğŸ’¡ Cut a week\'s worth and store in airtight container' } },
      { id: 'cheese-cubes-colby', name: 'Colby Cheese Cubes', emoji: 'ğŸ§€', allergens: ['dairy'], ingredients: [{ name: 'Colby Cheese Block', qty: 30, unit: 'g', category: 'Dairy' }], recipe: { prepTime: '1 min', steps: ['Cut cheese block into bite-sized cubes', 'Pack in small container'], tip: 'ğŸ’¡ Colby is milder - great for fussy eaters!' } },
      { id: 'babybel', name: 'Babybel Cheese', emoji: 'ğŸ§€', allergens: ['dairy'], ingredients: [{ name: 'Babybel Cheese', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Pack whole - the wax wrapper keeps it fresh!'], tip: 'ğŸ’¡ Kids love unwrapping these themselves' } },
      { id: 'yoghurt-strawberry', name: 'Strawberry Yoghurt Pouch', emoji: 'ğŸ¥›', allergens: ['dairy'], ingredients: [{ name: 'Strawberry Yoghurt Pouch', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Grab from fridge and pack!'], tip: 'ğŸ’¡ Freeze overnight - it\'ll be perfect by lunch and keep everything cold!' } },
      { id: 'yoghurt-vanilla', name: 'Vanilla Yoghurt Tub', emoji: 'ğŸ¥›', allergens: ['dairy'], ingredients: [{ name: 'Vanilla Yoghurt Tub', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Pack tub with a small spoon'], tip: 'ğŸ’¡ Add a sprinkle of muesli on top for crunch' } },
      { id: 'yoghurt-greek', name: 'Greek Yoghurt & Honey', emoji: 'ğŸ¥›', allergens: ['dairy'], ingredients: [{ name: 'Greek Yoghurt', qty: 100, unit: 'g', category: 'Dairy' }, { name: 'Honey', qty: 1, unit: 'tsp', category: 'Pantry' }], recipe: { prepTime: '1 min', steps: ['Spoon yoghurt into container', 'Drizzle honey on top', 'Pack a spoon'], tip: 'ğŸ’¡ Put honey in separate tiny container to prevent sogginess' } },
      { id: 'yoghurt-berry', name: 'Mixed Berry Yoghurt', emoji: 'ğŸ¥›', allergens: ['dairy'], ingredients: [{ name: 'Mixed Berry Yoghurt', qty: 1, unit: 'tub', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Pack tub with a small spoon'], tip: 'ğŸ’¡ Check the sugar content - some kids\' yoghurts are very sweet!' } },
      { id: 'milk-box', name: 'Milk Box', emoji: 'ğŸ¥›', allergens: ['dairy'], ingredients: [{ name: 'UHT Milk Box', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Pack straight from pantry - no refrigeration needed until opened!'], tip: 'ğŸ’¡ UHT boxes are shelf-stable - perfect for lunchboxes' } },
      { id: 'cheese-crackers', name: 'Cheese & Crackers', emoji: 'ğŸ§€', allergens: ['dairy', 'gluten'], ingredients: [{ name: 'Cheddar Cheese', qty: 30, unit: 'g', category: 'Dairy' }, { name: 'Wholegrain Crackers', qty: 4, unit: '', category: 'Pantry' }], recipe: { prepTime: '2 mins', steps: ['Slice cheese to fit crackers', 'Pack cheese and crackers separately', 'Kids assemble at lunchtime!'], tip: 'ğŸ’¡ Keeps crackers crisp - no soggy biscuits!' } },
      { id: 'cream-cheese-celery', name: 'Cream Cheese Stuffed Celery', emoji: 'ğŸ¥¬', allergens: ['dairy'], ingredients: [{ name: 'Cream Cheese', qty: 2, unit: 'tbsp', category: 'Dairy' }, { name: 'Celery', qty: 2, unit: 'stalks', category: 'Produce' }], recipe: { prepTime: '3 mins', steps: ['Wash and cut celery into sticks', 'Spread cream cheese in the groove', 'Pack flat so cheese doesn\'t smoosh'], tip: 'ğŸ’¡ Mix in a little grated carrot for colour!' } },
      { id: 'custard-pouch', name: 'Custard Pouch', emoji: 'ğŸ®', allergens: ['dairy', 'eggs'], ingredients: [{ name: 'Custard Pouch', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Grab from fridge and pack!'], tip: 'ğŸ’¡ A yummy calcium boost disguised as a treat!' } },
      { id: 'cheese-string', name: 'Cheese Stringers', emoji: 'ğŸ§€', allergens: ['dairy'], ingredients: [{ name: 'Cheese Stringers', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Peel and eat!'], tip: 'ğŸ’¡ Bega Stringers are fun to peel!' } },
      { id: 'cheese-slice', name: 'Cheese Slice', emoji: 'ğŸ§€', allergens: ['dairy'], ingredients: [{ name: 'Cheese Slice', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Pack individually wrapped slice'], tip: 'ğŸ’¡ Kraft Singles stay fresh!' } },
      { id: 'cheese-laughing-cow', name: 'Laughing Cow Cheese', emoji: 'ğŸ§€', allergens: ['dairy'], ingredients: [{ name: 'Laughing Cow Triangle', qty: 2, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Pack triangles for spreading'], tip: 'ğŸ’¡ Creamy and spreadable!' } },
      { id: 'cheese-tasty', name: 'Tasty Cheese Cubes', emoji: 'ğŸ§€', allergens: ['dairy'], ingredients: [{ name: 'Tasty Cheese', qty: 30, unit: 'g', category: 'Dairy' }], recipe: { prepTime: '1 min', steps: ['Cut into cubes'], tip: 'ğŸ’¡ Bega Tasty is an Aussie classic!' } },
      { id: 'yoghurt-yoplait', name: 'Yoplait Petit Miam', emoji: 'ğŸ¥›', allergens: ['dairy'], ingredients: [{ name: 'Petit Miam', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Pack the tube - squeezy and fun!'], tip: 'ğŸ’¡ No spoon needed!' } },
      { id: 'yoghurt-chobani', name: 'Chobani Flip', emoji: 'ğŸ¥›', allergens: ['dairy'], ingredients: [{ name: 'Chobani Flip', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Pack with mix-ins attached!'], tip: 'ğŸ’¡ Flip the toppings in at lunchtime!' } },
      { id: 'dairy-farmers-thick', name: 'Farmers Union Thick & Creamy', emoji: 'ğŸ¥›', allergens: ['dairy'], ingredients: [{ name: 'Thick & Creamy Yoghurt', qty: 1, unit: 'tub', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Pack with spoon'], tip: 'ğŸ’¡ SA favourite - super thick!' } },
      { id: 'fromage-frais', name: 'Fruche Fromage Frais', emoji: 'ğŸ¨', allergens: ['dairy'], ingredients: [{ name: 'Fruche', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Pack tub with spoon'], tip: 'ğŸ’¡ Creamy mousse texture!' } },
      { id: 'cottage-cheese', name: 'Cottage Cheese Tub', emoji: 'ğŸ¥›', allergens: ['dairy'], ingredients: [{ name: 'Cottage Cheese', qty: 100, unit: 'g', category: 'Dairy' }], recipe: { prepTime: '30 secs', steps: ['Portion into small container'], tip: 'ğŸ’¡ High protein snack!' } },
      { id: 'kefir-drink', name: 'Kefir Drink', emoji: 'ğŸ¥›', allergens: ['dairy'], ingredients: [{ name: 'Kefir', qty: 150, unit: 'ml', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Pour into drink bottle'], tip: 'ğŸ’¡ Probiotics for gut health!' } },
    ]
  },
  protein: {
    name: 'Protein',
    emoji: 'ğŸ—',
    color: '#C490D1',
    items: [
      { id: 'chicken-drumstick', name: 'Cold Chicken Drumstick', emoji: 'ğŸ—', allergens: [], ingredients: [{ name: 'Chicken Drumsticks', qty: 1, unit: '', category: 'Meat' }], recipe: { prepTime: '30 mins (night before)', steps: ['Season drumsticks with salt, pepper, garlic powder', 'Bake at 200Â°C for 25-30 mins until cooked through', 'Cool completely and refrigerate', 'Pack cold next day'], tip: 'ğŸ’¡ Batch cook 8-10 on Sunday for the whole week!' } },
      { id: 'chicken-pieces', name: 'Sliced Chicken Breast', emoji: 'ğŸ—', allergens: [], ingredients: [{ name: 'Chicken Breast', qty: 50, unit: 'g', category: 'Meat' }], recipe: { prepTime: '20 mins (night before)', steps: ['Poach chicken breast in simmering water for 15 mins', 'Let cool in liquid', 'Slice and refrigerate', 'Pack cold pieces'], tip: 'ğŸ’¡ Use leftover roast chicken - even easier!' } },
      { id: 'boiled-egg', name: 'Boiled Egg', emoji: 'ğŸ¥š', allergens: ['eggs'], ingredients: [{ name: 'Eggs', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '15 mins (night before)', steps: ['Place eggs in cold water, bring to boil', 'Boil for 10 mins for hard-boiled', 'Cool in ice water', 'Peel or pack unpeeled'], tip: 'ğŸ’¡ Unpeeled eggs last longer - kids can peel themselves!' } },
      { id: 'boiled-egg-halves', name: 'Deviled Egg Halves', emoji: 'ğŸ¥š', allergens: ['eggs'], ingredients: [{ name: 'Eggs', qty: 1, unit: '', category: 'Dairy' }, { name: 'Mayonnaise', qty: 1, unit: 'tsp', category: 'Pantry' }, { name: 'Paprika', qty: 1, unit: 'pinch', category: 'Pantry' }], recipe: { prepTime: '5 mins', steps: ['Hard boil egg and cool', 'Cut in half, remove yolk', 'Mash yolk with mayo', 'Spoon back into whites, sprinkle paprika'], tip: 'ğŸ’¡ Make filling smoother by pushing through a sieve' } },
      { id: 'tuna-plain', name: 'Tuna Chunks', emoji: 'ğŸŸ', allergens: ['fish'], ingredients: [{ name: 'Tuna in Springwater (small can)', qty: 1, unit: '', category: 'Pantry' }], recipe: { prepTime: '1 min', steps: ['Open can and drain well', 'Pack in small leak-proof container'], tip: 'ğŸ’¡ Springwater tuna is healthier than oil or brine' } },
      { id: 'salmon-pieces', name: 'Salmon Pieces', emoji: 'ğŸŸ', allergens: ['fish'], ingredients: [{ name: 'Salmon Fillet', qty: 50, unit: 'g', category: 'Seafood' }], recipe: { prepTime: '15 mins (night before)', steps: ['Bake salmon at 180Â°C for 12 mins', 'Cool and flake into pieces', 'Refrigerate overnight', 'Pack cold'], tip: 'ğŸ’¡ Canned salmon works great too and needs no cooking!' } },
      { id: 'hummus-dip', name: 'Hummus Dip', emoji: 'ğŸ«˜', allergens: ['sesame'], ingredients: [{ name: 'Hummus', qty: 3, unit: 'tbsp', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Spoon hummus into small container', 'Pack with veggie sticks or crackers for dipping'], tip: 'ğŸ’¡ Buy snack-sized hummus tubs for zero mess!' } },
      { id: 'ham-slices', name: 'Sliced Ham', emoji: 'ğŸ¥“', allergens: [], ingredients: [{ name: 'Sliced Ham', qty: 2, unit: 'slices', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Roll up ham slices', 'Pack in container or wrap'], tip: 'ğŸ’¡ Roll with cheese inside for a protein-packed snack!' } },
      { id: 'turkey-slices', name: 'Sliced Turkey', emoji: 'ğŸ¦ƒ', allergens: [], ingredients: [{ name: 'Sliced Turkey', qty: 2, unit: 'slices', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Roll up turkey slices', 'Pack in container'], tip: 'ğŸ’¡ Lower fat than ham - great lean protein!' } },
      { id: 'salami-slices', name: 'Salami Slices', emoji: 'ğŸ–', allergens: [], ingredients: [{ name: 'Salami', qty: 4, unit: 'slices', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Pack slices flat or fold into quarters'], tip: 'ğŸ’¡ A little goes a long way - strong flavour!' } },
      { id: 'falafel-balls', name: 'Falafel Balls', emoji: 'ğŸ§†', allergens: ['sesame', 'gluten'], ingredients: [{ name: 'Falafel (pre-made)', qty: 3, unit: '', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Pack pre-made falafel from deli section', 'Great cold or at room temperature'], tip: 'ğŸ’¡ Delicious with hummus for dipping!' } },
      { id: 'peanut-butter', name: 'Peanut Butter (for dipping)', emoji: 'ğŸ¥œ', allergens: ['peanuts'], ingredients: [{ name: 'Peanut Butter', qty: 2, unit: 'tbsp', category: 'Pantry' }], recipe: { prepTime: '30 secs', steps: ['Spoon peanut butter into small container', 'Pack with apple slices or celery for dipping'], tip: 'ğŸ’¡ Check school\'s nut policy first!' } },
      { id: 'almond-butter', name: 'Almond Butter (for dipping)', emoji: 'ğŸ¥œ', allergens: ['nuts'], ingredients: [{ name: 'Almond Butter', qty: 2, unit: 'tbsp', category: 'Pantry' }], recipe: { prepTime: '30 secs', steps: ['Spoon almond butter into small container', 'Pack with fruit or crackers'], tip: 'ğŸ’¡ Slightly sweeter than peanut butter - kids love it!' } },
      { id: 'baked-beans', name: 'Baked Beans (small container)', emoji: 'ğŸ«˜', allergens: [], ingredients: [{ name: 'Baked Beans (small can)', qty: 1, unit: '', category: 'Pantry' }], recipe: { prepTime: '1 min', steps: ['Open can', 'Transfer to leak-proof container', 'Pack a spoon'], tip: 'ğŸ’¡ Great source of fibre and protein!' } },
      { id: 'tofu-cubes', name: 'Marinated Tofu Cubes', emoji: 'ğŸ§ˆ', allergens: ['soy'], ingredients: [{ name: 'Firm Tofu', qty: 50, unit: 'g', category: 'Produce' }, { name: 'Soy Sauce', qty: 1, unit: 'tsp', category: 'Pantry' }], recipe: { prepTime: '10 mins (night before)', steps: ['Press tofu to remove water', 'Cut into cubes', 'Toss with soy sauce', 'Marinate overnight in fridge'], tip: 'ğŸ’¡ Pan-fry for 5 mins if you want them crispier!' } },
      { id: 'cocktail-franks', name: 'Cocktail Frankfurts', emoji: 'ğŸŒ­', allergens: ['gluten'], ingredients: [{ name: 'Cocktail Frankfurts', qty: 3, unit: '', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Pack straight from the packet - already cooked!'], tip: 'ğŸ’¡ An occasional treat - not for every day!' } },
      { id: 'chicken-schnitzel', name: 'Mini Chicken Schnitzel', emoji: 'ğŸ—', allergens: ['gluten', 'eggs'], ingredients: [{ name: 'Chicken Schnitzel (mini)', qty: 1, unit: '', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Pack cold from deli section', 'Great with tomato sauce!'], tip: 'ğŸ’¡ Woolies deli has ready-made schnitzels!' } },
      { id: 'meatballs', name: 'Cold Meatballs', emoji: 'ğŸ§†', allergens: ['gluten', 'eggs'], ingredients: [{ name: 'Beef Meatballs', qty: 3, unit: '', category: 'Meat' }], recipe: { prepTime: '20 mins (night before)', steps: ['Cook meatballs until done', 'Cool completely', 'Refrigerate overnight', 'Pack cold'], tip: 'ğŸ’¡ Batch cook and freeze - grab a few each morning!' } },
      { id: 'sausage-roll', name: 'Mini Sausage Roll', emoji: 'ğŸ¥', allergens: ['gluten'], ingredients: [{ name: 'Mini Sausage Rolls', qty: 2, unit: '', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Pack cold sausage rolls', 'Great at room temperature'], tip: 'ğŸ’¡ Party size from Woolies works perfectly!' } },
      { id: 'quiche-slice', name: 'Mini Quiche', emoji: 'ğŸ¥§', allergens: ['gluten', 'eggs', 'dairy'], ingredients: [{ name: 'Mini Quiche', qty: 1, unit: '', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Pack a mini quiche from deli', 'Delicious cold!'], tip: 'ğŸ’¡ Make mini quiches in muffin tins on weekends!' } },
      { id: 'lamb-kofta', name: 'Lamb Kofta', emoji: 'ğŸ¢', allergens: [], ingredients: [{ name: 'Lamb Mince', qty: 50, unit: 'g', category: 'Meat' }], recipe: { prepTime: '20 mins (night before)', steps: ['Mix lamb mince with cumin and coriander', 'Shape into small sausages', 'Grill or pan-fry until cooked', 'Cool and refrigerate'], tip: 'ğŸ’¡ Delicious with hummus!' } },
      { id: 'prawn-cold', name: 'Cold Prawns', emoji: 'ğŸ¦', allergens: ['shellfish'], ingredients: [{ name: 'Cooked Prawns', qty: 5, unit: '', category: 'Seafood' }], recipe: { prepTime: '1 min', steps: ['Buy pre-cooked prawns', 'Pack with ice pack'], tip: 'ğŸ’¡ Aussie favourite - keep very cold!' } },
      { id: 'fish-fingers', name: 'Cold Fish Fingers', emoji: 'ğŸŸ', allergens: ['fish', 'gluten'], ingredients: [{ name: 'Fish Fingers', qty: 2, unit: '', category: 'Frozen' }], recipe: { prepTime: '15 mins (night before)', steps: ['Bake fish fingers as per packet', 'Cool completely', 'Refrigerate', 'Pack cold'], tip: 'ğŸ’¡ Birds Eye ones are popular with kids!' } },
      { id: 'dim-sim', name: 'Steamed Dim Sim', emoji: 'ğŸ¥Ÿ', allergens: ['gluten', 'soy'], ingredients: [{ name: 'Dim Sims', qty: 2, unit: '', category: 'Frozen' }], recipe: { prepTime: '10 mins (night before)', steps: ['Steam or microwave dim sims', 'Cool completely', 'Pack cold'], tip: 'ğŸ’¡ Aussie classic! South Melbourne Market ones are the best!' } },
      { id: 'spring-roll', name: 'Mini Spring Roll', emoji: 'ğŸ¥¢', allergens: ['gluten', 'soy'], ingredients: [{ name: 'Mini Spring Rolls', qty: 2, unit: '', category: 'Frozen' }], recipe: { prepTime: '15 mins (night before)', steps: ['Bake spring rolls', 'Cool completely', 'Pack cold with sweet chilli dip'], tip: 'ğŸ’¡ Coles and Woolies have good frozen ones!' } },
      { id: 'meat-pie-mini', name: 'Mini Meat Pie', emoji: 'ğŸ¥§', allergens: ['gluten'], ingredients: [{ name: 'Mini Meat Pies', qty: 1, unit: '', category: 'Frozen' }], recipe: { prepTime: '20 mins', steps: ['Bake mini pie until golden', 'Cool before packing'], tip: 'ğŸ’¡ Four N Twenty party pies are an Aussie icon!' } },
      { id: 'roast-beef-slices', name: 'Roast Beef Slices', emoji: 'ğŸ¥©', allergens: [], ingredients: [{ name: 'Roast Beef Slices', qty: 2, unit: 'slices', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Roll up roast beef slices', 'Pack in container'], tip: 'ğŸ’¡ Use leftover Sunday roast!' } },
      { id: 'teriyaki-chicken', name: 'Teriyaki Chicken Pieces', emoji: 'ğŸ—', allergens: ['soy', 'gluten'], ingredients: [{ name: 'Chicken Breast', qty: 50, unit: 'g', category: 'Meat' }, { name: 'Teriyaki Sauce', qty: 1, unit: 'tbsp', category: 'Pantry' }], recipe: { prepTime: '20 mins (night before)', steps: ['Cut chicken into pieces', 'Cook in pan with teriyaki', 'Cool and refrigerate'], tip: 'ğŸ’¡ Sweet and sticky - kids love it!' } },
      { id: 'chicken-tenders', name: 'Chicken Tenders', emoji: 'ğŸ—', allergens: ['gluten'], ingredients: [{ name: 'Chicken Tenders', qty: 2, unit: '', category: 'Frozen' }], recipe: { prepTime: '15 mins', steps: ['Bake until golden', 'Cool and pack'], tip: 'ğŸ’¡ Steggles tenders are popular!' } },
      { id: 'chicken-nuggets', name: 'Chicken Nuggets', emoji: 'ğŸ—', allergens: ['gluten'], ingredients: [{ name: 'Chicken Nuggets', qty: 4, unit: '', category: 'Frozen' }], recipe: { prepTime: '15 mins', steps: ['Bake until crispy', 'Cool completely', 'Pack cold'], tip: 'ğŸ’¡ Kids love these cold too!' } },
      { id: 'devon-slices', name: 'Devon Slices', emoji: 'ğŸ–', allergens: [], ingredients: [{ name: 'Devon', qty: 2, unit: 'slices', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Roll up or pack flat'], tip: 'ğŸ’¡ Aussie deli classic!' } },
      { id: 'strasburg', name: 'Strasburg Slices', emoji: 'ğŸ–', allergens: [], ingredients: [{ name: 'Strasburg', qty: 2, unit: 'slices', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Roll up slices'], tip: 'ğŸ’¡ Mild flavour kids love!' } },
      { id: 'kabana', name: 'Kabana Slices', emoji: 'ğŸŒ­', allergens: [], ingredients: [{ name: 'Kabana', qty: 4, unit: 'slices', category: 'Deli' }], recipe: { prepTime: '1 min', steps: ['Slice into rounds', 'Pack in container'], tip: 'ğŸ’¡ Smoky and delicious!' } },
      { id: 'twiggy-sticks', name: 'Twiggy Sticks', emoji: 'ğŸŒ­', allergens: [], ingredients: [{ name: 'Twiggy Sticks', qty: 2, unit: '', category: 'Deli' }], recipe: { prepTime: '10 secs', steps: ['Pack whole from packet'], tip: 'ğŸ’¡ Don Twiggy Sticks are a lunchbox staple!' } },
      { id: 'leg-ham', name: 'Leg Ham Slices', emoji: 'ğŸ¥“', allergens: [], ingredients: [{ name: 'Leg Ham', qty: 2, unit: 'slices', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Roll or fold slices'], tip: 'ğŸ’¡ Bertocchi ham is great quality!' } },
      { id: 'chicken-loaf', name: 'Chicken Loaf Slices', emoji: 'ğŸ—', allergens: [], ingredients: [{ name: 'Chicken Loaf', qty: 2, unit: 'slices', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Roll up slices'], tip: 'ğŸ’¡ Lighter than ham!' } },
      { id: 'tuna-snack-kit', name: 'Tuna Snack Kit', emoji: 'ğŸŸ', allergens: ['fish', 'gluten'], ingredients: [{ name: 'Tuna Snack Kit', qty: 1, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack the kit - crackers included!'], tip: 'ğŸ’¡ John West kits are convenient!' } },
      { id: 'salmon-pouch', name: 'Salmon Pouch', emoji: 'ğŸŸ', allergens: ['fish'], ingredients: [{ name: 'Salmon Pouch', qty: 1, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack pouch with crackers'], tip: 'ğŸ’¡ Tassal pouches have no draining!' } },
      { id: 'kransky', name: 'Kransky Sausage', emoji: 'ğŸŒ­', allergens: ['gluten'], ingredients: [{ name: 'Kransky', qty: 1, unit: '', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Slice and pack cold'], tip: 'ğŸ’¡ Smoky European-style sausage!' } },
      { id: 'pepperoni', name: 'Pepperoni Slices', emoji: 'ğŸ•', allergens: [], ingredients: [{ name: 'Pepperoni', qty: 6, unit: 'slices', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Pack slices flat'], tip: 'ğŸ’¡ Great with cheese and crackers!' } },
      { id: 'prosciutto', name: 'Prosciutto Slices', emoji: 'ğŸ¥“', allergens: [], ingredients: [{ name: 'Prosciutto', qty: 2, unit: 'slices', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Fold or roll slices'], tip: 'ğŸ’¡ Fancy but kids love it!' } },
      { id: 'pork-bun', name: 'BBQ Pork Bun', emoji: 'ğŸ¥Ÿ', allergens: ['gluten'], ingredients: [{ name: 'BBQ Pork Bun', qty: 1, unit: '', category: 'Frozen' }], recipe: { prepTime: '3 mins', steps: ['Steam or microwave', 'Cool and pack'], tip: 'ğŸ’¡ Woolies frozen section!' } },
    ]
  },
  grains: {
    name: 'Grains',
    emoji: 'ğŸ',
    color: '#F4A261',
    items: [
      // Sandwiches
      { id: 'sandwich-ham-cheese', name: 'Ham & Cheese Sandwich', emoji: 'ğŸ¥ª', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Wholegrain Bread', qty: 2, unit: 'slices', category: 'Bakery' }, { name: 'Sliced Ham', qty: 2, unit: 'slices', category: 'Deli' }, { name: 'Cheese Slices', qty: 1, unit: 'slice', category: 'Dairy' }, { name: 'Butter', qty: 1, unit: 'tsp', category: 'Dairy' }], recipe: { prepTime: '2 mins', steps: ['Butter both slices of bread', 'Layer ham and cheese on one slice', 'Top with second slice', 'Cut in half or quarters'], tip: 'ğŸ’¡ Toast the bread first for a crunchier sandwich!' } },
      { id: 'sandwich-vegemite', name: 'Vegemite Sandwich', emoji: 'ğŸ¥ª', allergens: ['gluten'], ingredients: [{ name: 'Wholegrain Bread', qty: 2, unit: 'slices', category: 'Bakery' }, { name: 'Vegemite', qty: 1, unit: 'tsp', category: 'Pantry' }, { name: 'Butter', qty: 1, unit: 'tsp', category: 'Dairy' }], recipe: { prepTime: '1 min', steps: ['Butter both slices of bread', 'Spread thin layer of Vegemite on one slice', 'Close sandwich and cut'], tip: 'ğŸ’¡ Less is more with Vegemite - spread thinly!' } },
      { id: 'sandwich-chicken-mayo', name: 'Chicken & Mayo Sandwich', emoji: 'ğŸ¥ª', allergens: ['gluten', 'eggs'], ingredients: [{ name: 'Wholegrain Bread', qty: 2, unit: 'slices', category: 'Bakery' }, { name: 'Chicken Breast', qty: 50, unit: 'g', category: 'Meat' }, { name: 'Mayonnaise', qty: 1, unit: 'tbsp', category: 'Pantry' }, { name: 'Lettuce', qty: 1, unit: 'leaf', category: 'Produce' }], recipe: { prepTime: '3 mins', steps: ['Shred or slice cooked chicken', 'Mix chicken with mayo', 'Spread on bread, add lettuce leaf', 'Close and cut'], tip: 'ğŸ’¡ Use leftover roast chicken for super quick prep!' } },
      { id: 'sandwich-egg-lettuce', name: 'Egg & Lettuce Sandwich', emoji: 'ğŸ¥ª', allergens: ['gluten', 'eggs'], ingredients: [{ name: 'Wholegrain Bread', qty: 2, unit: 'slices', category: 'Bakery' }, { name: 'Eggs', qty: 1, unit: '', category: 'Dairy' }, { name: 'Mayonnaise', qty: 1, unit: 'tbsp', category: 'Pantry' }, { name: 'Lettuce', qty: 1, unit: 'leaf', category: 'Produce' }], recipe: { prepTime: '5 mins', steps: ['Hard boil egg, cool and peel', 'Mash egg with mayo, salt and pepper', 'Spread on bread, add lettuce', 'Close and cut'], tip: 'ğŸ’¡ Make egg mixture the night before to save time!' } },
      { id: 'sandwich-tuna', name: 'Tuna Sandwich', emoji: 'ğŸ¥ª', allergens: ['gluten', 'fish', 'eggs'], ingredients: [{ name: 'Wholegrain Bread', qty: 2, unit: 'slices', category: 'Bakery' }, { name: 'Tuna in Springwater (small can)', qty: 0.5, unit: '', category: 'Pantry' }, { name: 'Mayonnaise', qty: 1, unit: 'tbsp', category: 'Pantry' }, { name: 'Lettuce', qty: 1, unit: 'leaf', category: 'Produce' }], recipe: { prepTime: '3 mins', steps: ['Drain tuna well', 'Mix with mayo', 'Spread on bread, add lettuce', 'Close and cut'], tip: 'ğŸ’¡ Add finely diced celery for extra crunch!' } },
      { id: 'sandwich-peanut-butter', name: 'Peanut Butter Sandwich', emoji: 'ğŸ¥ª', allergens: ['gluten', 'peanuts'], ingredients: [{ name: 'Wholegrain Bread', qty: 2, unit: 'slices', category: 'Bakery' }, { name: 'Peanut Butter', qty: 2, unit: 'tbsp', category: 'Pantry' }], recipe: { prepTime: '1 min', steps: ['Spread peanut butter on one slice', 'Top with second slice', 'Cut and pack'], tip: 'ğŸ’¡ Check school nut policy - use sun butter if needed!' } },
      { id: 'sandwich-cream-cheese-cucumber', name: 'Cream Cheese & Cucumber Sandwich', emoji: 'ğŸ¥ª', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Wholegrain Bread', qty: 2, unit: 'slices', category: 'Bakery' }, { name: 'Cream Cheese', qty: 2, unit: 'tbsp', category: 'Dairy' }, { name: 'Lebanese Cucumber', qty: 0.5, unit: '', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Spread cream cheese on both slices', 'Slice cucumber thinly', 'Layer cucumber on one slice', 'Close and cut'], tip: 'ğŸ’¡ Pat cucumber dry to prevent soggy sandwich!' } },
      { id: 'sandwich-salad', name: 'Salad Sandwich', emoji: 'ğŸ¥ª', allergens: ['gluten'], ingredients: [{ name: 'Wholegrain Bread', qty: 2, unit: 'slices', category: 'Bakery' }, { name: 'Lettuce', qty: 2, unit: 'leaves', category: 'Produce' }, { name: 'Tomato', qty: 2, unit: 'slices', category: 'Produce' }, { name: 'Cucumber', qty: 4, unit: 'slices', category: 'Produce' }, { name: 'Carrot (grated)', qty: 1, unit: 'tbsp', category: 'Produce' }], recipe: { prepTime: '3 mins', steps: ['Butter bread lightly', 'Layer lettuce, tomato, cucumber', 'Add grated carrot', 'Close and cut'], tip: 'ğŸ’¡ Put lettuce against the bread to stop it getting soggy!' } },
      // Wraps
      { id: 'wrap-chicken-caesar', name: 'Chicken Caesar Wrap', emoji: 'ğŸŒ¯', allergens: ['gluten', 'dairy', 'eggs'], ingredients: [{ name: 'Wholemeal Wrap', qty: 1, unit: '', category: 'Bakery' }, { name: 'Chicken Breast', qty: 50, unit: 'g', category: 'Meat' }, { name: 'Cos Lettuce', qty: 2, unit: 'leaves', category: 'Produce' }, { name: 'Parmesan Cheese', qty: 1, unit: 'tbsp', category: 'Dairy' }, { name: 'Caesar Dressing', qty: 1, unit: 'tbsp', category: 'Pantry' }], recipe: { prepTime: '4 mins', steps: ['Lay wrap flat', 'Spread dressing down centre', 'Add sliced chicken, lettuce, parmesan', 'Fold bottom up, then roll sides in tight'], tip: 'ğŸ’¡ Don\'t overfill or it won\'t hold together!' } },
      { id: 'wrap-ham-salad', name: 'Ham & Salad Wrap', emoji: 'ğŸŒ¯', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Wholemeal Wrap', qty: 1, unit: '', category: 'Bakery' }, { name: 'Sliced Ham', qty: 2, unit: 'slices', category: 'Deli' }, { name: 'Cheese Slices', qty: 1, unit: '', category: 'Dairy' }, { name: 'Lettuce', qty: 1, unit: 'leaf', category: 'Produce' }, { name: 'Tomato', qty: 2, unit: 'slices', category: 'Produce' }], recipe: { prepTime: '3 mins', steps: ['Lay wrap flat', 'Layer cheese, ham, lettuce, tomato down centre', 'Fold bottom up, roll from side', 'Cut in half diagonally'], tip: 'ğŸ’¡ Wrap in foil to hold shape until lunchtime!' } },
      { id: 'wrap-veggie-hummus', name: 'Veggie & Hummus Wrap', emoji: 'ğŸŒ¯', allergens: ['gluten', 'sesame'], ingredients: [{ name: 'Wholemeal Wrap', qty: 1, unit: '', category: 'Bakery' }, { name: 'Hummus', qty: 2, unit: 'tbsp', category: 'Deli' }, { name: 'Carrot (grated)', qty: 2, unit: 'tbsp', category: 'Produce' }, { name: 'Cucumber', qty: 4, unit: 'slices', category: 'Produce' }, { name: 'Capsicum', qty: 4, unit: 'strips', category: 'Produce' }], recipe: { prepTime: '3 mins', steps: ['Spread hummus over wrap', 'Add grated carrot, cucumber, capsicum', 'Roll up tightly', 'Cut in half'], tip: 'ğŸ’¡ Hummus acts as the glue - spread edge to edge!' } },
      { id: 'wrap-turkey-avocado', name: 'Turkey & Avocado Wrap', emoji: 'ğŸŒ¯', allergens: ['gluten'], ingredients: [{ name: 'Wholemeal Wrap', qty: 1, unit: '', category: 'Bakery' }, { name: 'Sliced Turkey', qty: 2, unit: 'slices', category: 'Deli' }, { name: 'Avocado', qty: 0.25, unit: '', category: 'Produce' }, { name: 'Lettuce', qty: 1, unit: 'leaf', category: 'Produce' }], recipe: { prepTime: '3 mins', steps: ['Mash avocado and spread on wrap', 'Layer turkey and lettuce', 'Roll tightly and cut'], tip: 'ğŸ’¡ Squeeze lemon on avocado to stop browning!' } },
      // Other grains
      { id: 'crackers-plain', name: 'Wholegrain Crackers', emoji: 'ğŸ˜', allergens: ['gluten'], ingredients: [{ name: 'Wholegrain Crackers', qty: 6, unit: '', category: 'Pantry' }], recipe: { prepTime: '30 secs', steps: ['Count out crackers and pack', 'Pair with cheese or hummus from other containers'], tip: 'ğŸ’¡ Vita-Weat or Salada are great wholegrain options!' } },
      { id: 'rice-crackers', name: 'Rice Crackers', emoji: 'ğŸ˜', allergens: [], ingredients: [{ name: 'Rice Crackers', qty: 8, unit: '', category: 'Pantry' }], recipe: { prepTime: '30 secs', steps: ['Pack rice crackers in container', 'Great for dipping!'], tip: 'ğŸ’¡ Gluten-free option for kids with coeliac!' } },
      { id: 'pasta-salad-pesto', name: 'Pesto Pasta Salad', emoji: 'ğŸ', allergens: ['gluten', 'dairy', 'nuts'], ingredients: [{ name: 'Wholemeal Pasta', qty: 0.5, unit: 'cup cooked', category: 'Pantry' }, { name: 'Basil Pesto', qty: 1, unit: 'tbsp', category: 'Pantry' }, { name: 'Cherry Tomatoes', qty: 4, unit: '', category: 'Produce' }, { name: 'Parmesan Cheese', qty: 1, unit: 'tbsp', category: 'Dairy' }], recipe: { prepTime: '15 mins (night before)', steps: ['Cook pasta, drain and cool', 'Toss with pesto', 'Halve cherry tomatoes and add', 'Sprinkle with parmesan', 'Refrigerate overnight'], tip: 'ğŸ’¡ Make a big batch - keeps 4 days in fridge!' } },
      { id: 'pasta-salad-tuna', name: 'Tuna Pasta Salad', emoji: 'ğŸ', allergens: ['gluten', 'fish', 'eggs'], ingredients: [{ name: 'Wholemeal Pasta', qty: 0.5, unit: 'cup cooked', category: 'Pantry' }, { name: 'Tuna in Springwater (small can)', qty: 0.5, unit: '', category: 'Pantry' }, { name: 'Mayonnaise', qty: 1, unit: 'tbsp', category: 'Pantry' }, { name: 'Corn Kernels', qty: 2, unit: 'tbsp', category: 'Pantry' }], recipe: { prepTime: '15 mins (night before)', steps: ['Cook pasta, drain and cool', 'Drain tuna and flake', 'Mix pasta, tuna, corn and mayo', 'Season and refrigerate'], tip: 'ğŸ’¡ Add peas for extra veggies!' } },
      { id: 'rice-balls', name: 'Rice Balls (Onigiri)', emoji: 'ğŸ™', allergens: [], ingredients: [{ name: 'Sushi Rice', qty: 0.5, unit: 'cup cooked', category: 'Pantry' }, { name: 'Nori Sheets', qty: 0.5, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 mins', steps: ['Cook sushi rice and let cool slightly', 'Wet hands to prevent sticking', 'Shape into balls or triangles', 'Wrap with nori strip'], tip: 'ğŸ’¡ Add a little filling like tuna mayo in the centre!' } },
      { id: 'fried-rice', name: 'Fried Rice', emoji: 'ğŸš', allergens: ['soy', 'eggs'], ingredients: [{ name: 'Cooked Rice', qty: 0.5, unit: 'cup', category: 'Pantry' }, { name: 'Eggs', qty: 0.5, unit: '', category: 'Dairy' }, { name: 'Frozen Peas & Corn', qty: 2, unit: 'tbsp', category: 'Frozen' }, { name: 'Soy Sauce', qty: 1, unit: 'tsp', category: 'Pantry' }], recipe: { prepTime: '10 mins (night before)', steps: ['Heat oil in pan, scramble egg', 'Add cold rice and frozen veg', 'Stir-fry 3-4 mins', 'Add soy sauce, cool and pack'], tip: 'ğŸ’¡ Day-old rice works best - less sticky!' } },
      { id: 'pita-pocket-falafel', name: 'Falafel Pita Pocket', emoji: 'ğŸ¥™', allergens: ['gluten', 'sesame'], ingredients: [{ name: 'Wholemeal Pita Bread', qty: 1, unit: '', category: 'Bakery' }, { name: 'Falafel (pre-made)', qty: 2, unit: '', category: 'Deli' }, { name: 'Hummus', qty: 1, unit: 'tbsp', category: 'Deli' }, { name: 'Lettuce', qty: 1, unit: 'leaf', category: 'Produce' }, { name: 'Tomato', qty: 2, unit: 'slices', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Cut pita in half to open pocket', 'Spread hummus inside', 'Add falafel, lettuce, tomato'], tip: 'ğŸ’¡ Warm the pita for 10 secs in microwave to soften!' } },
      { id: 'pita-pocket-chicken', name: 'Chicken Pita Pocket', emoji: 'ğŸ¥™', allergens: ['gluten'], ingredients: [{ name: 'Wholemeal Pita Bread', qty: 1, unit: '', category: 'Bakery' }, { name: 'Chicken Breast', qty: 50, unit: 'g', category: 'Meat' }, { name: 'Lettuce', qty: 1, unit: 'leaf', category: 'Produce' }, { name: 'Tomato', qty: 2, unit: 'slices', category: 'Produce' }], recipe: { prepTime: '2 mins', steps: ['Cut pita in half to open pocket', 'Add sliced chicken, lettuce, tomato'], tip: 'ğŸ’¡ Add Greek yoghurt or mayo for moisture!' } },
      { id: 'muffin-banana', name: 'Banana Muffin', emoji: 'ğŸ§', allergens: ['gluten', 'eggs', 'dairy'], ingredients: [{ name: 'Banana Muffin (homemade/bought)', qty: 1, unit: '', category: 'Bakery' }], recipe: { prepTime: '30 secs', steps: ['Pack a homemade or store-bought muffin'], tip: 'ğŸ’¡ Batch bake on weekends and freeze - grab and go!' } },
      { id: 'muffin-veggie', name: 'Savoury Veggie Muffin', emoji: 'ğŸ§', allergens: ['gluten', 'eggs', 'dairy'], ingredients: [{ name: 'Savoury Muffin (homemade/bought)', qty: 1, unit: '', category: 'Bakery' }], recipe: { prepTime: '30 secs', steps: ['Pack a homemade or store-bought muffin'], tip: 'ğŸ’¡ Hide veggies in muffins - kids never know!' } },
      { id: 'popcorn', name: 'Plain Popcorn', emoji: 'ğŸ¿', allergens: [], ingredients: [{ name: 'Popcorn Kernels', qty: 2, unit: 'tbsp', category: 'Pantry' }], recipe: { prepTime: '5 mins', steps: ['Pop kernels in microwave or stovetop', 'Let cool completely', 'Pack in container or paper bag'], tip: 'ğŸ’¡ Make a big batch Sunday - keeps all week in airtight container!' } },
      { id: 'crumpet-butter', name: 'Buttered Crumpet', emoji: 'ğŸ¥', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Crumpets', qty: 1, unit: '', category: 'Bakery' }, { name: 'Butter', qty: 1, unit: 'tsp', category: 'Dairy' }], recipe: { prepTime: '2 mins', steps: ['Toast crumpet until golden', 'Butter while warm', 'Let cool before packing'], tip: 'ğŸ’¡ Great cold or at room temperature!' } },
      { id: 'pikelet-jam', name: 'Pikelets with Jam', emoji: 'ğŸ¥', allergens: ['gluten', 'eggs', 'dairy'], ingredients: [{ name: 'Pikelets', qty: 2, unit: '', category: 'Bakery' }, { name: 'Strawberry Jam', qty: 1, unit: 'tsp', category: 'Pantry' }], recipe: { prepTime: '1 min', steps: ['Spread jam on pikelets', 'Stack together'], tip: 'ğŸ’¡ Aussie classic! Make on weekend and freeze!' } },
      { id: 'vegemite-scroll', name: 'Vegemite Scroll', emoji: 'ğŸŒ€', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Vegemite Scroll', qty: 1, unit: '', category: 'Bakery' }], recipe: { prepTime: '10 secs', steps: ['Grab from bakery section!'], tip: 'ğŸ’¡ Bakers Delight does great ones!' } },
      { id: 'cheese-twist', name: 'Cheese & Bacon Twist', emoji: 'ğŸ¥¨', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Cheese Twist', qty: 1, unit: '', category: 'Bakery' }], recipe: { prepTime: '10 secs', steps: ['Pack from bakery section'], tip: 'ğŸ’¡ Delicious savoury pastry!' } },
      { id: 'damper-mini', name: 'Mini Damper Roll', emoji: 'ğŸ', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Mini Damper Roll', qty: 1, unit: '', category: 'Bakery' }], recipe: { prepTime: '10 secs', steps: ['Pack a mini damper roll', 'Great with butter!'], tip: 'ğŸ’¡ Traditional Aussie bush bread!' } },
      { id: 'fairy-bread', name: 'Fairy Bread', emoji: 'âœ¨', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'White Bread', qty: 1, unit: 'slice', category: 'Bakery' }, { name: 'Butter', qty: 1, unit: 'tsp', category: 'Dairy' }, { name: 'Hundreds & Thousands', qty: 1, unit: 'tbsp', category: 'Pantry' }], recipe: { prepTime: '1 min', steps: ['Butter bread generously', 'Cover with hundreds & thousands', 'Cut into triangles'], tip: 'ğŸ’¡ Aussie party classic - occasional treat!' } },
      { id: 'cheese-vegemite-scroll', name: 'Cheese & Vegemite Scroll', emoji: 'ğŸŒ€', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Cheese & Vegemite Scroll', qty: 1, unit: '', category: 'Bakery' }], recipe: { prepTime: '10 secs', steps: ['Grab from bakery!'], tip: 'ğŸ’¡ Ultimate Aussie combo!' } },
      { id: 'corn-thins', name: 'Corn Thins', emoji: 'ğŸŒ½', allergens: [], ingredients: [{ name: 'Corn Thins', qty: 4, unit: '', category: 'Pantry' }], recipe: { prepTime: '30 secs', steps: ['Pack corn thins', 'Great for gluten-free kids!'], tip: 'ğŸ’¡ Top with avocado or vegemite!' } },
      { id: 'rice-cakes', name: 'Rice Cakes', emoji: 'ğŸ˜', allergens: [], ingredients: [{ name: 'Rice Cakes', qty: 2, unit: '', category: 'Pantry' }], recipe: { prepTime: '30 secs', steps: ['Pack rice cakes', 'Add toppings separately'], tip: 'ğŸ’¡ Gluten-free and crunchy!' } },
      { id: 'naan-bread-piece', name: 'Mini Naan Bread', emoji: 'ğŸ«“', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Mini Naan Bread', qty: 1, unit: '', category: 'Bakery' }], recipe: { prepTime: '30 secs', steps: ['Pack naan bread', 'Great for dipping!'], tip: 'ğŸ’¡ Woolies sells small packs perfect for lunchboxes!' } },
      { id: 'mountain-bread-wrap', name: 'Mountain Bread Wrap', emoji: 'ğŸ«“', allergens: ['gluten'], ingredients: [{ name: 'Mountain Bread', qty: 1, unit: '', category: 'Bakery' }, { name: 'Fillings of choice', qty: 1, unit: '', category: 'Deli' }], recipe: { prepTime: '3 mins', steps: ['Lay mountain bread flat', 'Add fillings', 'Roll tightly'], tip: 'ğŸ’¡ Super thin wraps - less bread, more filling!' } },
      { id: 'sushi-roll', name: 'Sushi Roll', emoji: 'ğŸ£', allergens: ['fish', 'soy', 'sesame'], ingredients: [{ name: 'Sushi Roll', qty: 4, unit: 'pieces', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Buy pre-made sushi', 'Keep with ice pack'], tip: 'ğŸ’¡ Woolies and Coles have fresh sushi daily!' } },
      { id: 'couscous-salad', name: 'Couscous Salad', emoji: 'ğŸ¥—', allergens: ['gluten'], ingredients: [{ name: 'Couscous', qty: 0.5, unit: 'cup cooked', category: 'Pantry' }, { name: 'Cherry Tomatoes', qty: 4, unit: '', category: 'Produce' }, { name: 'Cucumber', qty: 4, unit: 'cubes', category: 'Produce' }, { name: 'Feta Cheese', qty: 1, unit: 'tbsp', category: 'Dairy' }], recipe: { prepTime: '10 mins', steps: ['Cook couscous as per packet', 'Cool completely', 'Mix with chopped veggies and feta', 'Drizzle with lemon juice'], tip: 'ğŸ’¡ Make a big batch for the week!' } },
      { id: 'weetbix-slice', name: 'Weetbix Slice', emoji: 'ğŸ«', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Weetbix Slice', qty: 1, unit: 'piece', category: 'Bakery' }], recipe: { prepTime: '10 secs', steps: ['Cut a piece and wrap'], tip: 'ğŸ’¡ Homemade is healthier and tastier!' } },
      { id: 'sandwich-vegemite', name: 'Vegemite Sandwich', emoji: 'ğŸ¥ª', allergens: ['gluten'], ingredients: [{ name: 'Bread', qty: 2, unit: 'slices', category: 'Bakery' }, { name: 'Vegemite', qty: 1, unit: 'tsp', category: 'Pantry' }, { name: 'Butter', qty: 1, unit: 'tsp', category: 'Dairy' }], recipe: { prepTime: '1 min', steps: ['Butter bread', 'Spread thin layer of Vegemite', 'Close sandwich'], tip: 'ğŸ’¡ Aussie icon - thin spread for kids!' } },
      { id: 'sandwich-chicken', name: 'Chicken Mayo Sandwich', emoji: 'ğŸ¥ª', allergens: ['gluten', 'eggs'], ingredients: [{ name: 'Bread', qty: 2, unit: 'slices', category: 'Bakery' }, { name: 'Shredded Chicken', qty: 50, unit: 'g', category: 'Deli' }, { name: 'Mayonnaise', qty: 1, unit: 'tbsp', category: 'Pantry' }], recipe: { prepTime: '2 mins', steps: ['Mix chicken with mayo', 'Spread on bread'], tip: 'ğŸ’¡ Use rotisserie chicken from Woolies!' } },
      { id: 'wrap-chicken-caesar', name: 'Chicken Caesar Wrap', emoji: 'ğŸŒ¯', allergens: ['gluten', 'dairy', 'eggs'], ingredients: [{ name: 'Wrap', qty: 1, unit: '', category: 'Bakery' }, { name: 'Chicken', qty: 50, unit: 'g', category: 'Deli' }, { name: 'Cos Lettuce', qty: 2, unit: 'leaves', category: 'Produce' }], recipe: { prepTime: '3 mins', steps: ['Spread dressing on wrap', 'Add chicken and lettuce', 'Roll tightly'], tip: 'ğŸ’¡ Cut in half for easier eating!' } },
      { id: 'crackers-jatz', name: 'Jatz Crackers', emoji: 'ğŸ˜', allergens: ['gluten'], ingredients: [{ name: 'Jatz Crackers', qty: 6, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack in container'], tip: 'ğŸ’¡ Aussie classic - great with cheese!' } },
      { id: 'crackers-savoy', name: 'Savoy Crackers', emoji: 'ğŸ˜', allergens: ['gluten'], ingredients: [{ name: 'Savoy Crackers', qty: 6, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack in container'], tip: 'ğŸ’¡ Light and crispy!' } },
      { id: 'crackers-vita-weat', name: 'Vita-Weat', emoji: 'ğŸ˜', allergens: ['gluten'], ingredients: [{ name: 'Vita-Weat', qty: 4, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack for dipping or topping'], tip: 'ğŸ’¡ Wholegrain goodness!' } },
      { id: 'rice-cakes', name: 'Rice Cakes', emoji: 'ğŸ˜', allergens: [], ingredients: [{ name: 'Rice Cakes', qty: 2, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack whole or spread with topping'], tip: 'ğŸ’¡ Gluten-free option!' } },
      { id: 'cruskits', name: 'Cruskits', emoji: 'ğŸ˜', allergens: ['gluten'], ingredients: [{ name: 'Cruskits', qty: 2, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack with toppings separate'], tip: 'ğŸ’¡ Light rye crackers!' } },
      { id: 'corn-thins', name: 'Corn Thins', emoji: 'ğŸŒ½', allergens: [], ingredients: [{ name: 'Corn Thins', qty: 2, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack for topping'], tip: 'ğŸ’¡ Real Foods brand - GF!' } },
      { id: 'pitta-bread', name: 'Mini Pitta Bread', emoji: 'ğŸ«“', allergens: ['gluten'], ingredients: [{ name: 'Mini Pitta', qty: 2, unit: '', category: 'Bakery' }], recipe: { prepTime: '30 secs', steps: ['Cut open pocket', 'Fill or use for dipping'], tip: 'ğŸ’¡ Perfect for hummus!' } },
      { id: 'bread-roll', name: 'Crusty Bread Roll', emoji: 'ğŸ¥–', allergens: ['gluten'], ingredients: [{ name: 'Bread Roll', qty: 1, unit: '', category: 'Bakery' }], recipe: { prepTime: '2 mins', steps: ['Slice and fill'], tip: 'ğŸ’¡ Bakers Delight rolls are great!' } },
      { id: 'bagel-mini', name: 'Mini Bagel', emoji: 'ğŸ¥¯', allergens: ['gluten'], ingredients: [{ name: 'Mini Bagel', qty: 1, unit: '', category: 'Bakery' }], recipe: { prepTime: '2 mins', steps: ['Slice and fill with cream cheese'], tip: 'ğŸ’¡ Toasted the night before stays fresh!' } },
      { id: 'croissant-mini', name: 'Mini Croissant', emoji: 'ğŸ¥', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Mini Croissant', qty: 1, unit: '', category: 'Bakery' }], recipe: { prepTime: '1 min', steps: ['Slice and fill or pack plain'], tip: 'ğŸ’¡ Woolies bakery has fresh ones!' } },
      { id: 'pasta-wheels', name: 'Pasta Wheels Cold', emoji: 'ğŸ', allergens: ['gluten'], ingredients: [{ name: 'Pasta Wheels', qty: 1, unit: 'cup', category: 'Pantry' }], recipe: { prepTime: '15 mins', steps: ['Cook pasta', 'Cool and toss with olive oil'], tip: 'ğŸ’¡ Fun shapes kids love!' } },
      { id: 'fried-rice-cup', name: 'Fried Rice Cup', emoji: 'ğŸš', allergens: ['eggs', 'soy'], ingredients: [{ name: 'Fried Rice', qty: 1, unit: 'cup', category: 'Deli' }], recipe: { prepTime: '30 secs', steps: ['Pack leftover fried rice cold'], tip: 'ğŸ’¡ Make extra at dinner!' } },
      { id: 'couscous-cup', name: 'Couscous Cup', emoji: 'ğŸš', allergens: ['gluten'], ingredients: [{ name: 'Couscous', qty: 0.5, unit: 'cup', category: 'Pantry' }], recipe: { prepTime: '5 mins', steps: ['Pour boiling water over couscous', 'Fluff and cool'], tip: 'ğŸ’¡ Ainsley Harriott cups are easy!' } },
    ]
  },
  water: {
    name: 'Drink',
    emoji: 'ğŸ’§',
    color: '#74B9FF',
    items: [
      { id: 'water-plain', name: 'Water Bottle', emoji: 'ğŸ’§', allergens: [], ingredients: [{ name: 'Water', qty: 1, unit: 'bottle', category: 'Drinks' }], recipe: { prepTime: '30 secs', steps: ['Fill drink bottle with cold water', 'Pop in the freezer for 10 mins if you have time'], tip: 'ğŸ’¡ Freeze half-full overnight - top up in morning for icy cold water all day!' } },
      { id: 'water-lemon', name: 'Lemon Infused Water', emoji: 'ğŸ‹', allergens: [], ingredients: [{ name: 'Water', qty: 1, unit: 'bottle', category: 'Drinks' }, { name: 'Lemon', qty: 1, unit: 'slice', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Fill bottle with cold water', 'Add 1-2 thin lemon slices', 'Shake gently'], tip: 'ğŸ’¡ The longer it sits, the more lemony it gets!' } },
      { id: 'water-orange', name: 'Orange Infused Water', emoji: 'ğŸŠ', allergens: [], ingredients: [{ name: 'Water', qty: 1, unit: 'bottle', category: 'Drinks' }, { name: 'Orange', qty: 1, unit: 'slice', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Fill bottle with cold water', 'Add 1-2 orange slices', 'Gently muddle to release flavour'], tip: 'ğŸ’¡ Kids love the subtle sweetness!' } },
      { id: 'water-berry', name: 'Berry Infused Water', emoji: 'ğŸ«', allergens: [], ingredients: [{ name: 'Water', qty: 1, unit: 'bottle', category: 'Drinks' }, { name: 'Mixed Berries', qty: 1, unit: 'handful', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Add handful of berries to bottle', 'Fill with cold water', 'Gently shake'], tip: 'ğŸ’¡ Frozen berries work great and keep water cold!' } },
      { id: 'water-cucumber-mint', name: 'Cucumber & Mint Water', emoji: 'ğŸ¥’', allergens: [], ingredients: [{ name: 'Water', qty: 1, unit: 'bottle', category: 'Drinks' }, { name: 'Cucumber', qty: 2, unit: 'slices', category: 'Produce' }, { name: 'Fresh Mint', qty: 2, unit: 'leaves', category: 'Produce' }], recipe: { prepTime: '1 min', steps: ['Add cucumber slices to bottle', 'Gently bruise mint leaves and add', 'Fill with cold water'], tip: 'ğŸ’¡ Super refreshing on hot days!' } },
      { id: 'popper-apple', name: 'Apple Juice Popper', emoji: 'ğŸ§ƒ', allergens: [], ingredients: [{ name: 'Apple Juice Popper', qty: 1, unit: '', category: 'Drinks' }], recipe: { prepTime: '10 secs', steps: ['Grab from pantry and pack!'], tip: 'ğŸ’¡ Golden Circle and Pop Tops are Aussie faves!' } },
      { id: 'popper-orange', name: 'Orange Juice Popper', emoji: 'ğŸ§ƒ', allergens: [], ingredients: [{ name: 'Orange Juice Popper', qty: 1, unit: '', category: 'Drinks' }], recipe: { prepTime: '10 secs', steps: ['Grab from pantry and pack!'], tip: 'ğŸ’¡ Great source of vitamin C!' } },
      { id: 'popper-tropical', name: 'Tropical Juice Popper', emoji: 'ğŸ§ƒ', allergens: [], ingredients: [{ name: 'Tropical Juice Popper', qty: 1, unit: '', category: 'Drinks' }], recipe: { prepTime: '10 secs', steps: ['Grab from pantry and pack!'], tip: 'ğŸ’¡ Mango, pineapple, passionfruit blend!' } },
      { id: 'popper-apple-blackcurrant', name: 'Apple & Blackcurrant Popper', emoji: 'ğŸ§ƒ', allergens: [], ingredients: [{ name: 'Apple Blackcurrant Popper', qty: 1, unit: '', category: 'Drinks' }], recipe: { prepTime: '10 secs', steps: ['Grab from pantry and pack!'], tip: 'ğŸ’¡ Classic Aussie combo!' } },
      { id: 'up-and-go', name: 'Up & Go', emoji: 'ğŸ¥›', allergens: ['dairy', 'gluten'], ingredients: [{ name: 'Up & Go', qty: 1, unit: '', category: 'Drinks' }], recipe: { prepTime: '10 secs', steps: ['Grab from pantry - shelf stable!'], tip: 'ğŸ’¡ Breakfast drink with fibre - filling and nutritious!' } },
      { id: 'flavoured-milk-choc', name: 'Chocolate Flavoured Milk', emoji: 'ğŸ¥›', allergens: ['dairy'], ingredients: [{ name: 'Chocolate Milk Popper', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Keep cold with ice pack'], tip: 'ğŸ’¡ Oak and Dare are popular brands!' } },
      { id: 'flavoured-milk-strawberry', name: 'Strawberry Flavoured Milk', emoji: 'ğŸ¥›', allergens: ['dairy'], ingredients: [{ name: 'Strawberry Milk Popper', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Keep cold with ice pack'], tip: 'ğŸ’¡ Kids love the pink colour!' } },
      { id: 'coconut-water', name: 'Coconut Water', emoji: 'ğŸ¥¥', allergens: [], ingredients: [{ name: 'Coconut Water Popper', qty: 1, unit: '', category: 'Drinks' }], recipe: { prepTime: '10 secs', steps: ['Grab from pantry and pack!'], tip: 'ğŸ’¡ Natural electrolytes - great for hot days!' } },
      { id: 'juice-box-apple', name: 'Apple Juice Box', emoji: 'ğŸ', allergens: [], ingredients: [{ name: 'Apple Juice Box', qty: 1, unit: '', category: 'Drinks' }], recipe: { prepTime: '10 secs', steps: ['Pack straight from pantry!'], tip: 'ğŸ’¡ Look for no added sugar varieties!' } },
      { id: 'smoothie-pouch', name: 'Smoothie Pouch', emoji: 'ğŸ“', allergens: ['dairy'], ingredients: [{ name: 'Smoothie Pouch', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Keep cold - pack with ice pack'], tip: 'ğŸ’¡ Fruit and yoghurt in one - filling snack drink!' } },
      { id: 'yakult', name: 'Yakult', emoji: 'ğŸ¥›', allergens: ['dairy'], ingredients: [{ name: 'Yakult', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Keep cold with ice pack'], tip: 'ğŸ’¡ Probiotic drink for gut health!' } },
      { id: 'water-sparkling', name: 'Sparkling Water', emoji: 'ğŸ’§', allergens: [], ingredients: [{ name: 'Sparkling Water', qty: 250, unit: 'ml', category: 'Drinks' }], recipe: { prepTime: '10 secs', steps: ['Pour into drink bottle'], tip: 'ğŸ’¡ Mount Franklin or Woolies brand!' } },
      { id: 'water-spring', name: 'Spring Water Bottle', emoji: 'ğŸ’§', allergens: [], ingredients: [{ name: 'Spring Water', qty: 1, unit: 'bottle', category: 'Drinks' }], recipe: { prepTime: '10 secs', steps: ['Grab and go!'], tip: 'ğŸ’¡ Pump brand is kid-sized!' } },
      { id: 'juice-orange-fresh', name: 'Fresh Orange Juice', emoji: 'ğŸŠ', allergens: [], ingredients: [{ name: 'Fresh OJ', qty: 200, unit: 'ml', category: 'Drinks' }], recipe: { prepTime: '10 secs', steps: ['Pour into drink bottle'], tip: 'ğŸ’¡ Nudie or Coles fresh squeezed!' } },
      { id: 'juice-apple-fresh', name: 'Fresh Apple Juice', emoji: 'ğŸ', allergens: [], ingredients: [{ name: 'Fresh Apple Juice', qty: 200, unit: 'ml', category: 'Drinks' }], recipe: { prepTime: '10 secs', steps: ['Pour into bottle'], tip: 'ğŸ’¡ No added sugar varieties!' } },
      { id: 'milk-oak', name: 'Oak Flavoured Milk', emoji: 'ğŸ¥›', allergens: ['dairy'], ingredients: [{ name: 'Oak Milk', qty: 1, unit: 'carton', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Pack the carton!'], tip: 'ğŸ’¡ Aussie classic - choc or strawberry!' } },
      { id: 'milk-milo', name: 'Milo Up&Go', emoji: 'ğŸ¥›', allergens: ['dairy'], ingredients: [{ name: 'Milo Up&Go', qty: 1, unit: 'carton', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Pack and go!'], tip: 'ğŸ’¡ Energy from Milo!' } },
      { id: 'smoothie-banana', name: 'Banana Smoothie', emoji: 'ğŸŒ', allergens: ['dairy'], ingredients: [{ name: 'Banana', qty: 1, unit: '', category: 'Produce' }, { name: 'Milk', qty: 200, unit: 'ml', category: 'Dairy' }], recipe: { prepTime: '3 mins', steps: ['Blend all ingredients', 'Pour into bottle'], tip: 'ğŸ’¡ Make night before - shake before drinking!' } },
      { id: 'smoothie-berry', name: 'Berry Smoothie', emoji: 'ğŸ“', allergens: ['dairy'], ingredients: [{ name: 'Mixed Berries', qty: 0.5, unit: 'cup', category: 'Frozen' }, { name: 'Yoghurt', qty: 100, unit: 'g', category: 'Dairy' }], recipe: { prepTime: '3 mins', steps: ['Blend until smooth', 'Pour into bottle'], tip: 'ğŸ’¡ Frozen berries make it thick!' } },
    ]
  },
  sweets: {
    name: 'Sweets',
    emoji: 'ğŸ¬',
    color: '#FF85A2',
    items: [
      { id: 'muesli-bar', name: 'Muesli Bar', emoji: 'ğŸ«', allergens: ['gluten', 'nuts'], ingredients: [{ name: 'Muesli Bar', qty: 1, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Grab from pantry and pack!'], tip: 'ğŸ’¡ Look for nut-free options for school!' } },
      { id: 'fruit-strap', name: 'Fruit Strap', emoji: 'ğŸ“', allergens: [], ingredients: [{ name: 'Fruit Strap', qty: 1, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack straight from box!'], tip: 'ğŸ’¡ Made from real fruit - a healthier sweet treat!' } },
      { id: 'fruit-cup', name: 'Fruit Cup in Juice', emoji: 'ğŸ‘', allergens: [], ingredients: [{ name: 'Fruit Cup', qty: 1, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack with a spoon!'], tip: 'ğŸ’¡ Choose fruit in juice, not syrup for less sugar!' } },
      { id: 'mini-muffin-choc', name: 'Mini Chocolate Muffin', emoji: 'ğŸ§', allergens: ['gluten', 'dairy', 'eggs'], ingredients: [{ name: 'Mini Chocolate Muffin', qty: 1, unit: '', category: 'Bakery' }], recipe: { prepTime: '10 secs', steps: ['Pack a mini muffin as a treat!'], tip: 'ğŸ’¡ Mini size = portion control!' } },
      { id: 'anzac-biscuit', name: 'Anzac Biscuit', emoji: 'ğŸª', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Anzac Biscuit', qty: 1, unit: '', category: 'Bakery' }], recipe: { prepTime: '10 secs', steps: ['Pack homemade or store-bought'], tip: 'ğŸ’¡ A classic Aussie treat with oats and coconut!' } },
      { id: 'shortbread', name: 'Shortbread Biscuit', emoji: 'ğŸª', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Shortbread Biscuit', qty: 2, unit: '', category: 'Bakery' }], recipe: { prepTime: '10 secs', steps: ['Pack a couple of shortbread biscuits'], tip: 'ğŸ’¡ Buttery and delicious!' } },
      { id: 'tiny-teddy', name: 'Tiny Teddy Biscuits', emoji: 'ğŸ§¸', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Tiny Teddy Biscuits', qty: 1, unit: 'snack pack', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack a snack-sized portion'], tip: 'ğŸ’¡ Comes in honey, chocolate and choc chip!' } },
      { id: 'rice-bubble-bar', name: 'Rice Bubble Bar', emoji: 'ğŸš', allergens: ['dairy'], ingredients: [{ name: 'Rice Bubble Bar', qty: 1, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack from pantry!'], tip: 'ğŸ’¡ Easy to make at home with 3 ingredients!' } },
      { id: 'choc-chip-cookie', name: 'Chocolate Chip Cookie', emoji: 'ğŸª', allergens: ['gluten', 'dairy', 'eggs'], ingredients: [{ name: 'Choc Chip Cookie', qty: 1, unit: '', category: 'Bakery' }], recipe: { prepTime: '10 secs', steps: ['Pack a cookie for a treat!'], tip: 'ğŸ’¡ Homemade cookies freeze well - bake a batch!' } },
      { id: 'jam-drops', name: 'Jam Drop Biscuits', emoji: 'ğŸª', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Jam Drop Biscuits', qty: 2, unit: '', category: 'Bakery' }], recipe: { prepTime: '10 secs', steps: ['Pack a couple of jam drops'], tip: 'ğŸ’¡ Classic biscuit kids love!' } },
      { id: 'mini-brownie', name: 'Mini Brownie', emoji: 'ğŸ«', allergens: ['gluten', 'dairy', 'eggs'], ingredients: [{ name: 'Mini Brownie', qty: 1, unit: '', category: 'Bakery' }], recipe: { prepTime: '10 secs', steps: ['Pack a mini brownie square'], tip: 'ğŸ’¡ Cut regular brownies into small portions!' } },
      { id: 'bliss-ball', name: 'Bliss Ball', emoji: 'ğŸŸ¤', allergens: ['nuts'], ingredients: [{ name: 'Bliss Ball', qty: 1, unit: '', category: 'Deli' }], recipe: { prepTime: '10 secs', steps: ['Pack from deli section or homemade'], tip: 'ğŸ’¡ No-bake, made with dates and nuts - naturally sweet!' } },
      { id: 'yoghurt-tube', name: 'Frozen Yoghurt Tube', emoji: 'ğŸ§Š', allergens: ['dairy'], ingredients: [{ name: 'Yoghurt Tube', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Freeze overnight', 'Pack frozen - thaws by lunchtime!'], tip: 'ğŸ’¡ Keeps lunchbox cold and is a sweet treat!' } },
      { id: 'jelly-cup', name: 'Jelly Cup', emoji: 'ğŸ®', allergens: [], ingredients: [{ name: 'Jelly Cup', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Pack pre-made jelly cup'], tip: 'ğŸ’¡ Set in small containers the night before!' } },
      { id: 'banana-bread', name: 'Banana Bread Slice', emoji: 'ğŸ', allergens: ['gluten', 'eggs', 'dairy'], ingredients: [{ name: 'Banana Bread', qty: 1, unit: 'slice', category: 'Bakery' }], recipe: { prepTime: '10 secs', steps: ['Cut a slice and wrap'], tip: 'ğŸ’¡ Great way to use overripe bananas!' } },
      { id: 'mini-lamington', name: 'Mini Lamington', emoji: 'ğŸ§', allergens: ['gluten', 'dairy', 'eggs'], ingredients: [{ name: 'Mini Lamington', qty: 1, unit: '', category: 'Bakery' }], recipe: { prepTime: '10 secs', steps: ['Pack a mini lamington'], tip: 'ğŸ’¡ An iconic Aussie treat!' } },
      { id: 'dried-fruit-mix', name: 'Dried Fruit Mix', emoji: 'ğŸ‡', allergens: [], ingredients: [{ name: 'Mixed Dried Fruit', qty: 1, unit: 'small handful', category: 'Pantry' }], recipe: { prepTime: '30 secs', steps: ['Portion dried fruit into container'], tip: 'ğŸ’¡ Natural sugars - a healthier sweet option!' } },
      { id: 'lcms-bar', name: 'LCMs Bar', emoji: 'ğŸš', allergens: ['dairy'], ingredients: [{ name: 'LCMs Bar', qty: 1, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack from box'], tip: 'ğŸ’¡ Rice bubbles + marshmallow!' } },
      { id: 'roll-up', name: 'Roll-Ups Fruit Snack', emoji: 'ğŸ¬', allergens: [], ingredients: [{ name: 'Roll-Ups', qty: 1, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack from box'], tip: 'ğŸ’¡ Fun to unroll and eat!' } },
      { id: 'shapes-bbq', name: 'Shapes BBQ', emoji: 'ğŸ˜', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Shapes BBQ', qty: 1, unit: 'snack pack', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack snack-size box'], tip: 'ğŸ’¡ Iconic Aussie snack!' } },
      { id: 'shapes-pizza', name: 'Shapes Pizza', emoji: 'ğŸ˜', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Shapes Pizza', qty: 1, unit: 'snack pack', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack snack-size box'], tip: 'ğŸ’¡ Tangy pizza flavour!' } },
      { id: 'le-snak', name: 'Le Snak', emoji: 'ğŸ§€', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Le Snak', qty: 1, unit: '', category: 'Dairy' }], recipe: { prepTime: '10 secs', steps: ['Pack from fridge'], tip: 'ğŸ’¡ Crackers + cheese dip!' } },
      { id: 'dunkaroos', name: 'Dunkaroos', emoji: 'ğŸª', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Dunkaroos', qty: 1, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack with dip attached'], tip: 'ğŸ’¡ 90s kids favourite is back!' } },
      { id: 'wagon-wheel', name: 'Mini Wagon Wheel', emoji: 'ğŸ«', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Mini Wagon Wheel', qty: 1, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack 1 mini wheel'], tip: 'ğŸ’¡ Marshmallow, jam and choc!' } },
      { id: 'freddo-frog', name: 'Freddo Frog', emoji: 'ğŸ¸', allergens: ['dairy'], ingredients: [{ name: 'Freddo Frog', qty: 1, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack 1 freddo'], tip: 'ğŸ’¡ Classic Aussie chocolate!' } },
      { id: 'caramello-koala', name: 'Caramello Koala', emoji: 'ğŸ¨', allergens: ['dairy'], ingredients: [{ name: 'Caramello Koala', qty: 1, unit: '', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack 1 koala'], tip: 'ğŸ’¡ Caramel-filled chocolate!' } },
      { id: 'popcorn-sweet', name: 'Sweet Popcorn', emoji: 'ğŸ¿', allergens: [], ingredients: [{ name: 'Sweet Popcorn', qty: 1, unit: 'snack pack', category: 'Pantry' }], recipe: { prepTime: '10 secs', steps: ['Pack snack-size bag'], tip: 'ğŸ’¡ Cobbs or Woolies brand!' } },
      { id: 'pikelets', name: 'Mini Pikelets', emoji: 'ğŸ¥', allergens: ['gluten', 'eggs', 'dairy'], ingredients: [{ name: 'Pikelets', qty: 3, unit: '', category: 'Bakery' }], recipe: { prepTime: '30 secs', steps: ['Spread with butter or jam'], tip: 'ğŸ’¡ Golden brand from Woolies!' } },
      { id: 'fairy-bread', name: 'Fairy Bread Bites', emoji: 'âœ¨', allergens: ['gluten', 'dairy'], ingredients: [{ name: 'Bread', qty: 1, unit: 'slice', category: 'Bakery' }, { name: 'Butter', qty: 1, unit: 'tsp', category: 'Dairy' }], recipe: { prepTime: '2 mins', steps: ['Butter bread', 'Cover in sprinkles', 'Cut into triangles'], tip: 'ğŸ’¡ Aussie party essential!' } },
      { id: 'milo-balls', name: 'Milo Balls (Homemade)', emoji: 'ğŸŸ¤', allergens: ['dairy'], ingredients: [{ name: 'Milo', qty: 1, unit: 'cup', category: 'Pantry' }, { name: 'Condensed Milk', qty: 0.5, unit: 'cup', category: 'Pantry' }], recipe: { prepTime: '15 mins', steps: ['Mix Milo and condensed milk', 'Roll into balls', 'Coat in extra Milo'], tip: 'ğŸ’¡ No-bake Aussie classic!' } },
    ]
  }
};

// Bento Box Layout Presets
const BENTO_LAYOUTS = {
  classic: {
    id: 'classic',
    name: 'Classic Bento',
    description: 'Traditional layout with main + sides',
    preview: 'ğŸ±',
    compartments: [
      { id: 'c1', x: 0, y: 0, w: 2, h: 1, category: 'grains' },
      { id: 'c2', x: 0, y: 1, w: 1, h: 1, category: 'protein' },
      { id: 'c3', x: 1, y: 1, w: 1, h: 1, category: 'dairy' },
      { id: 'c4', x: 0, y: 2, w: 1, h: 1, category: 'fruit' },
      { id: 'c5', x: 1, y: 2, w: 1, h: 1, category: 'vegetables' },
      { id: 'c6', x: 0, y: 3, w: 2, h: 1, category: 'sweets' },
    ],
    gridCols: 2,
    gridRows: 4,
  },
  bigMain: {
    id: 'bigMain',
    name: 'Big Main',
    description: 'Large section for wraps & sandwiches',
    preview: 'ğŸ¥ª',
    compartments: [
      { id: 'c1', x: 0, y: 0, w: 2, h: 2, category: 'grains' },
      { id: 'c2', x: 2, y: 0, w: 1, h: 1, category: 'protein' },
      { id: 'c3', x: 2, y: 1, w: 1, h: 1, category: 'dairy' },
      { id: 'c4', x: 0, y: 2, w: 1, h: 1, category: 'fruit' },
      { id: 'c5', x: 1, y: 2, w: 1, h: 1, category: 'vegetables' },
      { id: 'c6', x: 2, y: 2, w: 1, h: 1, category: 'sweets' },
    ],
    gridCols: 3,
    gridRows: 3,
  },
  snacker: {
    id: 'snacker',
    name: 'Snack Attack',
    description: 'Equal portions for grazers',
    preview: 'ğŸ‡',
    compartments: [
      { id: 'c1', x: 0, y: 0, w: 1, h: 1, category: 'grains' },
      { id: 'c2', x: 1, y: 0, w: 1, h: 1, category: 'protein' },
      { id: 'c3', x: 2, y: 0, w: 1, h: 1, category: 'dairy' },
      { id: 'c4', x: 0, y: 1, w: 1, h: 1, category: 'fruit' },
      { id: 'c5', x: 1, y: 1, w: 1, h: 1, category: 'vegetables' },
      { id: 'c6', x: 2, y: 1, w: 1, h: 1, category: 'sweets' },
    ],
    gridCols: 3,
    gridRows: 2,
  },
  leftRight: {
    id: 'leftRight',
    name: 'Left & Right',
    description: 'Main on left, snacks on right',
    preview: 'ğŸ“¦',
    compartments: [
      { id: 'c1', x: 0, y: 0, w: 1, h: 2, category: 'grains' },
      { id: 'c2', x: 1, y: 0, w: 1, h: 1, category: 'protein' },
      { id: 'c3', x: 1, y: 1, w: 1, h: 1, category: 'dairy' },
      { id: 'c4', x: 0, y: 2, w: 1, h: 1, category: 'fruit' },
      { id: 'c5', x: 1, y: 2, w: 1, h: 1, category: 'vegetables' },
      { id: 'c6', x: 0, y: 3, w: 2, h: 1, category: 'sweets' },
    ],
    gridCols: 2,
    gridRows: 4,
  },
  horizontal: {
    id: 'horizontal',
    name: 'Layers',
    description: 'Horizontal rows - easy to pack',
    preview: 'ğŸ“š',
    compartments: [
      { id: 'c1', x: 0, y: 0, w: 3, h: 1, category: 'grains' },
      { id: 'c2', x: 0, y: 1, w: 1, h: 1, category: 'protein' },
      { id: 'c3', x: 1, y: 1, w: 1, h: 1, category: 'dairy' },
      { id: 'c4', x: 2, y: 1, w: 1, h: 1, category: 'fruit' },
      { id: 'c5', x: 0, y: 2, w: 2, h: 1, category: 'vegetables' },
      { id: 'c6', x: 2, y: 2, w: 1, h: 1, category: 'sweets' },
    ],
    gridCols: 3,
    gridRows: 3,
  },
  simple: {
    id: 'simple',
    name: 'Simple 4',
    description: 'Just 4 sections - minimal fuss',
    preview: 'âœ¨',
    compartments: [
      { id: 'c1', x: 0, y: 0, w: 1, h: 1, category: 'grains' },
      { id: 'c2', x: 1, y: 0, w: 1, h: 1, category: 'protein' },
      { id: 'c3', x: 0, y: 1, w: 1, h: 1, category: 'fruit' },
      { id: 'c4', x: 1, y: 1, w: 1, h: 1, category: 'vegetables' },
    ],
    gridCols: 2,
    gridRows: 2,
  },
};

const ALLERGENS = [
  { id: 'gluten', name: 'Gluten', emoji: 'ğŸŒ¾' },
  { id: 'dairy', name: 'Dairy', emoji: 'ğŸ¥›' },
  { id: 'nuts', name: 'Tree Nuts', emoji: 'ğŸŒ°' },
  { id: 'peanuts', name: 'Peanuts', emoji: 'ğŸ¥œ' },
  { id: 'eggs', name: 'Eggs', emoji: 'ğŸ¥š' },
  { id: 'fish', name: 'Fish', emoji: 'ğŸŸ' },
  { id: 'shellfish', name: 'Shellfish', emoji: 'ğŸ¦' },
  { id: 'soy', name: 'Soy', emoji: 'ğŸ«˜' },
  { id: 'sesame', name: 'Sesame', emoji: 'ğŸŒ±' },
];

const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

// Helper function to get all food items
const getAllFoodItems = () => {
  const items = [];
  Object.entries(FOOD_DATABASE).forEach(([category, data]) => {
    data.items.forEach(item => {
      items.push({ ...item, category });
    });
  });
  return items;
};

// Helper function to check if a category has available items for a child
const getAvailableItemsForCategory = (category, child) => {
  const catData = FOOD_DATABASE[category];
  if (!catData) return [];
  
  return catData.items.filter(item => {
    // Check allergens
    if (child?.allergens?.length > 0) {
      if (item.allergens?.some(a => child.allergens.includes(a))) {
        return false;
      }
    }
    // Check dislikes
    if (child?.dislikes?.includes(item.id)) {
      return false;
    }
    // Check dietary mode
    if (child?.dietaryMode && child.dietaryMode !== 'none') {
      const mode = DIETARY_MODES[child.dietaryMode];
      if (mode) {
        // Check allergen exclusions from dietary mode
        if (mode.excludeAllergens?.length > 0) {
          if (item.allergens?.some(a => mode.excludeAllergens.includes(a.toLowerCase()))) {
            return false;
          }
        }
        // Check item name exclusions from dietary mode
        if (mode.excludeItems?.length > 0) {
          const itemName = item.name.toLowerCase();
          if (mode.excludeItems.some(excluded => itemName.includes(excluded))) {
            return false;
          }
        }
      }
    }
    return true;
  });
};

// Helper function to get categories that have available items for a child
const getAvailableCategoriesForChild = (child) => {
  const available = {};
  Object.keys(FOOD_DATABASE).forEach(category => {
    const items = getAvailableItemsForCategory(category, child);
    available[category] = items.length > 0;
  });
  return available;
};

// Helper function to determine WHY a category is unavailable (allergen vs dietary)
const getCategoryRestrictionReason = (category, child) => {
  const catData = FOOD_DATABASE[category];
  if (!catData) return null;
  
  // Check if category would have items without dietary mode
  const itemsWithoutDietary = catData.items.filter(item => {
    // Only check allergens
    if (child?.allergens?.length > 0) {
      if (item.allergens?.some(a => child.allergens.includes(a))) {
        return false;
      }
    }
    return true;
  });
  
  // If no items even without dietary filtering, it's an allergen issue
  if (itemsWithoutDietary.length === 0) {
    return 'Allergen';
  }
  
  // If items exist without dietary but not with it, it's dietary
  const itemsWithDietary = getAvailableItemsForCategory(category, child);
  if (itemsWithDietary.length === 0) {
    return 'Dietary';
  }
  
  return null; // Category is available
};

// Helper function to count fillable categories for a child
const countFillableCategories = (child) => {
  const available = getAvailableCategoriesForChild(child);
  return Object.values(available).filter(Boolean).length;
};

// Calculate points earned from food selections
// Points per category - displayed when selecting foods
const CATEGORY_POINTS = {
  protein: 20,     // Per category filled
  vegetables: 15,
  dairy: 12,
  fruit: 10,
  grains: 5,
  water: 0,        // Drinks use DRINK_POINTS
  sweets: -20
};

const DRINK_POINTS = {
  'water-plain': 20, 'water-lemon': 20, 'water-orange': 20, 'water-berry': 20, 'water-cucumber-mint': 20,
  'water-sparkling': 20, 'water-spring': 20,
  'coconut-water': 15, 'smoothie-pouch': 10, 'up-and-go': 10, 'yakult': 10,
  'smoothie-banana': 10, 'smoothie-berry': 10,
  'popper-apple': 5, 'popper-orange': 5, 'popper-tropical': 5, 'popper-apple-blackcurrant': 5,
  'juice-box-apple': 5, 'juice-orange-fresh': 5, 'juice-apple-fresh': 5,
  'flavoured-milk-choc': 5, 'flavoured-milk-strawberry': 5,
  'milk-oak': 5, 'milk-milo': 5
};

const calculatePointsFromSelections = (selections, child) => {
  let points = 0;
  
  Object.entries(selections).forEach(([category, items]) => {
    if (items && Array.isArray(items) && items.length > 0) {
      if (category === 'water') {
        // Drinks: individual points per item
        items.forEach(item => {
          points += DRINK_POINTS[item.id] || 5;
          if (child?.dislikes?.includes(item.id)) points += 25;
        });
      } else {
        // Food: points per category filled (not per item)
        points += CATEGORY_POINTS[category] || 0;
        items.forEach(item => {
          if (child?.dislikes?.includes(item.id)) points += 25;
        });
      }
    }
  });
  
  return points;
};

// Calculate max sweets based on points (but sweets are always allowed, just cost points)
const getMaxSweetsForChild = (child) => {
  const points = child?.points || 0;
  if (points >= 500) return 3;  // Super Star: 3 sweets
  if (points >= 200) return 2;  // Rising Star: 2 sweets
  if (points >= 50) return 2;   // Getting Started: 2 sweets
  return 1;                      // New Explorer: 1 sweet
};

// Generate a random balanced lunchbox respecting allergens, dislikes, and layout
const generateSurpriseLunchbox = (child, layout = null) => {
  const selections = {};
  
  // Get categories from layout, or use all categories (excluding water, we'll add it separately)
  const categoriesToFill = layout 
    ? [...new Set(layout.compartments.map(c => c.category).filter(Boolean))]
    : Object.keys(FOOD_DATABASE).filter(k => k !== 'water');
  
  categoriesToFill.forEach(category => {
    const availableItems = getAvailableItemsForCategory(category, child);
    if (availableItems.length > 0) {
      // Pick 1-2 random items from each category (max 3)
      const numItems = category === 'grains' ? 1 : (Math.random() > 0.6 ? 2 : 1);
      const shuffled = [...availableItems].sort(() => Math.random() - 0.5);
      selections[category] = shuffled.slice(0, Math.min(numItems, shuffled.length));
    } else {
      selections[category] = [];
    }
  });
  
  // Always add a random drink (single item only)
  const availableDrinks = getAvailableItemsForCategory('water', child);
  if (availableDrinks.length > 0) {
    const randomDrink = availableDrinks[Math.floor(Math.random() * availableDrinks.length)];
    selections['water'] = [randomDrink];
  } else {
    selections['water'] = [];
  }
  
  return selections;
};

// Animated background component
// Benny the Bento Wombat - App Mascot
const BennyWombat = ({ mood = 'happy', size = 'md', className = '' }) => {
  const sizes = {
    xs: 'w-8 h-8',
    sm: 'w-12 h-12',
    md: 'w-20 h-20',
    lg: 'w-32 h-32',
    xl: 'w-48 h-48'
  };

  return (
    <div className={`relative inline-flex flex-col items-center ${className}`}>
      <div className={`relative ${sizes[size]}`}>
        <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-lg">
          {/* Body - chunky wombat shape */}
          <ellipse cx="50" cy="60" rx="35" ry="30" fill="#8B7355" />
          {/* Tummy */}
          <ellipse cx="50" cy="65" rx="25" ry="20" fill="#C4A77D" />
          {/* Head */}
          <circle cx="50" cy="30" r="25" fill="#8B7355" />
          {/* Snout */}
          <ellipse cx="50" cy="38" rx="12" ry="8" fill="#C4A77D" />
          {/* Nose - pink */}
          <ellipse cx="50" cy="36" rx="5" ry="3" fill="#FFB6C1" />
          {/* Eyes - always normal */}
          <circle cx="40" cy="25" r="5" fill="white" />
          <circle cx="60" cy="25" r="5" fill="white" />
          <circle cx="41" cy="25" r="3" fill="#4A3728" />
          <circle cx="61" cy="25" r="3" fill="#4A3728" />
          <circle cx="42" cy="24" r="1" fill="white" />
          <circle cx="62" cy="24" r="1" fill="white" />
          {/* Rosy cheeks */}
          <circle cx="35" cy="33" r="4" fill="#FFB6C1" opacity="0.5" />
          <circle cx="65" cy="33" r="4" fill="#FFB6C1" opacity="0.5" />
          {/* Ears */}
          <ellipse cx="30" cy="12" rx="8" ry="10" fill="#8B7355" />
          <ellipse cx="70" cy="12" rx="8" ry="10" fill="#8B7355" />
          <ellipse cx="30" cy="12" rx="5" ry="7" fill="#C4A77D" />
          <ellipse cx="70" cy="12" rx="5" ry="7" fill="#C4A77D" />
          {/* Little arms */}
          <ellipse cx="22" cy="55" rx="8" ry="12" fill="#8B7355" />
          <ellipse cx="78" cy="55" rx="8" ry="12" fill="#8B7355" />
          {/* Little feet */}
          <ellipse cx="35" cy="88" rx="10" ry="6" fill="#6B5344" />
          <ellipse cx="65" cy="88" rx="10" ry="6" fill="#6B5344" />
          {/* Smile */}
          {mood === 'worried' ? (
            <path d="M 42 45 Q 50 40, 58 45" stroke="#4A3728" strokeWidth="2" fill="none" />
          ) : (
            <path d="M 42 42 Q 50 50, 58 42" stroke="#4A3728" strokeWidth="2" fill="none" />
          )}
        </svg>
      </div>
    </div>
  );
};

// Benny popup positions - safe positions that won't go off screen
const BENNY_POSITIONS = [
  { position: 'bottom-4 right-4', entry: 'slide-in-right' },
  { position: 'bottom-4 left-4', entry: 'slide-in-left' },
  { position: 'bottom-20 right-4', entry: 'slide-in-right' },
  { position: 'bottom-20 left-4', entry: 'slide-in-left' },
  { position: 'top-24 right-4', entry: 'slide-in-right' },
  { position: 'top-24 left-4', entry: 'slide-in-left' },
];

// Benny popup for celebrations and tips
const BennyPopup = ({ show, mood, message, onClose, autoClose = 4000 }) => {
  const [positionStyle, setPositionStyle] = useState(BENNY_POSITIONS[0]);
  const [isVisible, setIsVisible] = useState(false);
  
  useEffect(() => {
    if (show) {
      // Pick random position
      setPositionStyle(BENNY_POSITIONS[Math.floor(Math.random() * BENNY_POSITIONS.length)]);
      // Trigger slide in after mount
      setTimeout(() => setIsVisible(true), 50);
    } else {
      setIsVisible(false);
    }
  }, [show]);
  
  useEffect(() => {
    if (show && autoClose) {
      const timer = setTimeout(onClose, autoClose);
      return () => clearTimeout(timer);
    }
  }, [show, autoClose, onClose]);
  
  if (!show) return null;
  
  // Determine slide direction classes
  const getSlideClasses = () => {
    if (!isVisible) {
      if (positionStyle.entry === 'slide-in-left') return '-translate-x-full opacity-0';
      return 'translate-x-full opacity-0';
    }
    return 'translate-x-0 opacity-100';
  };
  
  // Check if position is on the left side
  const isLeftSide = positionStyle.position.includes('left-4');
  
  return (
    <div className={`fixed ${positionStyle.position} z-50 transition-all duration-500 ease-out ${getSlideClasses()}`}>
      <div className="flex flex-col items-center">
        {/* Speech bubble - ALWAYS on top and right way up */}
        {message && (
          <div className="relative bg-white rounded-2xl px-5 py-3 shadow-lg border-2 border-amber-200 mb-2 min-w-[200px] max-w-[240px]">
            <p className="text-gray-700 text-center font-medium text-sm" style={{ fontFamily: 'Fredoka, sans-serif' }}>
              {message}
            </p>
            {/* Speech bubble pointer */}
            <div className="absolute -bottom-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-white border-r-2 border-b-2 border-amber-200 rotate-45" />
          </div>
        )}
        
        {/* Benny character */}
        <BennyWombat mood={mood} size="md" />
      </div>
    </div>
  );
};

// Tutorial overlay system
const TutorialOverlay = ({ steps, currentStep, onNext, onPrev, onClose }) => {
  const [targetRect, setTargetRect] = useState(null);
  const [cardPosition, setCardPosition] = useState('bottom');
  
  const step = steps[currentStep];
  
  useEffect(() => {
    if (!step?.target) {
      setTargetRect(null);
      return;
    }
    
    // Find element by data-tutorial attribute
    const element = document.querySelector(`[data-tutorial="${step.target}"]`);
    if (element) {
      const rect = element.getBoundingClientRect();
      setTargetRect({
        top: rect.top + window.scrollY,
        left: rect.left + window.scrollX,
        width: rect.width,
        height: rect.height,
        viewportTop: rect.top,
        viewportBottom: rect.bottom
      });
      
      // Position card above or below target
      const viewportHeight = window.innerHeight;
      if (rect.bottom > viewportHeight * 0.6) {
        setCardPosition('top');
      } else {
        setCardPosition('bottom');
      }
      
      // Scroll element into view if needed
      element.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
      setTargetRect(null);
    }
  }, [step, currentStep]);
  
  if (!step) return null;
  
  // Calculate card styles based on target position
  const getCardStyle = () => {
    if (!targetRect) {
      return { bottom: '2rem', left: '50%', transform: 'translateX(-50%)' };
    }
    
    if (cardPosition === 'top') {
      return {
        top: Math.max(16, targetRect.viewportTop - 220) + 'px',
        left: '50%',
        transform: 'translateX(-50%)'
      };
    }
    
    return {
      top: Math.min(window.innerHeight - 220, targetRect.viewportTop + targetRect.height + 16) + 'px',
      left: '50%',
      transform: 'translateX(-50%)'
    };
  };
  
  const bennyMoods = ['waving', 'happy', 'excited', 'thumbsUp'];
  const bennyMood = bennyMoods[currentStep % bennyMoods.length];
  
  return (
    <div className="fixed inset-0 z-[100]">
      {/* Dark overlay */}
      <div className="absolute inset-0 bg-black/70 transition-all" onClick={onClose} />
      
      {/* Spotlight on target element */}
      {targetRect && (
        <>
          {/* Glowing highlight border */}
          <div 
            className="fixed border-4 border-orange-400 rounded-xl pointer-events-none z-[101]"
            style={{
              top: targetRect.viewportTop - 8,
              left: targetRect.left - 8,
              width: targetRect.width + 16,
              height: targetRect.height + 16,
              boxShadow: '0 0 0 9999px rgba(0,0,0,0.7), 0 0 20px 4px rgba(251,146,60,0.5)',
            }}
          />
          {/* Pulsing ring */}
          <div 
            className="fixed border-2 border-orange-300 rounded-xl pointer-events-none z-[101] animate-ping"
            style={{
              top: targetRect.viewportTop - 12,
              left: targetRect.left - 12,
              width: targetRect.width + 24,
              height: targetRect.height + 24,
              animationDuration: '1.5s'
            }}
          />
          {/* Arrow pointing to element */}
          <div 
            className="fixed z-[102] text-3xl animate-bounce"
            style={{
              top: cardPosition === 'top' 
                ? targetRect.viewportTop - 40 
                : targetRect.viewportTop + targetRect.height + 5,
              left: targetRect.left + targetRect.width / 2 - 15,
            }}
          >
            {cardPosition === 'top' ? 'ğŸ‘‡' : 'ğŸ‘†'}
          </div>
        </>
      )}
      
      {/* Tutorial card with Benny */}
      <div 
        className="fixed bg-white rounded-3xl shadow-2xl p-4 sm:p-5 max-w-md w-[calc(100%-1.5rem)] z-[102] transition-all duration-300"
        style={getCardStyle()}
      >
        <div className="flex items-start gap-4">
          <BennyWombat mood={bennyMood} size="sm" />
          <div className="flex-1">
            <h3 className="font-bold text-lg text-gray-800 mb-2" style={{ fontFamily: 'Fredoka, sans-serif' }}>
              {step.title}
            </h3>
            <p className="text-gray-600 text-xs sm:text-sm mb-4 max-h-24 overflow-y-auto">{step.description}</p>
            
            {/* Progress dots */}
            <div className="flex items-center justify-between">
              <div className="flex gap-1.5">
                {steps.map((_, i) => (
                  <div 
                    key={i} 
                    className={`w-2.5 h-2.5 rounded-full transition-all ${
                      i === currentStep 
                        ? 'bg-orange-400 scale-125' 
                        : i < currentStep 
                          ? 'bg-green-400' 
                          : 'bg-gray-300'
                    }`} 
                  />
                ))}
              </div>
              
              <div className="flex gap-2">
                {currentStep > 0 && (
                  <button onClick={onPrev} className="px-3 py-1.5 text-gray-600 hover:bg-gray-100 rounded-lg text-sm font-medium">
                    â† Back
                  </button>
                )}
                {currentStep < steps.length - 1 ? (
                  <button onClick={onNext} className="px-4 py-1.5 bg-orange-400 hover:bg-orange-500 text-white rounded-lg text-sm font-bold shadow">
                    Next â†’
                  </button>
                ) : (
                  <button onClick={onClose} className="px-4 py-1.5 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-bold shadow">
                    Let's go! âœ“
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
        
        {/* Skip button */}
        <button onClick={onClose} className="absolute top-3 right-3 text-gray-400 hover:text-gray-600 text-sm">
          Skip âœ•
        </button>
      </div>
    </div>
  );
};

// Tutorial system hook
const useTutorial = (tutorialKey) => {
  const [isActive, setIsActive] = useState(false);
  const [currentStep, setCurrentStep] = useState(0);
  const [hasSeenTutorial, setHasSeenTutorial] = useState(() => {
    return localStorage.getItem(`tutorial-seen-${tutorialKey}`) === 'true';
  });
  
  const startTutorial = () => {
    setCurrentStep(0);
    setIsActive(true);
  };
  
  const endTutorial = () => {
    setIsActive(false);
    setCurrentStep(0);
    localStorage.setItem(`tutorial-seen-${tutorialKey}`, 'true');
    setHasSeenTutorial(true);
  };
  
  const nextStep = () => setCurrentStep(prev => prev + 1);
  const prevStep = () => setCurrentStep(prev => Math.max(0, prev - 1));
  
  return { isActive, currentStep, hasSeenTutorial, startTutorial, endTutorial, nextStep, prevStep };
};

// Tutorial steps definitions
const TUTORIAL_STEPS = {
  home: [
    { id: 'welcome', title: "G'day! I'm Benny! ğŸ»", description: "Welcome to the Lunchbox App! I'll help you pack amazing lunches for your little ones. Let me show you around!", target: null },
    { id: 'install-app', title: 'ğŸ“² Install the App', description: 'Tap the blue Install button to add PAKT to your home screen. It works offline and feels like a real app!', target: null },
    { id: 'add-child', title: 'Add Your Kids', description: 'Start by tapping "+ Add Child" to create a profile. You can add their photo, allergies, dietary preferences, and food dislikes!', target: 'add-child-btn' },
    { id: 'select-child', title: 'Select a Child', description: 'Tap on a child\'s card to select them, then you\'ll see their weekly lunch planner.', target: 'child-cards' },
    { id: 'points-system', title: 'â­ Points System', description: 'Kids earn points for healthy foods! Protein +20, Veggies +15, Dairy +12, Fruit +10, Grains +5. Sweets -20 pts. Bonus: +25 for trying disliked foods!', target: null },
    { id: 'rewards', title: 'ğŸ† Custom Rewards', description: 'Create your own rewards for your kids to earn with their points! Tap the Rewards button to set up rewards like "iPad time" or "Movie night". The app suggests point ranges based on what kids typically earn.', target: 'rewards-btn' },
    { id: 'chores', title: 'ğŸ§¹ Chores Tracker', description: 'Add chores to each child profile and track them daily! Kids earn points for completing chores. If a sibling helps, they get a 25% kindness bonus!', target: null },
    { id: 'parent-battle', title: 'ğŸ‘© vs ğŸ‘¨ Parent Battle!', description: 'Track who makes each lunch with the Mum/Dad buttons on each day. At the end of the week, see who packed more lunches - friendly competition makes it fun! ğŸ˜', target: null },
    { id: 'shopping', title: 'Shopping List', description: 'Once you\'ve planned some lunches, tap here to get a complete shopping list organised by aisle!', target: 'shopping-btn' },
    { id: 'todos', title: 'My To-Do\'s', description: 'See all your prep tasks organised by when to do them - tonight, morning, or batch prep! You can even add them to your calendar.', target: 'todos-btn' },
    { id: 'new-week', title: 'New Week', description: 'At the end of the week, tap here to see your family\'s stats, view history, and start fresh!', target: 'new-week-btn' },
  ],
  planner: [
    { id: 'day-cards', title: 'Weekly Planner', description: 'Each card is a school day. Tap any day to open the bento box and add foods!', target: 'day-cards' },
    { id: 'surprise-week', title: 'Surprise Week! ğŸ²', description: 'Stuck for ideas? Tap this to auto-fill the whole week with balanced, safe meals!', target: 'surprise-btn' },
    { id: 'ate-it', title: 'Mark "Ate It!"', description: 'Points are only awarded when your child actually eats their lunch! Tap the star button when they finish to award their points.', target: 'ate-btn' },
  ],
  bento: [
    { id: 'compartments', title: 'Bento Compartments', description: 'Tap any compartment to add foods from that category. Fill up all the sections for a balanced lunch!', target: 'bento-box' },
    { id: 'food-picker', title: 'Pick Foods', description: 'Browse or search foods. Tap to add them - you can add multiple items per compartment!', target: 'food-picker' },
    { id: 'allergen-warning', title: 'Allergen Safety', description: 'Foods with your child\'s allergens are blocked. Disliked foods show ğŸ‘ but can still be added for bonus points!', target: 'food-items' },
    { id: 'save-day', title: 'Save Your Work', description: 'Don\'t forget to tap "Save Day" when you\'re done! Your lunchbox will be remembered.', target: 'save-btn' },
  ]
};

// Benny's random messages
const BENNY_MESSAGES = {
  greeting: [
    "G'day mate! Ready to pack some tucker?",
    "Bonzer day for lunchbox planning!",
    "Let's get cracking!",
    "Ripper! Let's make some lunches!"
  ],
  foodAdded: [
    "Good choice, mate!",
    "Yum! That looks bonzer!",
    "Ooh, I love that one!",
    "Great pick!",
    "That's gonna be delicious!",
    "Healthy and yummy!",
    "Now we're cooking!"
  ],
  sweetsWarning: [
    "Oi! That's not great for the teeth, little mate!",
    "Hmm, maybe just a tiny bit of that one...",
    "Sweets cost points, remember! ğŸ¦·",
    "A little treat is okay... just a little!",
    "My dentist wouldn't approve! ğŸ˜¬",
    "Sugar rush incoming! Keep it balanced!",
    "Careful mate, too many sweets! ğŸ¬",
    "One treat's enough for today!"
  ],
  lunchComplete: [
    "Ripper lunch! Well done!",
    "That's a beauty! Save it!",
    "Bonzer lunchbox, mate!",
    "Perfect! Your kiddo will love it!",
    "Balanced and delicious!",
    "Chef's kiss! ğŸ‘¨â€ğŸ³"
  ],
  surpriseWeek: [
    "Surprise! Hope they love it!",
    "I picked out some beauties!",
    "Random but balanced - my specialty!",
    "Let's see what we've got!",
    "Trust me, I've got good taste!"
  ],
  ateAll: [
    "Champion! They ate it all!",
    "What a legend!",
    "Clean plate club! â­",
    "Bonzer effort!",
    "That's how it's done!",
    "Empty lunchbox = happy Benny!"
  ],
  points: [
    "Points in the bag!",
    "Star power! â­",
    "Earning those rewards!",
    "Keep it up, champion!"
  ],
  kindness: [
    "What a legend! Helping out a sibling!",
    "Kindness bonus! You're a star!",
    "That's the spirit! Teamwork!",
    "Bonzer! Extra points for being helpful!",
    "Siblings helping each other - love it!",
    "Hero move! Bonus points incoming!"
  ],
  choreComplete: [
    "Chore done! Champion effort!",
    "Clean and tidy! Points earned!",
    "That's the way to do it!",
    "Responsible kid alert!",
    "Tick it off! Well done!"
  ]
};

const getRandomBennyMessage = (type) => {
  const messages = BENNY_MESSAGES[type] || BENNY_MESSAGES.greeting;
  return messages[Math.floor(Math.random() * messages.length)];
};

const AnimatedBackground = () => (
  <div className="fixed inset-0 -z-10 overflow-hidden">
    <div className="absolute inset-0 bg-gradient-to-br from-amber-50 via-orange-50 to-rose-50" />
    <div className="absolute top-10 left-10 w-64 h-64 bg-yellow-200/30 rounded-full blur-3xl animate-pulse" />
    <div className="absolute bottom-20 right-20 w-96 h-96 bg-green-200/30 rounded-full blur-3xl animate-pulse" style={{ animationDelay: '1s' }} />
    <div className="absolute top-1/2 left-1/3 w-48 h-48 bg-pink-200/20 rounded-full blur-3xl animate-pulse" style={{ animationDelay: '2s' }} />
  </div>
);

// Login Screen
const LoginScreen = ({ onLogin }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [isSignUp, setIsSignUp] = useState(false);
  const [name, setName] = useState('');

  const handleLogin = () => {
    if (email.trim() && password.trim()) {
      onLogin({ email, name: name || email.split('@')[0] });
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center p-4">
      <div className="bg-white/80 backdrop-blur-lg rounded-3xl shadow-2xl p-8 w-full max-w-md border-4 border-amber-200">
        <div className="text-center mb-8">
          {/* Benny as mascot */}
          <div className="mb-4">
            <BennyWombat mood="happy" size="lg" />
          </div>
          <h1 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 via-pink-500 to-purple-500" style={{ fontFamily: 'Fredoka, Comic Sans MS, cursive' }}>
            PAKT
          </h1>
          <p className="text-gray-600 mt-2 font-medium">Create healthy, happy lunches!</p>
          <p className="text-amber-600 text-sm mt-1 italic">"G'day! I'm Benny - let's pack some tucker!"</p>
        </div>

        <div className="space-y-4">
          {isSignUp && (
            <div>
              <label className="block text-sm font-bold text-gray-700 mb-1">Your Name</label>
              <input
                type="text"
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="w-full px-4 py-3 rounded-2xl border-2 border-amber-200 focus:border-orange-400 focus:outline-none transition-all text-lg"
                placeholder="Super Parent"
              />
            </div>
          )}
          
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">Email</label>
            <input
              type="text"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="w-full px-4 py-3 rounded-2xl border-2 border-amber-200 focus:border-orange-400 focus:outline-none transition-all text-lg"
              placeholder="parent@email.com"
            />
          </div>
          
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-1">Password</label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="w-full px-4 py-3 rounded-2xl border-2 border-amber-200 focus:border-orange-400 focus:outline-none transition-all text-lg"
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            />
          </div>

          <button
            type="button"
            onClick={handleLogin}
            disabled={!email.trim() || !password.trim()}
            className="w-full py-4 bg-gradient-to-r from-orange-400 via-pink-500 to-purple-500 text-white font-bold text-lg rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
          >
            {isSignUp ? 'ğŸ‰ Create Account' : 'ğŸš€ Let\'s Go!'}
          </button>
        </div>

        <p className="text-center mt-6 text-gray-600">
          {isSignUp ? 'Already have an account?' : "Don't have an account?"}{' '}
          <button
            type="button"
            onClick={() => setIsSignUp(!isSignUp)}
            className="text-orange-500 font-bold hover:underline"
          >
            {isSignUp ? 'Sign In' : 'Sign Up'}
          </button>
        </p>
      </div>
    </div>
  );
};

// Banner options for child profiles
const BANNER_OPTIONS = [
  { id: 'gradient-sunset', name: 'Sunset', style: 'linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fecfef 100%)' },
  { id: 'gradient-ocean', name: 'Ocean', style: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
  { id: 'gradient-forest', name: 'Forest', style: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)' },
  { id: 'gradient-candy', name: 'Candy', style: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)' },
  { id: 'gradient-sky', name: 'Sky', style: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' },
  { id: 'gradient-peach', name: 'Peach', style: 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)' },
  { id: 'gradient-grape', name: 'Grape', style: 'linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)' },
  { id: 'gradient-mint', name: 'Mint', style: 'linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%)' },
  { id: 'pattern-dots', name: 'Polka Dots', style: 'radial-gradient(circle, #FFD93D 10%, transparent 11%), radial-gradient(circle, #FFD93D 10%, transparent 11%), #6BCB77', size: '30px 30px', position: '0 0, 15px 15px' },
  { id: 'pattern-stripes', name: 'Stripes', style: 'repeating-linear-gradient(45deg, #FF6B6B, #FF6B6B 10px, #4ECDC4 10px, #4ECDC4 20px)' },
  { id: 'pattern-waves', name: 'Waves', style: 'linear-gradient(135deg, #667eea 25%, transparent 25%), linear-gradient(225deg, #667eea 25%, transparent 25%), linear-gradient(45deg, #667eea 25%, transparent 25%), linear-gradient(315deg, #667eea 25%, #764ba2 25%)', size: '20px 20px' },
  { id: 'pattern-rainbow', name: 'Rainbow', style: 'linear-gradient(90deg, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8f00ff)' },
  { id: 'solid-blue', name: 'Blue', style: '#4facfe' },
  { id: 'solid-pink', name: 'Pink', style: '#f5576c' },
  { id: 'solid-green', name: 'Green', style: '#38ef7d' },
  { id: 'solid-purple', name: 'Purple', style: '#667eea' },
];

// Child Profile Card with Facebook-style banner
const ChildCard = ({ child, isSelected, onClick, onEdit }) => {
  const banner = BANNER_OPTIONS.find(b => b.id === child.banner) || BANNER_OPTIONS[0];
  const points = child.points || 0;
  
  // Determine star level based on points
  const getStarLevel = (pts) => {
    if (pts >= 500) return { stars: 'â­â­â­', label: 'Super Star!', color: 'from-yellow-400 to-amber-500' };
    if (pts >= 200) return { stars: 'â­â­', label: 'Rising Star', color: 'from-blue-400 to-purple-500' };
    if (pts >= 50) return { stars: 'â­', label: 'Getting Started', color: 'from-green-400 to-teal-500' };
    return { stars: 'ğŸŒ±', label: 'New Explorer', color: 'from-gray-400 to-gray-500' };
  };
  
  const starLevel = getStarLevel(points);
  
  return (
    <div
      onClick={onClick}
      className={`relative rounded-2xl cursor-pointer transition-all transform hover:scale-102 overflow-hidden bg-white ${
        isSelected 
          ? 'ring-4 ring-orange-400 shadow-xl scale-102' 
          : 'shadow-md hover:shadow-lg'
      }`}
    >
      {/* Banner */}
      <div 
        className="h-16 sm:h-24 w-full"
        style={{ 
          background: banner.style,
          backgroundSize: banner.size || 'cover',
          backgroundPosition: banner.position || 'center'
        }}
      />
      
      {/* Profile Picture - larger and overlapping banner */}
      <div className="relative px-3 sm:px-4 pb-3 sm:pb-4">
        <div className="absolute -top-8 sm:-top-10 left-3 sm:left-4">
          <div className={`w-16 h-16 sm:w-20 sm:h-20 rounded-full border-4 border-white shadow-lg overflow-hidden ${
            !child.photo ? 'flex items-center justify-center text-3xl sm:text-4xl bg-gradient-to-br from-amber-100 to-orange-100' : ''
          }`}>
            {child.photo ? (
              <img src={child.photo} alt={child.name} className="w-full h-full object-cover" />
            ) : (
              child.avatar || 'ğŸ‘¦'
            )}
          </div>
        </div>
        
        {/* Edit button */}
        <button
          onClick={(e) => { e.stopPropagation(); onEdit(child); }}
          className="absolute top-1 sm:top-2 right-2 p-1.5 sm:p-2 bg-white/90 hover:bg-white rounded-full shadow-md transition-all text-base sm:text-lg"
        >
          âš™ï¸
        </button>
        
        {/* Points badge with Benny star */}
        <div className={`absolute -top-3 sm:-top-4 right-2 sm:right-3 px-2 py-1 sm:px-3 sm:py-1.5 rounded-full bg-gradient-to-r ${starLevel.color} text-white text-xs sm:text-sm font-bold shadow-lg flex items-center gap-1`}>
          {starLevel.stars} {points}
        </div>
        
        {/* Child Info - full width background */}
        <div className="pt-10 sm:pt-12">
          <h3 className="font-bold text-lg sm:text-xl text-gray-800" style={{ fontFamily: 'Fredoka, sans-serif' }}>{child.name}</h3>
          <div className="flex flex-wrap items-center gap-2 sm:gap-3 text-sm sm:text-base text-gray-600 mt-1">
            {child.age && (
              <span className="flex items-center gap-1 bg-blue-50 px-2 py-0.5 rounded-full">
                <span>ğŸ‚</span>
                <span className="font-medium">{child.age} yrs</span>
              </span>
            )}
            {child.allergens?.length > 0 && (
              <span className="flex items-center gap-1 bg-red-50 px-2 py-0.5 rounded-full text-red-600">
                <span className="text-lg">âš ï¸</span>
                <span className="font-medium">{child.allergens.length} allergen{child.allergens.length > 1 ? 's' : ''}</span>
              </span>
            )}
            {child.dislikes?.length > 0 && (
              <span className="flex items-center gap-1 bg-orange-50 px-2 py-0.5 rounded-full text-orange-600">
                <span className="text-lg">ğŸ‘</span>
                <span className="font-medium">{child.dislikes.length} dislike{child.dislikes.length > 1 ? 's' : ''}</span>
              </span>
            )}
          </div>
        </div>
      </div>
      
      {/* Selected indicator */}
      {isSelected && (
        <div className="absolute top-2 left-2 bg-orange-500 text-white text-sm font-bold px-3 py-1 rounded-full shadow">
          âœ“ Selected
        </div>
      )}
    </div>
  );
};

// Child Editor Modal
// Collapsible Section Component for Child Editor
const CollapsibleSection = ({ title, icon, isOpen, onToggle, borderColor, bgColor, textColor, count, children }) => {
  const borderStyle = borderColor || '#e5e7eb';
  const bgStyle = bgColor || '#f9fafb';
  const txtStyle = textColor || '#374151';
  
  return (
    <div className="rounded-xl overflow-hidden mb-3" style={{ border: '1px solid ' + borderStyle }}>
      <button
        type="button"
        onClick={onToggle}
        className="w-full flex items-center justify-between p-3 transition-all"
        style={{ backgroundColor: bgStyle }}
      >
        <span className="text-sm font-bold flex items-center gap-2" style={{ color: txtStyle }}>
          {icon} {title}
          {count !== undefined && (
            <span className="bg-white px-1.5 py-0.5 rounded-full text-xs">{count}</span>
          )}
        </span>
        <span style={{ color: textColor || '#9ca3af' }}>{isOpen ? 'â–¼' : 'â–¶'}</span>
      </button>
      {isOpen && <div className="p-3 bg-white">{children}</div>}
    </div>
  );
};

const ChildEditor = ({ child, onSave, onClose, onDelete, onAddChore, onUpdateChore, onDeleteChore, onShowCopyChores }) => {
  const [name, setName] = useState(child?.name || '');
  const [avatar, setAvatar] = useState(child?.avatar || 'ğŸ‘¦');
  const [photo, setPhoto] = useState(child?.photo || null);
  const [usePhoto, setUsePhoto] = useState(!!child?.photo);
  const [age, setAge] = useState(child?.age || '');
  const [banner, setBanner] = useState(child?.banner || 'gradient-sunset');
  const [allergens, setAllergens] = useState(child?.allergens || []);
  const [dislikes, setDislikes] = useState(child?.dislikes || []);
  const [dietaryMode, setDietaryMode] = useState(child?.dietaryMode || 'none');
  const [bentoLayout, setBentoLayout] = useState(child?.bentoLayout || 'classic');
  const [customLayout, setCustomLayout] = useState(child?.customLayout || null);
  const [showLayoutModal, setShowLayoutModal] = useState(false);
  const [showLayoutDesigner, setShowLayoutDesigner] = useState(false);
  const [allergenSearch, setAllergenSearch] = useState('');
  const [dislikeSearch, setDislikeSearch] = useState('');
  const [showAllDislikes, setShowAllDislikes] = useState(false);
  const [openSections, setOpenSections] = useState({
    photo: false,
    banner: false, 
    layout: false,
    chores: true,
    allergens: false,
    dietary: false,
    dislikes: false
  });
  const toggleSection = (section) => setOpenSections(prev => ({ ...prev, [section]: !prev[section] }));
  
  // Common foods kids often dislike
  const commonDislikedIds = [
    'broccoli-florets', 'celery-sticks', 'capsicum-strips-red', 'capsicum-strips-yellow',
    'cherry-tomatoes', 'cucumber-slices', 'avocado-slices', 'beetroot-slices',
    'cauliflower-florets', 'snow-peas', 'edamame', 'mushrooms',
    'boiled-egg', 'tuna-plain', 'salmon-pieces', 'tofu-cubes',
    'hummus-dip', 'falafel-balls', 'olives',
    'yoghurt-greek', 'cheese-cubes-cheddar',
    'wholegrain-bread', 'wrap-veggie-hummus',
    'sultanas', 'dried-apricots', 'kiwi-sliced', 'rockmelon-cubes',
    'sandwich-salad', 'pasta-salad-pesto', 'couscous-salad'
  ];
  
  const avatars = ['ğŸ‘¦', 'ğŸ‘§', 'ğŸ§’', 'ğŸ‘¶', 'ğŸ¦¸', 'ğŸ¦¸â€â™€ï¸', 'ğŸ§‘â€ğŸ“', 'ğŸ‘¨â€ğŸ“', 'ğŸ‘©â€ğŸ“', 'ğŸ»', 'ğŸ°', 'ğŸ¦Š', 'ğŸ±', 'ğŸ¶', 'ğŸ¦', 'ğŸ¼', 'ğŸ¨', 'ğŸ¦„'];
  const allFoods = getAllFoodItems();
  
  // Get current layout object
  const getCurrentLayout = () => {
    if (bentoLayout === 'custom' && customLayout) {
      return customLayout;
    }
    return BENTO_LAYOUTS[bentoLayout] || BENTO_LAYOUTS.classic;
  };

  const handlePhotoUpload = (e) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        setPhoto(reader.result);
        setUsePhoto(true);
      };
      reader.readAsDataURL(file);
    }
  };

  const toggleAllergen = (id) => {
    setAllergens(prev => 
      prev.includes(id) ? prev.filter(a => a !== id) : [...prev, id]
    );
  };

  const toggleDislike = (id) => {
    setDislikes(prev => 
      prev.includes(id) ? prev.filter(d => d !== id) : [...prev, id]
    );
  };

  const filteredAllergens = ALLERGENS.filter(a => 
    a.name.toLowerCase().includes(allergenSearch.toLowerCase())
  );

  // Get common disliked foods that exist in database
  const commonFoods = allFoods.filter(f => commonDislikedIds.includes(f.id));
  
  // When searching, show all matching foods
  // When not searching, show only common foods unless "show all" is clicked
  const filteredFoods = dislikeSearch 
    ? allFoods.filter(f =>
        f.name.toLowerCase().includes(dislikeSearch.toLowerCase()) ||
        FOOD_DATABASE[f.category].name.toLowerCase().includes(dislikeSearch.toLowerCase())
      )
    : showAllDislikes 
      ? allFoods 
      : commonFoods;

  const selectedBanner = BANNER_OPTIONS.find(b => b.id === banner) || BANNER_OPTIONS[0];

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 overflow-y-auto">
      <div className="bg-white rounded-3xl shadow-2xl w-full max-w-2xl my-4 flex flex-col" style={{ maxHeight: 'calc(100vh - 32px)' }}>
        {/* Banner Preview Header - Fixed */}
        <div 
          className="relative h-32 flex-shrink-0 rounded-t-3xl"
          style={{ 
            background: selectedBanner.style,
            backgroundSize: selectedBanner.size || 'cover',
            backgroundPosition: selectedBanner.position || 'center'
          }}
        >
          {/* Large Profile Picture Preview */}
          <div className="absolute -bottom-8 left-6">
            <div className={`w-20 h-20 rounded-full border-4 border-white shadow-xl overflow-hidden ${
              !usePhoto || !photo ? 'flex items-center justify-center text-5xl bg-gradient-to-br from-amber-100 to-orange-100' : ''
            }`}>
              {usePhoto && photo ? (
                <img src={photo} alt="Profile" className="w-full h-full object-cover" />
              ) : (
                avatar
              )}
            </div>
          </div>
          
          <div className="absolute top-4 right-4 bg-white/90 backdrop-blur-sm rounded-xl px-3 py-1">
            <span className="text-sm font-bold text-gray-700">
              {child ? 'Edit Profile' : 'New Profile'} ğŸ‘¶
            </span>
          </div>
        </div>
        
        {/* Scrollable Content Area */}
        <div className="flex-1 overflow-y-auto p-6 pt-12 min-h-0">
          <div className="space-y-6">
            {/* Name and Age Row */}
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">Name *</label>
                <input
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-orange-400 focus:outline-none text-lg"
                  placeholder="Child's name"
                />
              </div>
              <div>
                <label className="block text-sm font-bold text-gray-700 mb-2">Age</label>
                <select
                  value={age}
                  onChange={(e) => setAge(e.target.value)}
                  className="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-orange-400 focus:outline-none text-lg bg-white"
                >
                  <option value="">Select age</option>
                  {[...Array(18)].map((_, i) => (
                    <option key={i + 1} value={i + 1}>{i + 1} years old</option>
                  ))}
                </select>
              </div>
            </div>

            {/* Profile Picture Section */}
            <CollapsibleSection
              title="Profile Picture"
              icon="ğŸ“·"
              isOpen={openSections.photo}
              onToggle={() => toggleSection('photo')}
              borderColor="#d1d5db"
              bgColor="#f3f4f6"
              textColor="#374151"
            >
              
              {/* Toggle between photo and avatar */}
              <div className="flex gap-2 mb-3">
                <button
                  type="button"
                  onClick={() => setUsePhoto(false)}
                  className={`flex-1 py-2 px-4 rounded-xl font-medium transition-all ${
                    !usePhoto 
                      ? 'bg-orange-500 text-white' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  ğŸ­ Use Avatar
                </button>
                <button
                  type="button"
                  onClick={() => setUsePhoto(true)}
                  className={`flex-1 py-2 px-4 rounded-xl font-medium transition-all ${
                    usePhoto 
                      ? 'bg-orange-500 text-white' 
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  ğŸ“· Use Photo
                </button>
              </div>

              {usePhoto ? (
                <div className="flex items-center gap-4">
                  <label className="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl cursor-pointer transition-all border-2 border-dashed border-gray-300">
                    <span className="text-2xl">ğŸ“·</span>
                    <span className="font-medium text-gray-600">
                      {photo ? 'Change Photo' : 'Upload Photo'}
                    </span>
                    <input
                      type="file"
                      accept="image/*"
                      onChange={handlePhotoUpload}
                      className="hidden"
                    />
                  </label>
                  {photo && (
                    <button
                      type="button"
                      onClick={() => setPhoto(null)}
                      className="px-4 py-3 text-red-500 hover:bg-red-50 rounded-xl transition-all"
                    >
                      ğŸ—‘ï¸ Remove
                    </button>
                  )}
                </div>
              ) : (
                <div className="flex flex-wrap gap-2">
                  {avatars.map(a => (
                    <button
                      key={a}
                      type="button"
                      onClick={() => setAvatar(a)}
                      className={`w-12 h-12 rounded-xl text-2xl transition-all ${
                        avatar === a 
                          ? 'bg-orange-100 border-2 border-orange-400 scale-110' 
                          : 'bg-gray-100 hover:bg-gray-200'
                      }`}
                    >
                      {a}
                    </button>
                  ))}
                </div>
              )}
            </CollapsibleSection>

            {/* Banner Selection */}
            <CollapsibleSection
              title="Profile Banner"
              icon="ğŸ¨"
              isOpen={openSections.banner}
              onToggle={() => toggleSection('banner')}
              borderColor="#fbbf24"
              bgColor="#fef3c7"
              textColor="#92400e"
            >
              <div className="grid grid-cols-4 sm:grid-cols-8 gap-2">
                {BANNER_OPTIONS.map(b => (
                  <button
                    key={b.id}
                    type="button"
                    onClick={() => setBanner(b.id)}
                    className={`h-12 rounded-xl transition-all ${
                      banner === b.id 
                        ? 'ring-2 ring-orange-400 ring-offset-2 scale-105' 
                        : 'hover:scale-105'
                    }`}
                    style={{ 
                      background: b.style,
                      backgroundSize: b.size || 'cover',
                      backgroundPosition: b.position || 'center'
                    }}
                    title={b.name}
                  />
                ))}
              </div>
            </CollapsibleSection>

            {/* Lunchbox Layout Button */}
            <CollapsibleSection
              title="Lunchbox Layout"
              icon="ğŸ±"
              isOpen={openSections.layout}
              onToggle={() => toggleSection('layout')}
              borderColor="#f97316"
              bgColor="#fff7ed"
              textColor="#c2410c"
            >
              <button
                type="button"
                onClick={() => setShowLayoutModal(true)}
                className="w-full flex items-center justify-between px-4 py-3 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-200 rounded-xl hover:border-amber-400 transition-all"
              >
                <div className="flex items-center gap-3">
                  <BentoLayoutPreview layout={getCurrentLayout()} size="small" />
                  <div className="text-left">
                    <p className="font-bold text-gray-700">{getCurrentLayout().name}</p>
                    <p className="text-xs text-gray-500">{getCurrentLayout().description}</p>
                  </div>
                </div>
                <span className="text-amber-600 font-medium">Change â†’</span>
              </button>
            </CollapsibleSection>

            {/* Chores Management - only show if editing existing child */}
            {child && onAddChore && (
              <CollapsibleSection
                title="Chores"
                icon="ğŸ§¹"
                isOpen={openSections.chores}
                onToggle={() => toggleSection('chores')}
                borderColor="#a855f7"
                bgColor="#faf5ff"
                textColor="#7e22ce"
                count={(child.chores || []).length}
              >
              <ChoreManager
                child={{ ...child, chores: child.chores || [] }}
                onAddChore={onAddChore}
                onUpdateChore={onUpdateChore}
                onDeleteChore={onDeleteChore}
                onShowCopy={onShowCopyChores}
              />
              </CollapsibleSection>
            )}

            {/* Allergens with Search */}
            <CollapsibleSection
              title="Allergens (foods to AVOID)"
              icon="âš ï¸"
              isOpen={openSections.allergens}
              onToggle={() => toggleSection('allergens')}
              borderColor="#ef4444"
              bgColor="#fef2f2"
              textColor="#dc2626"
              count={allergens.length}
            >
              <div className="relative mb-2">
                <input
                  type="text"
                  value={allergenSearch}
                  onChange={(e) => setAllergenSearch(e.target.value)}
                  placeholder="ğŸ” Search allergens..."
                  className="w-full px-4 py-2 rounded-xl border-2 border-gray-200 focus:border-orange-400 focus:outline-none"
                />
                {allergenSearch && (
                  <button
                    type="button"
                    onClick={() => setAllergenSearch('')}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                  >
                    âœ•
                  </button>
                )}
              </div>
              {allergens.length > 0 && (
                <div className="mb-2 p-2 bg-red-50 rounded-xl">
                  <span className="text-xs font-bold text-red-600 block mb-1">Selected ({allergens.length}):</span>
                  <div className="flex flex-wrap gap-1">
                    {allergens.map(id => {
                      const allergen = ALLERGENS.find(a => a.id === id);
                      return allergen ? (
                        <span key={id} className="px-2 py-1 bg-red-500 text-white text-xs rounded-full flex items-center gap-1">
                          {allergen.emoji} {allergen.name}
                          <button type="button" onClick={() => toggleAllergen(id)} className="hover:bg-red-600 rounded-full">âœ•</button>
                        </span>
                      ) : null;
                    })}
                  </div>
                </div>
              )}
              <div className="flex flex-wrap gap-2">
                {filteredAllergens.map(allergen => (
                  <button
                    key={allergen.id}
                    type="button"
                    onClick={() => toggleAllergen(allergen.id)}
                    className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${
                      allergens.includes(allergen.id)
                        ? 'bg-red-500 text-white'
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    {allergen.emoji} {allergen.name}
                  </button>
                ))}
                {filteredAllergens.length === 0 && (
                  <p className="text-gray-500 text-sm py-2">No allergens match your search</p>
                )}
              </div>
            </CollapsibleSection>

            {/* Dietary Mode */}
            <CollapsibleSection
              title="Dietary Preference"
              icon="ğŸ¥—"
              isOpen={openSections.dietary}
              onToggle={() => toggleSection('dietary')}
              borderColor="#22c55e"
              bgColor="#f0fdf4"
              textColor="#16a34a"
            >
              <p className="text-xs text-gray-500 mb-2">This will filter food options for {name || 'this child'}</p>
              <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
                {Object.entries(DIETARY_MODES).map(([key, mode]) => (
                  <button
                    key={key}
                    type="button"
                    onClick={() => setDietaryMode(key)}
                    className={`p-2 rounded-xl text-left flex items-center gap-2 transition-all text-sm ${
                      dietaryMode === key 
                        ? 'bg-green-100 border-2 border-green-500' 
                        : 'bg-gray-50 border-2 border-transparent hover:bg-gray-100'
                    }`}
                  >
                    <span className="text-lg">{mode.icon}</span>
                    <span className="font-medium text-gray-700">{mode.name}</span>
                  </button>
                ))}
              </div>
            </CollapsibleSection>

            {/* Dislikes with Search & Category Filter */}
            <CollapsibleSection
              title="Dislikes (foods they won't eat)"
              icon="ğŸ‘"
              isOpen={openSections.dislikes}
              onToggle={() => toggleSection('dislikes')}
              borderColor="#f97316"
              bgColor="#fff7ed"
              textColor="#ea580c"
              count={dislikes.length}
            >
              <div className="relative mb-2">
                <input
                  type="text"
                  value={dislikeSearch}
                  onChange={(e) => setDislikeSearch(e.target.value)}
                  placeholder="ğŸ” Search foods by name or category..."
                  className="w-full px-4 py-2 rounded-xl border-2 border-gray-200 focus:border-orange-400 focus:outline-none"
                />
                {dislikeSearch && (
                  <button
                    type="button"
                    onClick={() => setDislikeSearch('')}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600"
                  >
                    âœ•
                  </button>
                )}
              </div>
              {/* Quick category filters */}
              <div className="flex flex-wrap gap-1 mb-2">
                {Object.entries(FOOD_DATABASE).map(([key, cat]) => (
                  <button
                    key={key}
                    type="button"
                    onClick={() => setDislikeSearch(cat.name)}
                    className="px-2 py-1 text-xs bg-gray-100 hover:bg-gray-200 rounded-full transition-all"
                  >
                    {cat.emoji} {cat.name}
                  </button>
                ))}
                {dislikeSearch && (
                  <button
                    type="button"
                    onClick={() => setDislikeSearch('')}
                    className="px-2 py-1 text-xs bg-orange-100 text-orange-600 hover:bg-orange-200 rounded-full transition-all"
                  >
                    Clear filter
                  </button>
                )}
              </div>
              {dislikes.length > 0 && (
                <div className="mb-2 p-2 bg-orange-50 rounded-xl">
                  <span className="text-xs font-bold text-orange-600 block mb-1">Selected ({dislikes.length}):</span>
                  <div className="flex flex-wrap gap-1">
                    {dislikes.map(id => {
                      const food = allFoods.find(f => f.id === id);
                      return food ? (
                        <span key={id} className="px-2 py-1 bg-orange-500 text-white text-xs rounded-full flex items-center gap-1">
                          {food.emoji} {food.name}
                          <button type="button" onClick={() => toggleDislike(id)} className="hover:bg-orange-600 rounded-full">âœ•</button>
                        </span>
                      ) : null;
                    })}
                  </div>
                </div>
              )}
              
              {/* Info about what's showing */}
              {!dislikeSearch && (
                <div className="mb-2 flex items-center justify-between text-xs text-gray-500">
                  <span>
                    {showAllDislikes 
                      ? `Showing all ${allFoods.length} foods` 
                      : `Showing ${commonFoods.length} commonly disliked foods`
                    }
                  </span>
                  <button
                    type="button"
                    onClick={() => setShowAllDislikes(!showAllDislikes)}
                    className="text-orange-500 hover:text-orange-600 font-medium"
                  >
                    {showAllDislikes ? 'â† Show common only' : 'Show all foods â†’'}
                  </button>
                </div>
              )}
              
              <div className="flex flex-wrap gap-2 p-2 bg-gray-50 rounded-xl max-h-48 overflow-y-auto">
                {filteredFoods.map(food => (
                  <button
                    key={food.id}
                    type="button"
                    onClick={() => toggleDislike(food.id)}
                    className={`px-3 py-1.5 rounded-full text-sm font-medium transition-all ${
                      dislikes.includes(food.id)
                        ? 'bg-orange-500 text-white'
                        : 'bg-white text-gray-700 hover:bg-gray-100 border border-gray-200'
                    }`}
                  >
                    {food.emoji} {food.name}
                  </button>
                ))}
                {filteredFoods.length === 0 && (
                  <p className="text-gray-500 text-sm py-2 w-full text-center">No foods match your search</p>
                )}
              </div>
            </CollapsibleSection>
          </div>
        </div>

        {/* Footer - Fixed at bottom */}
        <div className="p-6 bg-gray-50 flex justify-between border-t flex-shrink-0 rounded-b-3xl">
          {child && (
            <button
              type="button"
              onClick={() => onDelete(child.id)}
              className="px-6 py-3 text-red-500 font-bold hover:bg-red-50 rounded-xl transition-all"
            >
              ğŸ—‘ï¸ Delete
            </button>
          )}
          <div className="flex gap-3 ml-auto">
            <button
              type="button"
              onClick={onClose}
              className="px-6 py-3 text-gray-600 font-bold hover:bg-gray-200 rounded-xl transition-all"
            >
              Cancel
            </button>
            <button
              type="button"
              onClick={() => onSave({ 
                id: child?.id || Date.now(), 
                name, 
                avatar,
                photo: usePhoto ? photo : null,
                age: age || null,
                banner,
                allergens, 
                dislikes,
                dietaryMode,
                bentoLayout,
                customLayout
              })}
              disabled={!name.trim()}
              className="px-6 py-3 bg-gradient-to-r from-orange-400 to-pink-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all disabled:opacity-50"
            >
              âœ“ Save Profile
            </button>
          </div>
        </div>

        {/* Layout Selection Modal */}
        {showLayoutModal && (
          <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-[60]">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[80vh] overflow-y-auto">
              <div className="p-4 border-b bg-gradient-to-r from-amber-100 to-orange-100 rounded-t-2xl">
                <h3 className="text-lg font-bold text-gray-800">ğŸ± Choose Lunchbox Layout</h3>
                <p className="text-sm text-gray-600">Select a layout that matches your child's lunchbox</p>
              </div>
              
              <div className="p-4 space-y-3">
                {/* Preset layouts */}
                {Object.values(BENTO_LAYOUTS).map(layout => (
                  <button
                    key={layout.id}
                    type="button"
                    onClick={() => {
                      setBentoLayout(layout.id);
                      setShowLayoutModal(false);
                    }}
                    className={`w-full flex items-center gap-4 p-3 rounded-xl border-2 transition-all ${
                      bentoLayout === layout.id && bentoLayout !== 'custom'
                        ? 'border-orange-500 bg-orange-50'
                        : 'border-gray-200 hover:border-orange-300'
                    }`}
                  >
                    <BentoLayoutPreview layout={layout} size="small" />
                    <div className="flex-1 text-left">
                      <div className="flex items-center gap-2">
                        <span className="text-lg">{layout.preview}</span>
                        <span className="font-bold text-gray-700">{layout.name}</span>
                      </div>
                      <p className="text-xs text-gray-500">{layout.description}</p>
                    </div>
                    {bentoLayout === layout.id && bentoLayout !== 'custom' && (
                      <span className="text-orange-500 text-xl">âœ“</span>
                    )}
                  </button>
                ))}

                {/* Custom layout option */}
                <button
                  type="button"
                  onClick={() => {
                    setShowLayoutModal(false);
                    setShowLayoutDesigner(true);
                  }}
                  className={`w-full flex items-center gap-4 p-3 rounded-xl border-2 transition-all ${
                    bentoLayout === 'custom'
                      ? 'border-purple-500 bg-purple-50'
                      : 'border-dashed border-gray-300 hover:border-purple-400 bg-gray-50'
                  }`}
                >
                  <div className="w-16 h-12 bg-gradient-to-br from-purple-100 to-pink-100 rounded-lg flex items-center justify-center border-2 border-purple-200">
                    <span className="text-2xl">âœï¸</span>
                  </div>
                  <div className="flex-1 text-left">
                    <div className="flex items-center gap-2">
                      <span className="font-bold text-gray-700">Design Your Own</span>
                    </div>
                    <p className="text-xs text-gray-500">Create a custom layout for your lunchbox</p>
                  </div>
                  {bentoLayout === 'custom' && (
                    <span className="text-purple-500 text-xl">âœ“</span>
                  )}
                </button>
              </div>

              <div className="p-4 border-t flex justify-end">
                <button
                  type="button"
                  onClick={() => setShowLayoutModal(false)}
                  className="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-xl transition-all"
                >
                  Close
                </button>
              </div>
            </div>
          </div>
        )}

        {/* Layout Designer Modal */}
        {showLayoutDesigner && (
          <BentoLayoutDesigner
            initialLayout={customLayout}
            onSave={(newCustomLayout) => {
              setCustomLayout(newCustomLayout);
              setBentoLayout('custom');
              setShowLayoutDesigner(false);
            }}
            onClose={() => setShowLayoutDesigner(false)}
          />
        )}
      </div>
    </div>
  );
};

// Food Item Component
const FoodItem = ({ item, category, isDisabled, isSelected, onSelect }) => {
  const categoryData = FOOD_DATABASE[category];
  
  return (
    <button
      onClick={() => !isDisabled && onSelect(item)}
      disabled={isDisabled}
      className={`p-3 rounded-2xl transition-all relative ${
        isDisabled 
          ? 'opacity-30 cursor-not-allowed bg-gray-100'
          : isSelected
            ? 'bg-gradient-to-br shadow-lg text-white z-10'
            : 'bg-white hover:shadow-md'
      }`}
      style={{
        background: isSelected && !isDisabled
          ? `linear-gradient(135deg, ${categoryData.color}, ${categoryData.color}dd)`
          : undefined
      }}
    >
      {isSelected && (
        <div className="absolute -top-1 -right-1 w-5 h-5 bg-white rounded-full flex items-center justify-center shadow-md border-2 border-green-500 z-20">
          <span className="text-green-500 text-xs font-bold">âœ“</span>
        </div>
      )}
      <div className="text-3xl mb-1">{item.emoji}</div>
      <div className={`text-xs font-bold ${isSelected ? 'text-white' : 'text-gray-700'}`}>
        {item.name}
      </div>
      {isDisabled && (
        <div className="text-xs text-red-500 font-medium mt-1">
          {item.allergens?.length > 0 ? 'âš ï¸' : 'ğŸ‘'}
        </div>
      )}
    </button>
  );
};

// Food Category Section
const FoodCategory = ({ categoryKey, child, selectedItems, onSelectItem }) => {
  const category = FOOD_DATABASE[categoryKey];
  const selectedArray = selectedItems[categoryKey] || [];
  
  const isItemDisabled = (item) => {
    if (!child) return false;
    // Check allergens
    if (item.allergens?.some(a => child.allergens?.includes(a))) return true;
    // Check dislikes
    if (child.dislikes?.includes(item.id)) return true;
    return false;
  };

  const isItemSelected = (item) => {
    return selectedArray.some(s => s.id === item.id);
  };

  return (
    <div className="bg-white/60 backdrop-blur-sm rounded-2xl p-4 shadow-md">
      <div className="flex items-center justify-between mb-3">
        <div className="flex items-center gap-2">
          <span className="text-2xl">{category.emoji}</span>
          <h3 className="font-bold text-lg" style={{ color: category.color }}>
            {category.name}
          </h3>
        </div>
        {selectedArray.length > 0 && (
          <span className="px-2 py-1 bg-gray-100 rounded-full text-xs font-bold text-gray-600">
            {selectedArray.length} selected
          </span>
        )}
      </div>
      <div className="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 pt-1">
        {category.items.map(item => (
          <FoodItem
            key={item.id}
            item={item}
            category={categoryKey}
            isDisabled={isItemDisabled(item)}
            isSelected={isItemSelected(item)}
            onSelect={(item) => onSelectItem(categoryKey, item)}
          />
        ))}
      </div>
    </div>
  );
};

// Mini Bento Preview for layout selector
const BentoLayoutPreview = ({ layout, size = 'normal' }) => {
  const scale = size === 'small' ? 0.6 : 1;
  const cellSize = 28 * scale;
  const gap = 3 * scale;
  
  return (
    <div 
      className="bg-amber-100 rounded-lg p-1"
      style={{
        width: layout.gridCols * cellSize + (layout.gridCols + 1) * gap,
        height: layout.gridRows * cellSize + (layout.gridRows + 1) * gap,
      }}
    >
      <div className="relative w-full h-full">
        {layout.compartments.map(comp => {
          const cat = FOOD_DATABASE[comp.category];
          return (
            <div
              key={comp.id}
              className="absolute rounded"
              style={{
                left: comp.x * (cellSize + gap) + gap,
                top: comp.y * (cellSize + gap) + gap,
                width: comp.w * cellSize + (comp.w - 1) * gap,
                height: comp.h * cellSize + (comp.h - 1) * gap,
                backgroundColor: cat ? `${cat.color}40` : '#e5e7eb',
                border: cat ? `2px solid ${cat.color}` : '2px solid #d1d5db',
              }}
            />
          );
        })}
      </div>
    </div>
  );
};

// Bento Layout Selector Modal
const BentoLayoutSelector = ({ currentLayout, onSelectLayout, onCustomize, onClose }) => {
  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
        <div className="bg-gradient-to-r from-amber-400 to-orange-500 p-6 text-white flex-shrink-0">
          <h2 className="text-2xl font-bold flex items-center gap-2">
            ğŸ± Choose Your Lunchbox Style
          </h2>
          <p className="text-white/80 mt-1">
            Pick a layout that matches your container
          </p>
        </div>
        
        <div className="flex-1 overflow-y-auto p-4">
          <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
            {Object.values(BENTO_LAYOUTS).map(layout => (
              <button
                key={layout.id}
                onClick={() => onSelectLayout(layout)}
                className={`p-4 rounded-2xl border-2 transition-all hover:shadow-lg text-left ${
                  currentLayout?.id === layout.id
                    ? 'border-orange-500 bg-orange-50'
                    : 'border-gray-200 hover:border-orange-300'
                }`}
              >
                <div className="flex justify-center mb-3">
                  <BentoLayoutPreview layout={layout} />
                </div>
                <div className="text-center">
                  <span className="text-2xl">{layout.preview}</span>
                  <h3 className="font-bold text-gray-800 mt-1">{layout.name}</h3>
                  <p className="text-xs text-gray-500 mt-1">{layout.description}</p>
                </div>
                {currentLayout?.id === layout.id && (
                  <div className="mt-2 text-center">
                    <span className="text-xs font-bold text-orange-600 bg-orange-100 px-2 py-1 rounded-full">
                      âœ“ Current
                    </span>
                  </div>
                )}
              </button>
            ))}
          </div>
          
          {/* Custom Layout Option */}
          <div className="mt-6 pt-6 border-t">
            <button
              onClick={onCustomize}
              className="w-full p-4 rounded-2xl border-2 border-dashed border-purple-300 bg-purple-50 hover:bg-purple-100 hover:border-purple-400 transition-all"
            >
              <div className="text-center">
                <span className="text-3xl">âœï¸</span>
                <h3 className="font-bold text-purple-800 mt-2">Design Your Own</h3>
                <p className="text-sm text-purple-600 mt-1">
                  Create a custom layout that fits your container perfectly
                </p>
              </div>
            </button>
          </div>
        </div>

        <div className="p-4 bg-gray-50 border-t flex-shrink-0">
          <button
            onClick={onClose}
            className="w-full py-3 bg-gradient-to-r from-amber-400 to-orange-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all"
          >
            Done
          </button>
        </div>
      </div>
    </div>
  );
};

// Bento Layout Designer - for custom layouts
const BentoLayoutDesigner = ({ initialLayout, onSave, onClose }) => {
  const [gridCols, setGridCols] = useState(initialLayout?.gridCols || 3);
  const [gridRows, setGridRows] = useState(initialLayout?.gridRows || 3);
  const [compartments, setCompartments] = useState(initialLayout?.compartments || []);
  const [selectedCompartment, setSelectedCompartment] = useState(null);
  const [isDrawing, setIsDrawing] = useState(false);
  const [drawStart, setDrawStart] = useState(null);
  const [drawEnd, setDrawEnd] = useState(null);

  // Responsive cell size for mobile
  const [cellSize, setCellSize] = useState(50);
  const gap = 4;
  
  useEffect(() => {
    const updateSize = () => {
      const w = window.innerWidth;
      setCellSize(w < 400 ? 40 : w < 640 ? 50 : 60);
    };
    updateSize();
    window.addEventListener('resize', updateSize);
    return () => window.removeEventListener('resize', updateSize);
  }, []);

  // Check if a cell is occupied
  const isCellOccupied = (x, y, excludeId = null) => {
    return compartments.some(comp => {
      if (comp.id === excludeId) return false;
      return x >= comp.x && x < comp.x + comp.w && y >= comp.y && y < comp.y + comp.h;
    });
  };

  // Get compartment at cell
  const getCompartmentAt = (x, y) => {
    return compartments.find(comp => 
      x >= comp.x && x < comp.x + comp.w && y >= comp.y && y < comp.y + comp.h
    );
  };

  // Handle mouse/touch events for drawing
  const handleCellMouseDown = (x, y) => {
    const existing = getCompartmentAt(x, y);
    if (existing) {
      setSelectedCompartment(existing.id);
    } else {
      setIsDrawing(true);
      setDrawStart({ x, y });
      setDrawEnd({ x, y });
      setSelectedCompartment(null);
    }
  };

  const handleCellMouseEnter = (x, y) => {
    if (isDrawing && drawStart) {
      setDrawEnd({ x, y });
    }
  };

  const handleMouseUp = () => {
    if (isDrawing && drawStart && drawEnd) {
      const minX = Math.min(drawStart.x, drawEnd.x);
      const maxX = Math.max(drawStart.x, drawEnd.x);
      const minY = Math.min(drawStart.y, drawEnd.y);
      const maxY = Math.max(drawStart.y, drawEnd.y);
      
      // Check if area is free
      let canPlace = true;
      for (let x = minX; x <= maxX && canPlace; x++) {
        for (let y = minY; y <= maxY && canPlace; y++) {
          if (isCellOccupied(x, y)) canPlace = false;
        }
      }
      
      if (canPlace) {
        const newComp = {
          id: `c${Date.now()}`,
          x: minX,
          y: minY,
          w: maxX - minX + 1,
          h: maxY - minY + 1,
          category: null,
        };
        setCompartments([...compartments, newComp]);
        setSelectedCompartment(newComp.id);
      }
    }
    setIsDrawing(false);
    setDrawStart(null);
    setDrawEnd(null);
  };

  // Touch event handlers for mobile/tablet
  const gridRef = React.useRef(null);
  
  const getCellFromTouch = (touch) => {
    if (!gridRef.current) return null;
    const rect = gridRef.current.getBoundingClientRect();
    const touchX = touch.clientX - rect.left;
    const touchY = touch.clientY - rect.top;
    const x = Math.floor(touchX / (cellSize + gap));
    const y = Math.floor(touchY / (cellSize + gap));
    if (x >= 0 && x < gridCols && y >= 0 && y < gridRows) {
      return { x, y };
    }
    return null;
  };

  const handleTouchStart = (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    const cell = getCellFromTouch(touch);
    if (cell) {
      handleCellMouseDown(cell.x, cell.y);
    }
  };

  const handleTouchMove = (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    const cell = getCellFromTouch(touch);
    if (cell) {
      handleCellMouseEnter(cell.x, cell.y);
    }
  };

  const handleTouchEnd = (e) => {
    e.preventDefault();
    handleMouseUp();
  };

  // Assign category to compartment
  const assignCategory = (compId, category) => {
    setCompartments(compartments.map(c => 
      c.id === compId ? { ...c, category } : c
    ));
  };

  // Delete compartment
  const deleteCompartment = (compId) => {
    setCompartments(compartments.filter(c => c.id !== compId));
    setSelectedCompartment(null);
  };

  // Get drawing preview rectangle
  const getDrawPreview = () => {
    if (!isDrawing || !drawStart || !drawEnd) return null;
    return {
      x: Math.min(drawStart.x, drawEnd.x),
      y: Math.min(drawStart.y, drawEnd.y),
      w: Math.abs(drawEnd.x - drawStart.x) + 1,
      h: Math.abs(drawEnd.y - drawStart.y) + 1,
    };
  };

  const drawPreview = getDrawPreview();
  const selectedComp = compartments.find(c => c.id === selectedCompartment);
  const usedCategories = compartments.filter(c => c.category).map(c => c.category);

  const handleSave = () => {
    onSave({
      id: 'custom',
      name: 'My Custom Layout',
      description: 'Your personal design',
      preview: 'âœï¸',
      compartments,
      gridCols,
      gridRows,
      isCustom: true,
    });
  };

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl w-full max-w-3xl max-h-[95vh] overflow-hidden flex flex-col">
        <div className="bg-gradient-to-r from-purple-500 to-pink-500 p-4 text-white flex-shrink-0">
          <h2 className="text-xl font-bold">âœï¸ Design Your Lunchbox</h2>
          <p className="text-white/80 text-sm">Draw compartments, then assign food groups</p>
        </div>
        
        <div className="flex-1 overflow-y-auto p-4">
          {/* Grid size controls */}
          <div className="flex flex-wrap gap-4 mb-4 p-3 bg-gray-50 rounded-xl">
            <div className="flex items-center gap-2">
              <span className="text-sm font-medium text-gray-600">Columns:</span>
              <button 
                onClick={() => setGridCols(Math.max(2, gridCols - 1))}
                className="w-8 h-8 bg-white border rounded-lg font-bold"
              >-</button>
              <span className="w-8 text-center font-bold">{gridCols}</span>
              <button 
                onClick={() => setGridCols(Math.min(5, gridCols + 1))}
                className="w-8 h-8 bg-white border rounded-lg font-bold"
              >+</button>
            </div>
            <div className="flex items-center gap-2">
              <span className="text-sm font-medium text-gray-600">Rows:</span>
              <button 
                onClick={() => setGridRows(Math.max(2, gridRows - 1))}
                className="w-8 h-8 bg-white border rounded-lg font-bold"
              >-</button>
              <span className="w-8 text-center font-bold">{gridRows}</span>
              <button 
                onClick={() => setGridRows(Math.min(5, gridRows + 1))}
                className="w-8 h-8 bg-white border rounded-lg font-bold"
              >+</button>
            </div>
            <button
              onClick={() => { setCompartments([]); setSelectedCompartment(null); }}
              className="ml-auto px-3 py-1 text-sm text-red-600 hover:bg-red-50 rounded-lg"
            >
              ğŸ—‘ï¸ Clear All
            </button>
          </div>

          {/* Drawing canvas */}
          <div className="flex justify-center mb-4">
            <div 
              className="bg-gradient-to-br from-amber-100 to-orange-100 rounded-2xl p-3 border-4 border-amber-300"
              onMouseUp={handleMouseUp}
              onMouseLeave={handleMouseUp}
              onTouchEnd={handleTouchEnd}
            >
              <div 
                ref={gridRef}
                className="relative bg-amber-50 rounded-xl touch-none"
                style={{
                  width: gridCols * cellSize + (gridCols + 1) * gap,
                  height: gridRows * cellSize + (gridRows + 1) * gap,
                }}
                onTouchStart={handleTouchStart}
                onTouchMove={handleTouchMove}
              >
                {/* Grid cells */}
                {Array.from({ length: gridRows }).map((_, y) =>
                  Array.from({ length: gridCols }).map((_, x) => (
                    <div
                      key={`${x}-${y}`}
                      className={`absolute rounded cursor-crosshair transition-colors ${
                        isCellOccupied(x, y) ? '' : 'bg-gray-100 hover:bg-gray-200 border-2 border-dashed border-gray-300'
                      }`}
                      style={{
                        left: x * (cellSize + gap) + gap,
                        top: y * (cellSize + gap) + gap,
                        width: cellSize,
                        height: cellSize,
                      }}
                      onMouseDown={() => handleCellMouseDown(x, y)}
                      onMouseEnter={() => handleCellMouseEnter(x, y)}
                    />
                  ))
                )}

                {/* Existing compartments */}
                {compartments.map(comp => {
                  const cat = comp.category ? FOOD_DATABASE[comp.category] : null;
                  return (
                    <div
                      key={comp.id}
                      className={`absolute rounded-lg cursor-pointer transition-all ${
                        selectedCompartment === comp.id ? 'ring-4 ring-purple-400' : ''
                      }`}
                      style={{
                        left: comp.x * (cellSize + gap) + gap,
                        top: comp.y * (cellSize + gap) + gap,
                        width: comp.w * cellSize + (comp.w - 1) * gap,
                        height: comp.h * cellSize + (comp.h - 1) * gap,
                        backgroundColor: cat ? `${cat.color}30` : '#e5e7eb',
                        border: cat ? `3px solid ${cat.color}` : '3px solid #9ca3af',
                      }}
                      onClick={() => setSelectedCompartment(comp.id)}
                    >
                      <div className="w-full h-full flex items-center justify-center">
                        {cat ? (
                          <span className="text-2xl">{cat.emoji}</span>
                        ) : (
                          <span className="text-gray-400 text-sm font-medium">Tap to assign</span>
                        )}
                      </div>
                    </div>
                  );
                })}

                {/* Draw preview */}
                {drawPreview && (
                  <div
                    className="absolute rounded-lg bg-purple-200/50 border-3 border-purple-400 border-dashed pointer-events-none"
                    style={{
                      left: drawPreview.x * (cellSize + gap) + gap,
                      top: drawPreview.y * (cellSize + gap) + gap,
                      width: drawPreview.w * cellSize + (drawPreview.w - 1) * gap,
                      height: drawPreview.h * cellSize + (drawPreview.h - 1) * gap,
                    }}
                  />
                )}
              </div>
            </div>
          </div>

          {/* Instructions or compartment editor */}
          {selectedComp ? (
            <div className="bg-purple-50 rounded-2xl p-4">
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-bold text-purple-800">Assign Food Group</h3>
                <button
                  onClick={() => deleteCompartment(selectedComp.id)}
                  className="text-red-500 hover:bg-red-100 px-3 py-1 rounded-lg text-sm font-medium"
                >
                  ğŸ—‘ï¸ Delete
                </button>
              </div>
              <div className="flex flex-wrap gap-2">
                {Object.entries(FOOD_DATABASE).filter(([key]) => key !== 'water').map(([key, cat]) => {
                  const isUsed = usedCategories.includes(key) && selectedComp.category !== key;
                  return (
                    <button
                      key={key}
                      onClick={() => !isUsed && assignCategory(selectedComp.id, key)}
                      disabled={isUsed}
                      className={`px-3 py-2 rounded-xl flex items-center gap-2 transition-all ${
                        selectedComp.category === key
                          ? 'text-white shadow-lg'
                          : isUsed
                            ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                            : 'bg-white hover:shadow-md'
                      }`}
                      style={{
                        backgroundColor: selectedComp.category === key ? cat.color : undefined,
                      }}
                    >
                      <span>{cat.emoji}</span>
                      <span className="text-sm font-medium">{cat.name}</span>
                      {isUsed && <span className="text-xs">(used)</span>}
                    </button>
                  );
                })}
              </div>
              <p className="text-xs text-purple-600 mt-2">ğŸ’§ Drinks are added separately in their own bottle</p>
            </div>
          ) : (
            <div className="bg-blue-50 rounded-2xl p-4 text-center">
              <p className="text-blue-800">
                <strong>ğŸ‘† Tap and drag</strong> on the grid to draw compartments
              </p>
              <p className="text-blue-600 text-sm mt-1">
                Then tap a compartment to assign a food group
              </p>
            </div>
          )}
        </div>

        <div className="p-4 bg-gray-50 border-t flex gap-3 flex-shrink-0">
          <button
            onClick={onClose}
            className="px-6 py-3 text-gray-600 font-bold hover:bg-gray-200 rounded-xl transition-all"
          >
            Cancel
          </button>
          <button
            onClick={handleSave}
            disabled={compartments.length === 0}
            className="flex-1 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all disabled:opacity-50"
          >
            âœ“ Save Layout
          </button>
        </div>
      </div>
    </div>
  );
};

// Food Selector Modal - appears when tapping a bento compartment

// Emoji picker for custom foods
const FOOD_EMOJIS = [
  // Grains & Carbs
  'ğŸ', 'ğŸ¥–', 'ğŸ¥', 'ğŸ¥¯', 'ğŸ¥¨', 'ğŸ¥ª', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ¥™', 'ğŸ§‡', 'ğŸ¥', 'ğŸ•', 
  'ğŸ', 'ğŸœ', 'ğŸ²', 'ğŸ›', 'ğŸš', 'ğŸ™', 'ğŸ˜', 'ğŸ¥Ÿ', 'ğŸ¥ ', 'ğŸ¥¡',
  // Protein
  'ğŸ¥©', 'ğŸ–', 'ğŸ—', 'ğŸ¥“', 'ğŸŒ­', 'ğŸ”', 'ğŸ³', 'ğŸ¥š', 'ğŸ§†', 'ğŸ¥œ',
  // Dairy
  'ğŸ§€', 'ğŸ¥›', 'ğŸ§ˆ', 'ğŸ¦', 'ğŸ¨', 'ğŸ§', 'ğŸ°',
  // Fruits
  'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸ«', 'ğŸ’', 'ğŸ‘', 'ğŸ¥­', 'ğŸ', 'ğŸ¥', 'ğŸ', 'ğŸ',
  // Vegetables
  'ğŸ¥•', 'ğŸ¥¦', 'ğŸ¥¬', 'ğŸ¥’', 'ğŸŒ½', 'ğŸ«‘', 'ğŸŒ¶ï¸', 'ğŸ…', 'ğŸ¥—', 'ğŸ¥”', 'ğŸ ', 'ğŸ§…', 'ğŸ§„', 'ğŸ¥‘', 'ğŸ«›',
  // Snacks & Sweets
  'ğŸª', 'ğŸ©', 'ğŸ§', 'ğŸ«', 'ğŸ¬', 'ğŸ­', 'ğŸ¿', 'ğŸ¥®', 'ğŸ¯',
  // Drinks
  'ğŸ§ƒ', 'ğŸ¥¤', 'ğŸ§‹', 'â˜•', 'ğŸµ',
  // Other foods
  'ğŸ¥—', 'ğŸ¥£', 'ğŸ«•', 'ğŸ±', 'ğŸ¥«', 'ğŸ«™', 'ğŸ¥œ', 'ğŸŒ°'
];

// Custom Food Modal for adding/editing custom food items
const CustomFoodModal = ({ category, editItem, onSave, onClose }) => {
  const [name, setName] = useState(editItem?.name || '');
  const [emoji, setEmoji] = useState(editItem?.emoji || FOOD_EMOJIS[0]);
  const [showEmojiPicker, setShowEmojiPicker] = useState(false);
  
  const catData = FOOD_DATABASE[category];
  const categoryPointValue = CATEGORY_POINTS[category] || 0;
  
  const handleSave = () => {
    if (!name.trim()) return;
    
    onSave({
      id: editItem?.id || `custom-${Date.now()}`,
      name: name.trim(),
      emoji: emoji,
      isCustom: true,
      points: categoryPointValue
    });
    onClose();
  };
  
  return (
    <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-[60] p-4" onClick={onClose}>
      <div 
        className="bg-white rounded-3xl shadow-2xl w-full max-w-sm overflow-hidden"
        onClick={(e) => e.stopPropagation()}
      >
        {/* Header */}
        <div 
          className="p-4 text-white"
          style={{ background: `linear-gradient(135deg, ${catData.color}, ${catData.color}cc)` }}
        >
          <div className="flex items-center justify-between">
            <h2 className="text-lg font-bold">
              {editItem ? 'âœï¸ Edit Item' : 'â• Add Custom Item'}
            </h2>
            <button onClick={onClose} className="p-1 hover:bg-white/20 rounded-full">âœ•</button>
          </div>
          <p className="text-white/80 text-sm mt-1">to {catData.name}</p>
        </div>
        
        {/* Form */}
        <div className="p-4 space-y-4">
          {/* Emoji selector */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Icon</label>
            <button
              onClick={() => setShowEmojiPicker(!showEmojiPicker)}
              className="w-full p-3 border-2 border-gray-200 rounded-xl flex items-center justify-between hover:border-gray-300 transition-all"
            >
              <span className="text-3xl">{emoji}</span>
              <span className="text-gray-400 text-sm">Tap to change</span>
            </button>
            
            {showEmojiPicker && (
              <div className="mt-2 p-3 bg-gray-50 rounded-xl border max-h-40 overflow-y-auto">
                <div className="grid grid-cols-8 gap-1">
                  {FOOD_EMOJIS.map((e, i) => (
                    <button
                      key={i}
                      onClick={() => { setEmoji(e); setShowEmojiPicker(false); }}
                      className={`text-2xl p-1 rounded hover:bg-gray-200 transition-all ${emoji === e ? 'bg-orange-100 ring-2 ring-orange-400' : ''}`}
                    >
                      {e}
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>
          
          {/* Name input */}
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Name</label>
            <input
              type="text"
              value={name}
              onChange={(e) => setName(e.target.value)}
              placeholder="e.g., Pasta Bolognese"
              className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-400 focus:outline-none text-lg"
              autoFocus
            />
          </div>
          
          {/* Points info */}
          <div className="bg-gray-50 rounded-xl p-3 text-center">
            <span className="text-gray-600 text-sm">
              This item will earn <span className="font-bold text-orange-500">{categoryPointValue >= 0 ? '+' : ''}{categoryPointValue} pts</span>
            </span>
          </div>
        </div>
        
        {/* Footer */}
        <div className="p-4 bg-gray-50 border-t flex gap-3">
          <button
            onClick={onClose}
            className="flex-1 py-3 text-gray-600 font-bold hover:bg-gray-200 rounded-xl transition-all"
          >
            Cancel
          </button>
          <button
            onClick={handleSave}
            disabled={!name.trim()}
            className="flex-1 py-3 text-white font-bold rounded-xl shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            style={{ background: name.trim() ? `linear-gradient(135deg, ${catData.color}, ${catData.color}cc)` : '#ccc' }}
          >
            {editItem ? 'Save' : 'Add Item'}
          </button>
        </div>
      </div>
    </div>
  );
};

const FoodSelectorModal = ({ category, child, selectedItems, onSelect, onClose, dietaryFilter, checkDietaryConflict, customFoods, onAddCustomFood, onEditCustomFood, onDeleteCustomFood }) => {
  const catData = FOOD_DATABASE[category];
  const [localSelection, setLocalSelection] = useState(selectedItems || []);
  const [showCustomModal, setShowCustomModal] = useState(false);
  const [editingCustomItem, setEditingCustomItem] = useState(null);
  
  // Get custom foods for this category
  const categoryCustomFoods = customFoods?.[category] || [];
  
  // Apply dietary filter to items and combine with custom foods
  const filteredItems = dietaryFilter ? dietaryFilter(catData.items) : catData.items;
  const allItems = [...categoryCustomFoods, ...filteredItems];
  
  // Max items: drinks=1, sweets based on points (reward system!), others=3
  const getMaxItems = () => {
    if (category === 'water') return 1;
    if (category === 'sweets') return getMaxSweetsForChild(child);
    return 3;
  };
  const maxItems = getMaxItems();
  const maxSweetsForReward = category === 'sweets' ? getMaxSweetsForChild(child) : null;
  
  // Get points for this category
  const categoryPointValue = CATEGORY_POINTS[category] || 0;
  
  // Check if item is a disliked food (for bonus messaging)
  const isDisliked = (item) => child?.dislikes?.includes(item.id);
  
  // Check if item conflicts with dietary preference
  const hasDietaryConflict = (item) => checkDietaryConflict ? checkDietaryConflict(item) : false;
  
  // Get display points for an item
  const getItemPoints = (item) => {
    let pts = category === 'water' ? (DRINK_POINTS[item.id] || 5) : categoryPointValue;
    if (isDisliked(item)) pts += 25;
    return pts;
  };

  const isItemDisabled = (item) => {
    if (!child) return false;
    if (item.allergens?.some(a => child.allergens?.includes(a))) return true;
    // Don't disable dislikes - let kids try them for bonus points!
    return false;
  };

  const toggleItem = (item) => {
    setLocalSelection(prev => {
      const exists = prev.find(i => i.id === item.id);
      if (exists) {
        return prev.filter(i => i.id !== item.id);
      }
      // Check if at max capacity
      if (prev.length >= maxItems) {
        // For single item (drinks), replace the current selection
        if (maxItems === 1) {
          return [item];
        }
        // For multiple items, don't add more
        return prev;
      }
      return [...prev, item];
    });
  };

  const handleDone = () => {
    onSelect(category, localSelection);
    onClose();
  };

  const atMaxCapacity = localSelection.length >= maxItems;

  return (
    <div className="fixed inset-0 bg-black/50 flex items-end sm:items-center justify-center z-50" onClick={onClose}>
      <div 
        className="bg-white rounded-t-3xl sm:rounded-3xl shadow-2xl w-full sm:max-w-md flex flex-col"
        onClick={(e) => e.stopPropagation()}
        style={{
          maxHeight: '85vh',
          animation: 'slideUp 0.3s ease-out'
        }}
      >
        <style>{`
          @keyframes slideUp {
            from {
              transform: translateY(100%);
              opacity: 0;
            }
            to {
              transform: translateY(0);
              opacity: 1;
            }
          }
        `}</style>
        {/* Header - Fixed */}
        <div 
          className="p-4 text-white flex-shrink-0 rounded-t-3xl"
          style={{ background: `linear-gradient(135deg, ${catData.color}, ${catData.color}cc)` }}
        >
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <span className="text-4xl">{catData.emoji}</span>
              <div>
                <h2 className="text-xl font-bold">{catData.name}</h2>
                <p className="text-white/80 text-sm">
                  {localSelection.length}/{maxItems} selected {atMaxCapacity && '(max)'}
                </p>
              </div>
            </div>
            {/* Points badge in header */}
            <div className="flex items-center gap-2">
              <div className={`px-2 py-1 rounded-full text-sm font-bold ${
                categoryPointValue >= 0 
                  ? 'bg-white/20 text-white'
                  : 'bg-pink-200 text-pink-800'
              }`}>
                {category === 'water' ? 'See drink pts' : `${categoryPointValue >= 0 ? '+' : ''}${categoryPointValue} pts`}
              </div>
              <button
                onClick={onClose}
                className="p-2 hover:bg-white/20 rounded-full transition-all"
              >
                âœ•
              </button>
            </div>
          </div>
        </div>

        {/* Selected items preview - Collapsible section */}
        {localSelection.length > 0 && (
          <div className="p-3 bg-gray-50 border-b flex-shrink-0">
            <div className="flex flex-wrap gap-2">
              {localSelection.map(item => (
                <span 
                  key={item.id}
                  className="px-3 py-1 rounded-full text-sm font-medium text-white flex items-center gap-1"
                  style={{ backgroundColor: catData.color }}
                >
                  {item.emoji} {item.name}
                  <button 
                    onClick={() => toggleItem(item)}
                    className="ml-1 hover:bg-white/20 rounded-full"
                  >
                    âœ•
                  </button>
                </span>
              ))}
            </div>
          </div>
        )}

        {/* Sweets reward info - only for sweets category */}
        {category === 'sweets' && (
          <div className="px-4 py-2 border-b bg-gradient-to-r from-pink-50 to-rose-50 text-pink-700 text-xs flex-shrink-0">
            ğŸ† {child?.name || 'Child'} has earned {maxSweetsForReward} treat{maxSweetsForReward !== 1 ? 's' : ''} 
            {(child?.points || 0) < 500 && (
              <span className="opacity-70 ml-1">
                (Next reward at {(child?.points || 0) < 50 ? '50' : (child?.points || 0) < 200 ? '200' : '500'} pts!)
              </span>
            )}
          </div>
        )}

        {/* Custom Food Modal */}
        {showCustomModal && (
          <CustomFoodModal
            category={category}
            editItem={editingCustomItem}
            onSave={(item) => {
              if (editingCustomItem) {
                onEditCustomFood(category, item);
              } else {
                onAddCustomFood(category, item);
              }
              setEditingCustomItem(null);
            }}
            onClose={() => { setShowCustomModal(false); setEditingCustomItem(null); }}
          />
        )}

        {/* Food options grid - Scrollable */}
        <div className="flex-1 overflow-y-auto min-h-0 p-4">
          {/* Add Custom Item Button */}
          <button
            onClick={() => { setEditingCustomItem(null); setShowCustomModal(true); }}
            className="w-full mb-4 p-3 border-2 border-dashed border-gray-300 rounded-2xl flex items-center justify-center gap-2 text-gray-500 hover:border-orange-400 hover:text-orange-500 hover:bg-orange-50 transition-all"
          >
            <span className="text-xl">â•</span>
            <span className="font-medium">Add Custom Item</span>
          </button>

          <div className="grid grid-cols-3 gap-3">
            {allItems.map(item => {
              const allergenDisabled = isItemDisabled(item);
              const selected = localSelection.find(i => i.id === item.id);
              const capacityDisabled = atMaxCapacity && !selected;
              const disabled = allergenDisabled || capacityDisabled;
              const itemIsDisliked = isDisliked(item);
              const itemHasDietaryConflict = hasDietaryConflict(item);
              
              return (
                <button
                  key={item.id}
                  onClick={() => !disabled && toggleItem(item)}
                  disabled={disabled}
                  className={`p-3 rounded-2xl transition-all relative ${
                    allergenDisabled
                      ? 'opacity-30 cursor-not-allowed bg-gray-100'
                      : capacityDisabled
                        ? 'opacity-50 cursor-not-allowed bg-gray-50'
                        : selected
                          ? 'shadow-lg text-white'
                          : itemHasDietaryConflict
                            ? 'bg-red-50 hover:bg-red-100 hover:shadow-md ring-2 ring-red-300'
                            : itemIsDisliked
                              ? 'bg-orange-50 hover:bg-orange-100 hover:shadow-md ring-2 ring-orange-300'
                              : 'bg-gray-50 hover:bg-gray-100 hover:shadow-md'
                  }`}
                  style={{
                    background: selected && !allergenDisabled ? catData.color : undefined
                  }}
                >
                  {/* Dietary conflict badge */}
                  {itemHasDietaryConflict && !selected && (
                    <div className="absolute -top-1 -right-1 px-1.5 py-0.5 bg-gradient-to-r from-red-400 to-rose-500 text-white text-xs font-bold rounded-full shadow" title="Conflicts with dietary preference">
                      âš ï¸
                    </div>
                  )}
                  
                  {/* Brave badge for disliked items - shows bonus */}
                  {itemIsDisliked && !selected && !itemHasDietaryConflict && (
                    <div className="absolute -top-1 -left-1 px-1 py-0.5 bg-gradient-to-r from-orange-400 to-amber-500 text-white text-xs font-bold rounded-full shadow">
                      +25
                    </div>
                  )}
                  
                  {selected && (
                    <div className="absolute top-1 left-1 w-5 h-5 bg-white rounded-full flex items-center justify-center shadow-md border-2 border-green-500">
                      <span className="text-green-500 text-xs font-bold">âœ“</span>
                    </div>
                  )}
                  <div className="text-3xl mb-1">{item.emoji}</div>
                  <div className={`text-xs font-bold leading-tight ${selected ? 'text-white' : 'text-gray-700'}`}>
                    {item.name}
                  </div>
                  {allergenDisabled && (
                    <div className="text-xs text-red-500 font-medium mt-1">
                      âš ï¸ Allergen
                    </div>
                  )}
                  {/* Edit/Delete for custom items */}
                  {item.isCustom && !selected && (
                    <div className="absolute top-1 right-1 flex gap-1">
                      <button
                        onClick={(e) => { e.stopPropagation(); setEditingCustomItem(item); setShowCustomModal(true); }}
                        className="w-6 h-6 bg-white/90 hover:bg-blue-100 rounded-full flex items-center justify-center shadow text-xs"
                      >
                        âœï¸
                      </button>
                      <button
                        onClick={(e) => { 
                          e.stopPropagation(); 
                          if (confirm('Delete ' + item.name + '?')) {
                            onDeleteCustomFood(category, item.id);
                          }
                        }}
                        className="w-6 h-6 bg-white/90 hover:bg-red-100 rounded-full flex items-center justify-center shadow text-xs"
                      >
                        ğŸ—‘ï¸
                      </button>
                    </div>
                  )}
                </button>
              );
            })}
          </div>
        </div>

        {/* Footer - Fixed */}
        <div className="p-4 bg-gray-50 border-t flex gap-3 flex-shrink-0 safe-bottom">
          <button
            onClick={() => { setLocalSelection([]); }}
            className="px-4 py-3 text-gray-600 font-bold hover:bg-gray-200 rounded-xl transition-all"
          >
            Clear
          </button>
          <button
            onClick={handleDone}
            className="flex-1 py-3 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all"
            style={{ background: `linear-gradient(135deg, ${catData.color}, ${catData.color}cc)` }}
          >
            âœ“ Done ({localSelection.length})
          </button>
        </div>
      </div>
    </div>
  );
};

// Interactive Bento Box for Planning
const InteractiveBentoBox = ({ selections, day, child, onSelectCategory, onSave, onBack, onSurpriseMe, layout, manualComplete, onToggleManualComplete }) => {
  const getTotalItems = () => {
    return Object.values(selections).reduce((sum, arr) => sum + (arr?.length || 0), 0);
  };

  const getFilledGroups = () => {
    return Object.values(selections).filter(arr => arr?.length > 0).length;
  };
  
  // Calculate running points tally
  const getPointsBreakdown = () => {
    let total = 0;
    const breakdown = [];
    
    Object.entries(selections).forEach(([category, items]) => {
      if (items && Array.isArray(items) && items.length > 0) {
        const catData = FOOD_DATABASE[category];
        let catTotal = 0;
        
        if (category === 'water') {
          items.forEach(item => { catTotal += DRINK_POINTS[item.id] || 5; });
        } else {
          catTotal = CATEGORY_POINTS[category] || 0;
        }
        
        let dislikedBonus = 0;
        items.forEach(item => {
          if (child?.dislikes?.includes(item.id)) dislikedBonus += 25;
        });
        
        if (catTotal !== 0 || dislikedBonus > 0) {
          breakdown.push({
            category,
            name: catData?.name || category,
            emoji: catData?.emoji || 'ğŸ½ï¸',
            count: items.length,
            subtotal: catTotal,
            dislikedBonus
          });
        }
        total += catTotal + dislikedBonus;
      }
    });
    
    return { total, breakdown };
  };
  
  const pointsInfo = getPointsBreakdown();

  // Get available categories for this child (accounting for allergens)
  const availableCategories = getAvailableCategoriesForChild(child);
  
  // Count how many layout compartments have available categories (plus drink)
  const layoutCategories = layout.compartments.map(c => c.category).filter(Boolean);
  const fillableCount = layoutCategories.filter(cat => availableCategories[cat]).length + (availableCategories['water'] ? 1 : 0);
  
  // Check filled groups including drink
  const bentoFilledGroups = layoutCategories.filter(cat => availableCategories[cat] && selections[cat]?.length > 0).length;
  const drinkFilled = selections['water']?.length > 0 ? 1 : 0;
  const totalFilledGroups = bentoFilledGroups + drinkFilled;
  
  // Check if complete (all fillable categories in layout are filled, plus drink)
  const bentoComplete = layout.compartments.every(comp => {
    if (!comp.category) return true;
    if (!availableCategories[comp.category]) return true;
    return selections[comp.category]?.length > 0;
  });
  const drinkComplete = !availableCategories['water'] || selections['water']?.length > 0;
  const autoComplete = bentoComplete && drinkComplete;
  
  // Manual override - user says lunchbox is full even if not all compartments filled
  const isComplete = autoComplete || manualComplete;
  const hasAnyItems = getTotalItems() > 0;

  // Calculate percentage-based positioning for compartments
  const getCompartmentStyle = (comp) => {
    const gapPercent = 1.5;
    const cellWidthPercent = (100 - (layout.gridCols + 1) * gapPercent) / layout.gridCols;
    const cellHeightPercent = (100 - (layout.gridRows + 1) * gapPercent) / layout.gridRows;
    
    return {
      left: `${gapPercent + comp.x * (cellWidthPercent + gapPercent)}%`,
      top: `${gapPercent + comp.y * (cellHeightPercent + gapPercent)}%`,
      width: `${comp.w * cellWidthPercent + (comp.w - 1) * gapPercent}%`,
      height: `${comp.h * cellHeightPercent + (comp.h - 1) * gapPercent}%`,
    };
  };

  const BentoCompartment = ({ compartment }) => {
    const { category } = compartment;
    if (!category) return null;
    
    const catData = FOOD_DATABASE[category];
    const items = selections[category] || [];
    const hasItems = items.length > 0;
    const isAvailable = availableCategories[category];
    const style = getCompartmentStyle(compartment);
    
    return (
      <button 
        onClick={() => isAvailable && onSelectCategory(category)}
        disabled={!isAvailable}
        className={`absolute rounded-xl overflow-hidden transition-all group flex flex-col ${
          !isAvailable ? 'opacity-50 cursor-not-allowed' : 'hover:shadow-lg active:scale-[0.99]'
        }`}
        style={{
          ...style,
          backgroundColor: hasItems ? '#ffffff' : !isAvailable ? '#f0f0f0' : '#fafafa',
          border: hasItems ? `3px dashed ${catData.color}` : !isAvailable ? '3px solid #ddd' : '3px dashed #ccc',
        }}
      >
        {/* Category header */}
        <div 
          className="flex items-center justify-between px-2 py-1 flex-shrink-0"
          style={{ backgroundColor: hasItems ? `${catData.color}15` : 'transparent' }}
        >
          <div className="flex items-center gap-1 min-w-0">
            <span className="text-base flex-shrink-0">{catData.emoji}</span>
            <span className="font-bold text-gray-700 text-xs truncate">{catData.name}</span>
          </div>
          {hasItems && (
            <span 
              className="w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold text-white flex-shrink-0 ml-1"
              style={{ backgroundColor: catData.color }}
            >
              {items.length}
            </span>
          )}
        </div>

        {/* Unavailable overlay */}
        {!isAvailable && (
          <div className="absolute inset-0 flex items-center justify-center bg-gray-100/90 z-10">
            <div className="text-center">
              <span className="text-2xl">ğŸš«</span>
              <p className="text-xs font-medium text-gray-500">
                {getCategoryRestrictionReason(category, child) || 'Restricted'}
              </p>
            </div>
          </div>
        )}

        {/* Content area - shows items or placeholder */}
        <div className="flex-1 px-1.5 py-1 overflow-y-auto min-h-0">
          {hasItems ? (
            <div className="flex flex-col gap-0.5">
              {items.map((item, idx) => (
                <div 
                  key={idx}
                  className="flex items-center gap-1 bg-gray-50 rounded px-1.5 py-0.5 shadow-sm"
                >
                  <span className="text-sm flex-shrink-0">{item.emoji}</span>
                  <span className="text-xs font-medium text-gray-700 truncate">{item.name}</span>
                </div>
              ))}
            </div>
          ) : isAvailable ? (
            <div className="h-full flex items-center justify-center">
              <span className="text-sm text-gray-300 font-medium group-hover:text-gray-400 transition-colors">
                Tap to add
              </span>
            </div>
          ) : null}
        </div>
      </button>
    );
  };

  // Drink Bottle Component
  const DrinkBottle = () => {
    const drinkData = FOOD_DATABASE.water;
    const drinkItems = selections['water'] || [];
    const hasDrink = drinkItems.length > 0;
    const isAvailable = availableCategories['water'];

    return (
      <button
        onClick={() => isAvailable && onSelectCategory('water')}
        disabled={!isAvailable}
        className={`relative flex-1 flex flex-col items-center transition-all w-20 ${
          !isAvailable ? 'opacity-50 cursor-not-allowed' : 'hover:scale-[1.02] active:scale-[0.98]'
        }`}
      >
        {/* Bottle cap */}
        <div 
          className="w-10 h-5 rounded-t-lg flex-shrink-0"
          style={{ backgroundColor: hasDrink ? drinkData.color : '#ccc' }}
        />
        
        {/* Bottle body - fills available space */}
        <div 
          className={`w-16 flex-1 rounded-b-3xl flex flex-col items-center justify-center transition-all relative overflow-hidden ${
            hasDrink ? 'bg-white' : 'bg-gray-50'
          }`}
          style={{ 
            borderWidth: '3px',
            borderStyle: 'dashed',
            borderColor: hasDrink ? drinkData.color : '#ccc',
            borderTopWidth: 0,
            minHeight: '120px',
          }}
        >
          {/* Water fill level */}
          {hasDrink && (
            <div 
              className="absolute bottom-0 left-0 right-0 opacity-25 rounded-b-3xl"
              style={{ 
                backgroundColor: drinkData.color,
                height: '70%',
              }}
            />
          )}
          
          {hasDrink ? (
            <div className="relative z-10 text-center">
              <span className="text-3xl">{drinkItems[0].emoji}</span>
              <p className="text-xs font-medium text-gray-700 mt-2 px-1 leading-tight">
                {drinkItems[0].name}
              </p>
            </div>
          ) : isAvailable ? (
            <div className="text-center">
              <p className="text-sm text-gray-300 font-medium">Tap to add</p>
            </div>
          ) : (
            <div className="text-center">
              <span className="text-3xl">ğŸš«</span>
              <p className="text-xs text-gray-500 mt-1">Allergen</p>
            </div>
          )}
        </div>
      </button>
    );
  };

  return (
    <div className="max-w-4xl mx-auto">
      {/* Header */}
      <div className="flex items-center justify-between mb-3 flex-wrap gap-2">
        <div className="flex items-center gap-3">
          <button
            onClick={onBack}
            className="p-2 hover:bg-white/50 rounded-xl transition-all text-gray-600"
          >
            â† Back
          </button>
          <div>
            <h2 className="text-xl font-bold text-gray-800">{day}</h2>
            {child && <p className="text-sm text-gray-500">Planning for {child.name}</p>}
          </div>
        </div>
        <div className="flex gap-2">
          <button
            onClick={onSurpriseMe}
            className="px-3 py-2 bg-gradient-to-r from-purple-400 to-pink-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center gap-2 text-sm"
          >
            ğŸ² Surprise!
          </button>
          <button
            onClick={() => onSave()}
            className={`px-4 py-2 font-bold rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center gap-2 text-sm ${
              isComplete 
                ? 'bg-gradient-to-r from-green-400 to-emerald-500 text-white' 
                : 'bg-gradient-to-r from-orange-400 to-pink-500 text-white'
            }`}
          >
            {isComplete ? 'âœ“ Complete!' : 'ğŸ’¾ Save'}
          </button>
        </div>
      </div>

      {/* Progress bar */}
      <div className="bg-white/60 backdrop-blur-sm rounded-xl p-3 mb-3 shadow-md">
        <div className="flex justify-between items-center text-sm font-medium text-gray-600 mb-1">
          <span>ğŸ¯ Fill each compartment + drink</span>
          <div className="flex items-center gap-3">
            <span>
              {totalFilledGroups}/{fillableCount} groups â€¢ {getTotalItems()} items
            </span>
            {/* Manual complete toggle - only show if not auto-complete and has items */}
            {!autoComplete && hasAnyItems && (
              <button
                onClick={onToggleManualComplete}
                className={`px-2 py-1 rounded-lg text-xs font-bold transition-all ${
                  manualComplete
                    ? 'bg-green-500 text-white'
                    : 'bg-gray-200 text-gray-600 hover:bg-gray-300'
                }`}
              >
                {manualComplete ? 'âœ“ Marked full' : 'ğŸ“¦ Mark as full'}
              </button>
            )}
          </div>
        </div>
        <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
          <div
            className={`h-full transition-all duration-500 ${
              isComplete 
                ? 'bg-gradient-to-r from-green-400 to-emerald-500' 
                : 'bg-gradient-to-r from-orange-400 to-pink-500'
            }`}
            style={{ width: `${isComplete ? 100 : (totalFilledGroups / Math.max(1, fillableCount)) * 100}%` }}
          />
        </div>
      </div>
      
      {/* Points Tally */}
      {hasAnyItems && (
        <div className={`rounded-xl p-3 mb-3 shadow-md ${
          pointsInfo.total >= 0 
            ? 'bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200'
            : 'bg-gradient-to-r from-pink-50 to-rose-50 border border-pink-200'
        }`}>
          <div className="flex items-center justify-between">
            <span className={`text-2xl font-black ${pointsInfo.total >= 0 ? 'text-green-600' : 'text-pink-600'}`}>
              {pointsInfo.total >= 0 ? '+' : ''}{pointsInfo.total} points
            </span>
            {child && (
              <span className="text-sm text-gray-600">
                {child.name}: {child.points || 0} â†’ {Math.max(0, (child.points || 0) + pointsInfo.total)}
              </span>
            )}
          </div>
        </div>
      )}

      {/* Bento Box */}
      <div className="bg-gradient-to-br from-amber-100 to-orange-100 rounded-2xl p-3 shadow-xl border-4 border-amber-300">
        <div className="flex items-center justify-between mb-2">
          <h3 className="font-bold text-amber-800 flex items-center gap-2 text-sm">
            ğŸ± Tap a section to add food!
          </h3>
          <div className="flex items-center gap-1.5 text-xs text-amber-700">
            <span>{layout.preview}</span>
            <span className="font-medium">{layout.name}</span>
          </div>
        </div>
        
        {/* Bento box grid */}
        <div 
          className="relative bg-white rounded-xl w-full"
          style={{ 
            height: 'min(45vh, 350px)',
            boxShadow: 'inset 0 2px 8px rgba(0,0,0,0.05)'
          }}
        >
          {layout.compartments.map(comp => (
            <BentoCompartment key={comp.id} compartment={comp} />
          ))}
        </div>
      </div>

      {/* Drink Bottle - Horizontal below bento */}
      <div className="mt-3 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-2xl p-3 shadow-xl border-4 border-blue-200">
        <button
          onClick={() => availableCategories['water'] && onSelectCategory('water')}
          disabled={!availableCategories['water']}
          className={`w-full flex items-center gap-3 p-2 rounded-xl transition-all ${
            !availableCategories['water'] ? 'opacity-50' : 'hover:bg-white/50'
          } ${(selections['water']?.length > 0) ? 'bg-white' : 'bg-white/30'}`}
        >
          <div className="w-12 h-12 rounded-xl flex items-center justify-center text-2xl"
               style={{ backgroundColor: (selections['water']?.length > 0) ? '#74B9FF20' : '#f3f4f6' }}>
            {(selections['water']?.length > 0) ? selections['water'][0].emoji : 'ğŸ’§'}
          </div>
          <div className="flex-1 text-left">
            {(selections['water']?.length > 0) ? (
              <>
                <p className="font-bold text-gray-800">{selections['water'][0].name}</p>
                <p className="text-xs text-gray-500">Tap to change</p>
              </>
            ) : availableCategories['water'] ? (
              <>
                <p className="font-medium text-gray-600">Add a drink</p>
                <p className="text-xs text-gray-400">Tap to select</p>
              </>
            ) : (
              <p className="text-gray-400">No drinks available</p>
            )}
          </div>
          <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
            (selections['water']?.length > 0) ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'
          }`}>
            {(selections['water']?.length > 0) ? 'âœ“' : '+'}
          </div>
        </button>
      </div>

      {/* Layout info */}
      <div className="mt-3 text-center">
        <p className="text-xs text-gray-500">
          ğŸ’¡ Change {child?.name || 'your child'}'s lunchbox layout in their profile
        </p>
      </div>
    </div>
  );
};

// Bento Box Lunchbox Preview Component
const LunchboxPreview = ({ selections, day }) => {
  const getTotalItems = () => {
    return Object.values(selections).reduce((sum, arr) => sum + (arr?.length || 0), 0);
  };

  const getCategoriesWithItems = () => {
    return Object.keys(selections).filter(cat => selections[cat]?.length > 0).length;
  };

  const BentoCompartment = ({ category, items, className, style }) => {
    const catData = FOOD_DATABASE[category];
    const hasItems = items && items.length > 0;
    
    return (
      <div 
        className={`relative rounded-xl overflow-hidden transition-all ${className}`}
        style={{
          backgroundColor: hasItems ? `${catData.color}15` : '#f5f5f5',
          border: hasItems ? `2px solid ${catData.color}40` : '2px dashed #ddd',
          ...style
        }}
      >
        {hasItems ? (
          <div className="h-full p-1.5 flex flex-col gap-0.5 overflow-y-auto">
            {items.map((item, idx) => (
              <div 
                key={idx} 
                className="flex items-center gap-1 bg-white/80 rounded px-1.5 py-0.5 shadow-sm flex-shrink-0"
              >
                <span className="text-sm">{item.emoji}</span>
                <span className="text-xs font-medium text-gray-600 truncate">
                  {item.name}
                </span>
              </div>
            ))}
          </div>
        ) : (
          <div className="h-full flex flex-col items-center justify-center text-gray-400">
            <span className="text-xl opacity-40">{catData.emoji}</span>
            <span className="text-xs font-medium mt-0.5">{catData.name}</span>
          </div>
        )}
        
        {/* Category label */}
        <div 
          className="absolute top-1 right-1 w-5 h-5 rounded-full flex items-center justify-center text-xs"
          style={{ 
            backgroundColor: hasItems ? catData.color : '#ccc',
            color: 'white'
          }}
        >
          {items?.length || 0}
        </div>
      </div>
    );
  };

  return (
    <div className="bg-gradient-to-br from-amber-100 to-orange-100 rounded-3xl p-4 shadow-lg border-4 border-amber-300">
      {/* Bento box lid label */}
      <div className="flex items-center justify-between mb-3">
        <h3 className="font-bold text-lg text-amber-800 flex items-center gap-2">
          ğŸ± {day}'s Bento
        </h3>
        <span className="text-sm font-medium text-amber-600">
          {getTotalItems()} items â€¢ {getCategoriesWithItems()}/6 groups
        </span>
      </div>
      
      {/* Bento Box Container */}
      <div 
        className="bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl p-2 shadow-inner"
        style={{ 
          boxShadow: 'inset 0 2px 8px rgba(0,0,0,0.1), 0 4px 12px rgba(0,0,0,0.1)'
        }}
      >
        {/* Bento Grid Layout */}
        <div className="grid gap-2" style={{ 
          gridTemplateColumns: '1fr 1fr',
          gridTemplateRows: 'auto auto auto',
          minHeight: '280px'
        }}>
          {/* Top row - Grains (large, spans full width) */}
          <BentoCompartment 
            category="grains" 
            items={selections.grains}
            className="col-span-2 min-h-16"
          />
          
          {/* Middle row - Protein and Dairy */}
          <BentoCompartment 
            category="protein" 
            items={selections.protein}
            className="min-h-20"
          />
          <BentoCompartment 
            category="dairy" 
            items={selections.dairy}
            className="min-h-20"
          />
          
          {/* Bottom row - Fruit, Veggies, and Water */}
          <div className="col-span-2 grid grid-cols-3 gap-2">
            <BentoCompartment 
              category="fruit" 
              items={selections.fruit}
              className="min-h-20"
            />
            <BentoCompartment 
              category="vegetables" 
              items={selections.vegetables}
              className="min-h-20"
            />
            <BentoCompartment 
              category="water" 
              items={selections.water}
              className="min-h-20"
            />
          </div>
        </div>
      </div>
      
      {/* Chopsticks decoration */}
      <div className="flex justify-end mt-2 pr-2">
        <div className="flex gap-1">
          <div className="w-1 h-16 bg-gradient-to-b from-amber-600 to-amber-800 rounded-full transform rotate-12 origin-bottom"></div>
          <div className="w-1 h-16 bg-gradient-to-b from-amber-600 to-amber-800 rounded-full transform -rotate-6 origin-bottom"></div>
        </div>
      </div>
    </div>
  );
};

// Bento View Modal - for viewing completed lunchbox
const BentoViewModal = ({ selections, day, childName, layout, onClose }) => {
  const getTotalItems = () => {
    return Object.values(selections).reduce((sum, arr) => sum + (arr?.length || 0), 0);
  };

  // Calculate percentage-based positioning for compartments
  const getCompartmentStyle = (comp) => {
    const gapPercent = 1.5;
    const cellWidthPercent = (100 - (layout.gridCols + 1) * gapPercent) / layout.gridCols;
    const cellHeightPercent = (100 - (layout.gridRows + 1) * gapPercent) / layout.gridRows;
    
    return {
      left: `${gapPercent + comp.x * (cellWidthPercent + gapPercent)}%`,
      top: `${gapPercent + comp.y * (cellHeightPercent + gapPercent)}%`,
      width: `${comp.w * cellWidthPercent + (comp.w - 1) * gapPercent}%`,
      height: `${comp.h * cellHeightPercent + (comp.h - 1) * gapPercent}%`,
    };
  };

  const BentoCompartment = ({ compartment }) => {
    const { category } = compartment;
    if (!category) return null;
    
    const catData = FOOD_DATABASE[category];
    const items = selections[category] || [];
    const hasItems = items.length > 0;
    const style = getCompartmentStyle(compartment);
    
    return (
      <div 
        className="absolute rounded-xl overflow-hidden flex flex-col bg-white"
        style={{
          ...style,
          border: `3px dashed ${hasItems ? catData.color : '#ccc'}`,
        }}
      >
        {/* Category header */}
        <div 
          className="flex items-center justify-between px-2 py-1 flex-shrink-0"
          style={{ backgroundColor: hasItems ? `${catData.color}15` : 'transparent' }}
        >
          <div className="flex items-center gap-1 min-w-0">
            <span className="text-base flex-shrink-0">{catData.emoji}</span>
            <span className="font-bold text-gray-700 text-xs truncate">{catData.name}</span>
          </div>
          {hasItems && (
            <span 
              className="w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold text-white flex-shrink-0 ml-1"
              style={{ backgroundColor: catData.color }}
            >
              {items.length}
            </span>
          )}
        </div>

        {/* Content area */}
        <div className="flex-1 px-1.5 py-1 overflow-y-auto min-h-0">
          {hasItems ? (
            <div className="flex flex-col gap-0.5">
              {items.map((item, idx) => (
                <div 
                  key={idx}
                  className="flex items-center gap-1 bg-gray-50 rounded px-1.5 py-0.5 shadow-sm"
                >
                  <span className="text-sm flex-shrink-0">{item.emoji}</span>
                  <span className="text-xs font-medium text-gray-700 truncate">{item.name}</span>
                </div>
              ))}
            </div>
          ) : (
            <div className="h-full flex items-center justify-center text-gray-400">
              <span className="text-xl opacity-30">{catData.emoji}</span>
            </div>
          )}
        </div>
      </div>
    );
  };

  // Drink Bottle Display
  const DrinkBottleDisplay = () => {
    const drinkData = FOOD_DATABASE.water;
    const drinkItems = selections['water'] || [];
    const hasDrink = drinkItems.length > 0;

    return (
      <div className="flex-1 flex flex-col items-center w-16">
        {/* Bottle cap */}
        <div 
          className="w-8 h-4 rounded-t-lg flex-shrink-0"
          style={{ backgroundColor: hasDrink ? drinkData.color : '#ccc' }}
        />
        
        {/* Bottle body - fills available space */}
        <div 
          className="w-14 flex-1 rounded-b-2xl flex flex-col items-center justify-center bg-white relative overflow-hidden"
          style={{ 
            borderWidth: '3px',
            borderStyle: 'dashed',
            borderColor: hasDrink ? drinkData.color : '#ccc',
            borderTopWidth: 0,
            minHeight: '100px',
          }}
        >
          {hasDrink && (
            <div 
              className="absolute bottom-0 left-0 right-0 rounded-b-xl opacity-25"
              style={{ backgroundColor: drinkData.color, height: '70%' }}
            />
          )}
          
          {hasDrink ? (
            <div className="relative z-10 text-center">
              <span className="text-2xl">{drinkItems[0].emoji}</span>
              <p className="text-xs font-medium text-gray-700 mt-1 px-1 leading-tight">
                {drinkItems[0].name}
              </p>
            </div>
          ) : (
            <span className="text-2xl text-gray-300">ğŸ’§</span>
          )}
        </div>
      </div>
    );
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
      <div className="bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl shadow-2xl w-full max-w-2xl">
        {/* Header */}
        <div className="bg-gradient-to-r from-orange-400 to-pink-500 p-4 text-white rounded-t-2xl">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-xl font-bold flex items-center gap-2">
                ğŸ± {day}'s Lunchbox
              </h2>
              {childName && <p className="text-white/80 text-sm">Packed for {childName}</p>}
            </div>
            <div className="text-right bg-white/20 rounded-xl px-3 py-1.5">
              <span className="text-2xl font-bold">{getTotalItems()}</span>
              <p className="text-xs text-white/80">items</p>
            </div>
          </div>
        </div>
        
        {/* Bento Box + Drink */}
        <div className="p-4 flex gap-4 items-stretch">
          {/* Bento container */}
          <div className="flex-1 bg-gradient-to-br from-amber-100 to-orange-100 rounded-xl border-4 border-amber-300 p-2">
            <div 
              className="relative bg-white rounded-lg w-full"
              style={{ 
                height: 'min(45vh, 340px)',
              }}
            >
              {layout.compartments.map(comp => (
                <BentoCompartment key={comp.id} compartment={comp} />
              ))}
            </div>
          </div>

          {/* Drink bottle */}
          <div className="flex-shrink-0 bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl border-4 border-blue-200 p-3 flex flex-col">
            <p className="text-xs font-bold text-blue-700 text-center mb-2">ğŸ’§ Drink</p>
            <DrinkBottleDisplay />
          </div>
        </div>

        {/* Close button */}
        <div className="p-4 pt-0 flex justify-center">
          <button
            onClick={onClose}
            className="px-10 py-3 bg-gradient-to-r from-orange-400 to-pink-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all text-lg"
          >
            âœ“ Close
          </button>
        </div>
      </div>
    </div>
  );
};

// Weekly Planner View
const WeeklyPlanner = ({ weekPlan, selectedChild, onEditDay, onViewDay, ateAllLunch, onToggleAteAll, onAwardPoints, manualCompleteByDay, parentCredits, onUpdateParentCredit, onSurpriseWeek, onCopyLunch, onSaveFavorite, children }) => {
  // Get fillable categories for this child
  const availableCategories = getAvailableCategoriesForChild(selectedChild);
  const fillableCount = Object.values(availableCategories).filter(Boolean).length;
  
  // Get current day for highlighting
  const today = new Date();
  const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const todayName = dayNames[today.getDay()];

  const isAutoComplete = (dayPlan) => {
    return Object.entries(availableCategories).every(([cat, available]) => {
      if (!available) return true; // Skip unavailable categories
      return dayPlan[cat]?.length > 0;
    });
  };
  
  // Check if manually marked as complete
  const isManualComplete = (day) => {
    const childKey = selectedChild?.id;
    return childKey && manualCompleteByDay?.[childKey]?.[day];
  };
  
  // Get who made lunch for a day
  const getMadeBy = (day) => {
    const childKey = selectedChild?.id;
    return parentCredits?.[childKey]?.[day]?.madeBy || null;
  };
  
  const handleAteAllToggle = (day) => {
    const wasChecked = ateAllLunch?.[day];
    onToggleAteAll(day);
    
    // Award points when checking (not unchecking)
    if (!wasChecked) {
      const dayPlan = weekPlan[day] || {};
      // Calculate full points from the food eaten
      const foodPoints = calculatePointsFromSelections(dayPlan, selectedChild);
      // Bonus 10 points for eating all lunch
      const totalPoints = foodPoints + 10;
      
      if (totalPoints !== 0) {
        onAwardPoints(totalPoints);
      }
    } else {
      // Unchecking - remove the points that were awarded
      const dayPlan = weekPlan[day] || {};
      const foodPoints = calculatePointsFromSelections(dayPlan, selectedChild);
      const totalPoints = foodPoints + 10;
      if (totalPoints !== 0) {
        onAwardPoints(-totalPoints);
      }
    }
  };

  // Show message if no child selected
  if (!selectedChild) {
    return (
      <div className="bg-white/80 backdrop-blur-sm rounded-2xl p-8 text-center shadow-md">
        <div className="text-5xl mb-4">ğŸ‘†</div>
        <h3 className="text-xl font-bold text-gray-800 mb-2">Select a Child First</h3>
        <p className="text-gray-600">Tap on a child's card above to start planning their lunches!</p>
      </div>
    );
  }

  return (
    <div className="space-y-3 sm:space-y-4">
      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
        <h2 className="text-xl sm:text-2xl font-bold text-gray-800 flex items-center gap-2 flex-wrap">
          <span>Weekly Plan for</span> {selectedChild && (
            <span className="font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 via-pink-500 to-purple-500" style={{ fontFamily: 'Fredoka, Comic Sans MS, cursive' }}>
              {selectedChild.name}
            </span>
          )}
        </h2>
        {selectedChild && (
          <button
            onClick={onSurpriseWeek}
            className="px-3 py-1.5 sm:px-4 sm:py-2 bg-gradient-to-r from-violet-500 to-purple-600 text-white rounded-xl font-bold shadow-md hover:shadow-lg transition-all flex items-center gap-2 text-sm sm:text-base whitespace-nowrap"
            title="Fill the whole week with surprise lunches!"
          >
            ğŸ² Surprise Week!
          </button>
        )}
      </div>
      
      {selectedChild && fillableCount < 6 && (
        <div className="bg-orange-50 border border-orange-200 rounded-xl p-3 text-sm text-orange-700">
          âš ï¸ {6 - fillableCount} food group(s) blocked due to allergen restrictions. 
          Lunchboxes will be considered complete without them.
        </div>
      )}
      
      <div className="grid gap-3 sm:gap-4">
        {DAYS.map(day => {
          const dayPlan = weekPlan[day] || {};
          const filledGroups = Object.entries(availableCategories).filter(([cat, available]) => 
            available && dayPlan[cat]?.length > 0
          ).length;
          const totalItems = Object.values(dayPlan).reduce((sum, arr) => sum + (arr?.length || 0), 0);
          const dayIsComplete = isAutoComplete(dayPlan) || isManualComplete(day);
          
          return (
            <div
              key={day}
              className={`bg-white/80 backdrop-blur-sm rounded-2xl p-3 sm:p-4 shadow-md transition-all hover:shadow-lg ${
                dayIsComplete ? 'border-2 border-green-400' : ''
              }`}
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3 sm:gap-4">
                  <div className={`w-10 h-10 sm:w-12 sm:h-12 rounded-xl flex items-center justify-center font-bold text-white text-sm sm:text-base ${
                    dayIsComplete 
                      ? 'bg-gradient-to-br from-green-400 to-emerald-500' 
                      : filledGroups > 0
                        ? 'bg-gradient-to-br from-orange-400 to-pink-500'
                        : 'bg-gradient-to-br from-gray-300 to-gray-400'
                  }`}>
                    {day.slice(0, 2)}
                  </div>
                  <div>
                    <h3 className="font-bold text-base sm:text-lg">{day}</h3>
                    <p className="text-xs sm:text-sm text-gray-500">
                      {dayIsComplete ? 'âœ“ Complete!' : `${filledGroups}/${fillableCount} groups â€¢ ${totalItems} items`}
                    </p>
                  </div>
                </div>
                
                <div className="flex items-center gap-2 sm:gap-3">
                  <div className="hidden sm:flex gap-1 items-center">
                    {/* Bento categories (excluding water) */}
                    {Object.entries(FOOD_DATABASE).filter(([key]) => key !== 'water').map(([key, cat]) => {
                      const items = dayPlan[key] || [];
                      const hasItems = items.length > 0;
                      const isAvailable = availableCategories[key];
                      return (
                        <div
                          key={key}
                          className={`w-7 h-7 rounded-lg flex items-center justify-center text-sm relative ${
                            !isAvailable ? 'opacity-20 bg-gray-200' : hasItems ? '' : 'opacity-30'
                          }`}
                          style={{ backgroundColor: hasItems && isAvailable ? `${cat.color}20` : undefined }}
                          title={!isAvailable ? `${cat.name} (blocked)` : hasItems ? items.map(i => i.name).join(', ') : cat.name}
                        >
                          {!isAvailable ? 'ğŸš«' : cat.emoji}
                          {hasItems && items.length > 1 && (
                            <span className="absolute -top-1 -right-1 w-3 h-3 bg-orange-500 text-white text-[10px] rounded-full flex items-center justify-center font-bold">
                              {items.length}
                            </span>
                          )}
                        </div>
                      );
                    })}
                    
                    {/* Drink bottle separator and icon */}
                    <div className="w-px h-6 bg-gray-300 mx-1" />
                    {(() => {
                      const drinkItems = dayPlan['water'] || [];
                      const hasDrink = drinkItems.length > 0;
                      const drinkAvailable = availableCategories['water'];
                      return (
                        <div
                          className={`flex flex-col items-center ${!drinkAvailable ? 'opacity-20' : hasDrink ? '' : 'opacity-30'}`}
                          title={!drinkAvailable ? 'Drink (blocked)' : hasDrink ? drinkItems.map(i => i.name).join(', ') : 'Drink'}
                        >
                          <div 
                            className="w-4 h-1.5 rounded-t"
                            style={{ backgroundColor: hasDrink ? '#74B9FF' : '#ccc' }}
                          />
                          <div 
                            className="w-5 h-6 rounded-b-lg flex items-center justify-center text-xs"
                            style={{ 
                              backgroundColor: hasDrink ? '#74B9FF20' : undefined,
                              border: `1.5px ${hasDrink ? 'solid' : 'dashed'} ${hasDrink ? '#74B9FF' : '#ccc'}`,
                              borderTopWidth: 0
                            }}
                          >
                            {!drinkAvailable ? 'ğŸš«' : 'ğŸ’§'}
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                  
                  <div className="flex flex-col sm:flex-row gap-2 items-end sm:items-center">
                    {/* Row 1: Made by + Ate all (on mobile these stack) */}
                    <div className="flex gap-2 items-center">
                      {/* Who made this lunch - show for days with items */}
                      {totalItems > 0 && (
                        <div className="flex items-center gap-1 bg-gray-50 rounded-lg p-1">
                          <button
                            onClick={(e) => { e.stopPropagation(); onUpdateParentCredit(day, 'mum'); }}
                            className={`p-1.5 rounded-lg transition-all ${
                              getMadeBy(day) === 'mum' 
                                ? 'bg-pink-500 text-white shadow-md' 
                                : 'hover:bg-pink-100 text-pink-400'
                            }`}
                            title="Mum made this"
                          >
                            ğŸ‘©
                          </button>
                          <button
                            onClick={(e) => { e.stopPropagation(); onUpdateParentCredit(day, 'dad'); }}
                            className={`p-1.5 rounded-lg transition-all ${
                              getMadeBy(day) === 'dad' 
                                ? 'bg-blue-500 text-white shadow-md' 
                                : 'hover:bg-blue-100 text-blue-400'
                            }`}
                            title="Dad made this"
                          >
                            ğŸ‘¨
                          </button>
                          <button
                            onClick={(e) => { e.stopPropagation(); onUpdateParentCredit(day, 'both'); }}
                            className={`p-1.5 rounded-lg transition-all ${
                              getMadeBy(day) === 'both' 
                                ? 'bg-purple-500 text-white shadow-md' 
                                : 'hover:bg-purple-100 text-purple-400'
                            }`}
                            title="Both made this"
                          >
                            ğŸ‘«
                          </button>
                        </div>
                      )}
                      
                      {/* Ate All Lunch checkbox */}
                      {totalItems > 0 && (
                        <button
                          onClick={(e) => { e.stopPropagation(); handleAteAllToggle(day); }}
                          className={`px-2 py-1.5 sm:px-3 sm:py-2 rounded-xl font-bold text-xs sm:text-sm transition-all flex items-center gap-1 ${
                            ateAllLunch?.[day]
                              ? 'bg-gradient-to-r from-yellow-400 to-amber-500 text-white shadow-lg'
                              : 'bg-gray-100 text-gray-500 hover:bg-gray-200'
                          }`}
                          title={ateAllLunch?.[day] ? 'Ate all lunch! â­' : 'Did they eat all their lunch?'}
                        >
                          {ateAllLunch?.[day] ? 'â­' : 'ğŸ½ï¸'} <span className="hidden sm:inline">{ateAllLunch?.[day] ? 'Ate it!' : 'Ate all?'}</span>
                        </button>
                      )}
                    </div>
                    
                    {/* Row 2: Action buttons (always same order) */}
                    <div className="flex gap-1.5 items-center">
                      <button
                        onClick={() => onEditDay(day)}
                        className={`px-3 py-1.5 sm:px-4 sm:py-2 text-white font-bold rounded-xl hover:shadow-lg transition-all text-sm ${
                          dayIsComplete 
                            ? 'bg-gradient-to-r from-green-400 to-emerald-500' 
                            : 'bg-gradient-to-r from-blue-400 to-cyan-500'
                        }`}
                      >
                        {dayIsComplete ? 'âœ“View' : totalItems > 0 ? 'âœï¸Edit' : 'â•Plan'}
                      </button>
                      
                      {/* Copy button */}
                      {totalItems > 0 && (
                        <button
                          onClick={(e) => { e.stopPropagation(); onCopyLunch(day, selectedChild); }}
                          className="p-1.5 bg-gray-100 hover:bg-blue-100 text-gray-600 hover:text-blue-600 rounded-lg transition-all"
                          title="Copy lunch"
                        >
                          ğŸ“‹
                        </button>
                      )}
                      {/* Favorite button */}
                      {totalItems > 0 && (
                        <button
                          onClick={(e) => { 
                            e.stopPropagation(); 
                            const name = prompt('Name this favorite:', `${day}'s lunch`);
                            if (name) onSaveFavorite(selectedChild?.id, day, name);
                          }}
                          className="p-1.5 bg-gray-100 hover:bg-pink-100 text-gray-600 hover:text-pink-600 rounded-lg transition-all"
                          title="Save as favorite"
                        >
                          â¤ï¸
                        </button>
                      )}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
};

// Install Guide Component - shows platform-specific installation instructions
const InstallGuide = ({ onClose }) => {
  // Detect platform
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
  const isAndroid = /Android/.test(navigator.userAgent);
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
    window.navigator.standalone === true;
  
  if (isStandalone) {
    return (
      <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-2xl max-w-sm w-full p-6 text-center">
          <div className="text-5xl mb-4">âœ…</div>
          <h2 className="text-xl font-bold text-gray-800 mb-2">Already Installed!</h2>
          <p className="text-gray-600 mb-6">You're already using PAKT as an app.</p>
          <button
            onClick={onClose}
            className="px-6 py-3 bg-gradient-to-r from-green-500 to-teal-500 text-white font-bold rounded-xl"
          >
            Got it!
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl max-w-sm w-full overflow-hidden">
        {/* Header */}
        <div className="bg-gradient-to-r from-orange-500 to-pink-500 p-5 text-white text-center">
          <div className="text-4xl mb-2">ğŸ“²</div>
          <h2 className="text-xl font-bold">Install PAKT</h2>
          <p className="text-white/80 text-sm mt-1">Add to your home screen for the best experience</p>
        </div>
        
        {/* Instructions */}
        <div className="p-5">
          {isIOS ? (
            <div className="space-y-4">
              <h3 className="font-bold text-gray-800 flex items-center gap-2">
                <span className="text-xl">ğŸ</span> iPhone / iPad
              </h3>
              <div className="space-y-3">
                <div className="flex items-start gap-3">
                  <div className="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold flex-shrink-0">1</div>
                  <div>
                    <p className="font-medium">Tap the Share button</p>
                    <p className="text-sm text-gray-500">It's the square with an arrow at the bottom of Safari</p>
                    <div className="mt-1 text-2xl">â¬†ï¸</div>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <div className="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold flex-shrink-0">2</div>
                  <div>
                    <p className="font-medium">Scroll and tap "Add to Home Screen"</p>
                    <p className="text-sm text-gray-500">You may need to scroll down in the menu</p>
                    <div className="mt-1 text-2xl">â•</div>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <div className="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold flex-shrink-0">3</div>
                  <div>
                    <p className="font-medium">Tap "Add"</p>
                    <p className="text-sm text-gray-500">The app will appear on your home screen!</p>
                    <div className="mt-1 text-2xl">âœ…</div>
                  </div>
                </div>
              </div>
            </div>
          ) : isAndroid ? (
            <div className="space-y-4">
              <h3 className="font-bold text-gray-800 flex items-center gap-2">
                <span className="text-xl">ğŸ¤–</span> Android
              </h3>
              <div className="space-y-3">
                <div className="flex items-start gap-3">
                  <div className="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-bold flex-shrink-0">1</div>
                  <div>
                    <p className="font-medium">Tap the menu button</p>
                    <p className="text-sm text-gray-500">Three dots â‹® in the top right of Chrome</p>
                    <div className="mt-1 text-2xl">â‹®</div>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <div className="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-bold flex-shrink-0">2</div>
                  <div>
                    <p className="font-medium">Tap "Add to Home screen"</p>
                    <p className="text-sm text-gray-500">Or "Install app" if you see it</p>
                    <div className="mt-1 text-2xl">ğŸ“¥</div>
                  </div>
                </div>
                <div className="flex items-start gap-3">
                  <div className="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-bold flex-shrink-0">3</div>
                  <div>
                    <p className="font-medium">Tap "Add"</p>
                    <p className="text-sm text-gray-500">The app will appear on your home screen!</p>
                    <div className="mt-1 text-2xl">âœ…</div>
                  </div>
                </div>
              </div>
            </div>
          ) : (
            <div className="space-y-4">
              <h3 className="font-bold text-gray-800 flex items-center gap-2">
                <span className="text-xl">ğŸ’»</span> Desktop / Other
              </h3>
              <p className="text-gray-600">
                Look for an install icon in your browser's address bar, or use your browser's menu to "Install" or "Add to Home Screen".
              </p>
            </div>
          )}
        </div>
        
        {/* Footer */}
        <div className="p-4 bg-gray-50 border-t">
          <button
            onClick={onClose}
            className="w-full py-3 bg-gradient-to-r from-orange-500 to-pink-500 text-white font-bold rounded-xl shadow-md"
          >
            Got it!
          </button>
        </div>
      </div>
    </div>
  );
};

// License/Paywall Configuration
const LICENSE_CONFIG = {
  apiUrl: 'https://pakt-api.oliveri-john001.workers.dev',
  productUrl: 'https://buy.stripe.com/14AaEY8AH0jQ4LycHn6EU00',
  price: '$3.99 AUD',
  trialDays: 7,
  debugCode: 'debugpakt'
};


// Check if this device is already activated (for PWA/browser sync)
// Note: check-device endpoint disabled - feature removed
const checkDeviceActivation = async () => {
  // Skip device check - feature not available
  return { recovered: false, alreadyLicensed: false };
};

// Run device check on load (currently disabled)
checkDeviceActivation();

// Paywall Component
const Paywall = ({ onUnlock, onClose, isTrialActive = false, daysLeft = 0, isLicensed = false, storedLicenseKey = '' }) => {
  const [licenseKey, setLicenseKey] = useState('');
  const [isVerifying, setIsVerifying] = useState(false);
  const [error, setError] = useState('');
  const [showKeyInput, setShowKeyInput] = useState(false);
  const [copied, setCopied] = useState(false);
  const [showEmailLookup, setShowEmailLookup] = useState(false);
  const [lookupEmail, setLookupEmail] = useState('');
  const [retrievedKey, setRetrievedKey] = useState('');
  const [isLookingUp, setIsLookingUp] = useState(false);
  
  const lookupLicenseByEmail = async () => {
    if (!lookupEmail.trim()) {
      setError('Please enter your email');
      return;
    }
    
    setIsLookingUp(true);
    setError('');
    setRetrievedKey('');
    
    try {
      const response = await fetch(LICENSE_CONFIG.apiUrl + '/lookup?email=' + encodeURIComponent(lookupEmail.trim()));
      const data = await response.json();
      
      if (data.found && data.key) {
        setRetrievedKey(data.key);
      } else {
        setError('No license found for this email. Check spelling or contact support.');
      }
    } catch (err) {
      setError('Could not lookup license. Check your internet connection.');
    } finally {
      setIsLookingUp(false);
    }
  };
  
  const copyRetrievedKey = () => {
    navigator.clipboard.writeText(retrievedKey);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };
  
  const copyLicenseKey = () => {
    navigator.clipboard.writeText(storedLicenseKey);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };
  
  // If user is licensed, show their license key
  if (isLicensed && storedLicenseKey) {
    return (
      <div className="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-2xl max-w-md w-full overflow-hidden">
          <div className="p-6 text-white text-center bg-gradient-to-r from-green-500 to-emerald-500">
            <div className="text-5xl mb-3">ğŸ‰</div>
            <h2 className="text-2xl font-bold">PAKT PRO</h2>
            <p className="text-white/80 mt-2">You have lifetime access!</p>
          </div>
          
          <div className="p-6">
            <div className="text-center mb-4">
              <p className="text-gray-600 mb-4">Share this key to activate on other family devices (up to 3 devices total)</p>
            </div>
            
            <div className="bg-green-50 border-2 border-green-200 rounded-xl p-4 mb-4">
              <p className="text-xs text-green-600 font-medium mb-2 text-center">YOUR LICENSE KEY</p>
              <p className="font-mono text-lg font-bold text-gray-800 text-center tracking-wider break-all">{storedLicenseKey}</p>
            </div>
            
            <button
              onClick={copyLicenseKey}
              className="w-full py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl transition-all mb-3"
            >
              {copied ? 'âœ“ Copied!' : 'ğŸ“‹ Copy License Key'}
            </button>
            
            <button
              onClick={onClose}
              className="w-full py-3 text-gray-500 hover:bg-gray-100 rounded-xl transition-all"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    );
  }

  const verifyLicense = async () => {
    if (!licenseKey.trim()) {
      setError('Please enter a license key');
      return;
    }

    // Check debug code first
    if (licenseKey.trim().toLowerCase() === LICENSE_CONFIG.debugCode.toLowerCase()) {
      localStorage.setItem('lunchbox-license', JSON.stringify({
        key: 'DEBUG',
        verified: true,
        date: new Date().toISOString()
      }));
      onUnlock();
      return;
    }

    setIsVerifying(true);
    setError('');

    try {
      // Generate device fingerprint
      const deviceId = await generateDeviceId();
      
      const response = await fetch(LICENSE_CONFIG.apiUrl + '/activate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          key: licenseKey.trim(),
          deviceId: deviceId
        })
      });
      const data = await response.json();

      if (data.valid) {
        // Valid license!
        localStorage.setItem('lunchbox-license', JSON.stringify({
          key: licenseKey.trim(),
          verified: true,
          date: new Date().toISOString(),
          email: data.email,
          deviceId: deviceId
        }));
        onUnlock();
      } else {
        setError(data.error || 'Invalid license key. Please check and try again.');
      }
    } catch (err) {
      setError('Could not verify license. Check your internet connection.');
    } finally {
      setIsVerifying(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black/70 z-[100] flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl max-w-md w-full overflow-hidden">
        {/* Header */}
        <div className={`p-6 text-white text-center ${isTrialActive ? 'bg-gradient-to-r from-blue-500 to-purple-500' : 'bg-gradient-to-r from-orange-500 to-pink-500'}`}>
          <div className="text-5xl mb-3">{isTrialActive ? 'â°' : 'ğŸ±'}</div>
          <h2 className="text-2xl font-bold">{isTrialActive ? 'Free Trial Active' : 'Trial Ended'}</h2>
          <p className="text-white/80 mt-2">
            {isTrialActive 
              ? `You have ${daysLeft} day${daysLeft !== 1 ? 's' : ''} left in your free trial`
              : 'Your 7-day free trial has expired'
            }
          </p>
        </div>

        {/* Content */}
        <div className="p-6">
          {!showKeyInput ? (
            <>
              <div className="text-center mb-6">
                <p className="text-gray-600 mb-4">
                  {isTrialActive 
                    ? 'Loving PAKT? Get lifetime access now!'
                    : 'Unlock PAKT forever and keep planning amazing lunches for your kids!'
                  }
                </p>
                <div className="bg-gradient-to-r from-green-50 to-teal-50 rounded-2xl p-4 mb-4">
                  <p className="text-2xl font-bold text-green-600">{LICENSE_CONFIG.price}</p>
                  <p className="text-sm text-gray-500">One-time payment â€¢ Lifetime access</p>
                </div>
                <ul className="text-left text-sm text-gray-600 space-y-2">
                  <li className="flex items-center gap-2">âœ… Unlimited children profiles</li>
                  <li className="flex items-center gap-2">âœ… Custom lunchbox layouts</li>
                  <li className="flex items-center gap-2">âœ… Weekly meal planning</li>
                  <li className="flex items-center gap-2">âœ… Shopping lists & to-do's</li>
                  <li className="flex items-center gap-2">âœ… All future updates free</li>
                </ul>
              </div>

              <a
                href={LICENSE_CONFIG.productUrl}
                target="_blank"
                rel="noopener noreferrer"
                className="block w-full py-4 bg-gradient-to-r from-green-500 to-teal-500 text-white font-bold rounded-xl shadow-lg text-center text-lg hover:shadow-xl transition-all mb-3"
              >
                ğŸ›’ Buy Now - {LICENSE_CONFIG.price}
              </a>

              <button
                onClick={() => setShowKeyInput(true)}
                className="w-full py-3 text-gray-600 font-medium hover:bg-gray-100 rounded-xl transition-all"
              >
                I already have a license key
              </button>
            </>
          ) : (
            <>
              {!showEmailLookup ? (
                <>
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Enter your license key
                    </label>
                    <input
                      type="text"
                      value={licenseKey}
                      onChange={(e) => setLicenseKey(e.target.value)}
                      placeholder="PAKT-XXXX-XXXX-XXXX"
                      className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-orange-400 focus:outline-none font-mono text-sm"
                      disabled={isVerifying}
                    />
                    {error && (
                      <p className="text-red-500 text-sm mt-2">{error}</p>
                    )}
                  </div>

                  <button
                    onClick={verifyLicense}
                    disabled={isVerifying}
                    className="w-full py-4 bg-gradient-to-r from-orange-500 to-pink-500 text-white font-bold rounded-xl shadow-lg text-center hover:shadow-xl transition-all mb-3 disabled:opacity-50"
                  >
                    {isVerifying ? 'â³ Verifying...' : 'âœ“ Activate License'}
                  </button>
                  
                  <button
                    onClick={() => {
                      setShowEmailLookup(true);
                      setError('');
                      setRetrievedKey('');
                    }}
                    className="w-full py-3 text-blue-600 font-medium hover:bg-blue-50 rounded-xl transition-all mb-2"
                  >
                    ğŸ” Retrieve License Key
                  </button>

                  <button
                    onClick={() => {
                      setShowKeyInput(false);
                      setError('');
                    }}
                    className="w-full py-3 text-gray-600 font-medium hover:bg-gray-100 rounded-xl transition-all"
                  >
                    â† Back
                  </button>
                </>
              ) : (
                <>
                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Enter your purchase email
                    </label>
                    <input
                      type="email"
                      value={lookupEmail}
                      onChange={(e) => setLookupEmail(e.target.value)}
                      placeholder="your@email.com"
                      className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-blue-400 focus:outline-none text-sm"
                      disabled={isLookingUp}
                    />
                    {error && (
                      <p className="text-red-500 text-sm mt-2">{error}</p>
                    )}
                  </div>
                  
                  {retrievedKey ? (
                    <div className="mb-4">
                      <div className="bg-green-50 border-2 border-green-200 rounded-xl p-4">
                        <p className="text-xs text-green-600 font-medium mb-2 text-center">YOUR LICENSE KEY</p>
                        <p className="font-mono text-lg font-bold text-gray-800 text-center tracking-wider break-all">{retrievedKey}</p>
                      </div>
                      <button
                        onClick={copyRetrievedKey}
                        className="w-full mt-3 py-3 bg-green-500 hover:bg-green-600 text-white font-bold rounded-xl transition-all"
                      >
                        {copied ? 'âœ“ Copied!' : 'ğŸ“‹ Copy Key'}
                      </button>
                      <p className="text-xs text-gray-400 mt-2 text-center">
                        Paste this key above to activate
                      </p>
                    </div>
                  ) : (
                    <button
                      onClick={lookupLicenseByEmail}
                      disabled={isLookingUp}
                      className="w-full py-4 bg-gradient-to-r from-blue-500 to-cyan-500 text-white font-bold rounded-xl shadow-lg text-center hover:shadow-xl transition-all mb-3 disabled:opacity-50"
                    >
                      {isLookingUp ? 'â³ Looking up...' : 'ğŸ” Find My License'}
                    </button>
                  )}

                  <button
                    onClick={() => {
                      setShowEmailLookup(false);
                      setError('');
                      setRetrievedKey('');
                      setLookupEmail('');
                    }}
                    className="w-full py-3 text-gray-600 font-medium hover:bg-gray-100 rounded-xl transition-all"
                  >
                    â† Back
                  </button>
                </>
              )}
            </>
          )}
        </div>

        {/* Footer note */}
        <div className="px-6 pb-6">
          {isTrialActive && onClose && (
            <button
              onClick={onClose}
              className="w-full py-3 mb-3 text-gray-600 font-medium hover:bg-gray-100 rounded-xl transition-all"
            >
              â† Back to App
            </button>
          )}
          <p className="text-xs text-gray-400 text-center">
            Questions? Contact support at support@getpakt.app
          </p>
        </div>
      </div>
    </div>
  );
};

// License check helper functions
const getLicenseStatus = () => {
  // Check for valid stored license
  const storedLicense = localStorage.getItem('lunchbox-license');
  if (storedLicense) {
    try {
      const license = JSON.parse(storedLicense);
      if (license.verified) {
        return { valid: true, licensed: true };
      }
    } catch (e) {}
  }

  // Check trial status
  let trialStart = localStorage.getItem('lunchbox-trial-start');
  if (!trialStart) {
    // First launch - start trial
    trialStart = new Date().toISOString();
    localStorage.setItem('lunchbox-trial-start', trialStart);
  }

  const trialStartDate = new Date(trialStart);
  const now = new Date();
  const daysPassed = (now - trialStartDate) / (1000 * 60 * 60 * 24);

  if (daysPassed <= LICENSE_CONFIG.trialDays) {
    return { valid: true, licensed: false, daysLeft: Math.ceil(LICENSE_CONFIG.trialDays - daysPassed) };
  }

  return { valid: false, licensed: false };
};

// Shopping List Component - now shows actual ingredients grouped by shopping aisle
const ShoppingList = ({ weekPlan, children, onClose, onItemChecked }) => {
  // State for checkable items and collapsible categories
  const [checkedItems, setCheckedItems] = useState({});
  const [expandedCats, setExpandedCats] = useState({});
  
  // Handle checking an item
  const handleCheckItem = (itemKey) => {
    const wasChecked = checkedItems[itemKey];
    setCheckedItems(prev => ({
      ...prev,
      [itemKey]: !prev[itemKey]
    }));
    // Notify parent when checking (not unchecking)
    if (!wasChecked && onItemChecked) {
      onItemChecked();
    }
  };
  
  // Aggregate ingredients across ALL children, all days and meals
  const ingredients = {};
  
  // Iterate over all children's week plans
  Object.entries(weekPlan).forEach(([childId, childWeekPlan]) => {
    if (!childWeekPlan || typeof childWeekPlan !== 'object') return;
    
    Object.values(childWeekPlan).forEach(dayPlan => {
      if (!dayPlan || typeof dayPlan !== 'object') return;
      
      Object.entries(dayPlan).forEach(([category, itemsArray]) => {
        if (itemsArray && Array.isArray(itemsArray)) {
          itemsArray.forEach(item => {
            if (item.ingredients) {
              item.ingredients.forEach(ing => {
                const key = ing.name; // Group by name only for practical shopping
                if (ingredients[key]) {
                  ingredients[key].qty += ing.qty;
                  ingredients[key].count++;
                  // Keep track of original units for conversion
                  if (!ingredients[key].originalUnits.includes(ing.unit)) {
                    ingredients[key].originalUnits.push(ing.unit);
                  }
                } else {
                  ingredients[key] = { 
                    ...ing, 
                    count: 1,
                    key,
                    originalUnits: [ing.unit]
                  };
                }
              });
            }
          });
        }
      });
    });
  });

  // Group by shopping category
  const grouped = {};
  Object.values(ingredients).forEach(ing => {
    const cat = ing.category || 'Other';
    if (!grouped[cat]) {
      grouped[cat] = [];
    }
    grouped[cat].push(ing);
  });

  // Sort categories in logical shopping order
  const categoryOrder = ['Produce', 'Bakery', 'Dairy', 'Deli', 'Meat', 'Seafood', 'Frozen', 'Pantry', 'Drinks', 'Other'];
  const sortedCategories = Object.keys(grouped).sort((a, b) => {
    return categoryOrder.indexOf(a) - categoryOrder.indexOf(b);
  });

  const categoryEmojis = {
    'Produce': 'ğŸ¥¬',
    'Bakery': 'ğŸ¥–',
    'Dairy': 'ğŸ§€',
    'Deli': 'ğŸ¥©',
    'Meat': 'ğŸ–',
    'Seafood': 'ğŸŸ',
    'Frozen': 'ğŸ§Š',
    'Pantry': 'ğŸ«™',
    'Drinks': 'ğŸ¥¤',
    'Other': 'ğŸ“¦'
  };

  const totalItems = Object.values(ingredients).length;

  // Convert recipe quantities to practical shopping quantities
  const formatPracticalQuantity = (ing) => {
    const name = ing.name.toLowerCase();
    const unit = (ing.unit || '').toLowerCase();
    const qty = ing.qty;
    
    // Items sold by bunch - any small quantity means buy 1 bunch
    const bunchItems = ['mint', 'basil', 'parsley', 'coriander', 'dill', 'chives', 'spring onion', 'shallot', 'celery', 'spinach', 'kale', 'silverbeet', 'bok choy', 'asian greens'];
    if (bunchItems.some(b => name.includes(b))) {
      return '1 bunch';
    }
    
    // Items sold by bag/punnet
    const punnetItems = ['cherry tomato', 'grape tomato', 'strawberr', 'blueberr', 'raspberr', 'mixed berr'];
    if (punnetItems.some(p => name.includes(p))) {
      return '1 punnet';
    }
    
    // Grapes - sold by bunch
    if (name.includes('grape') && !name.includes('tomato')) {
      return '1 bunch';
    }
    
    // Lettuce types - 1 head/bag
    const lettuceTypes = ['lettuce', 'cos', 'iceberg', 'butter lettuce', 'rocket', 'mixed leaves', 'salad mix', 'baby spinach'];
    if (lettuceTypes.some(l => name.includes(l))) {
      return '1 bag/head';
    }
    
    // Items where we show count (round up fractions)
    const countItems = ['apple', 'banana', 'orange', 'mandarin', 'pear', 'peach', 'nectarine', 'plum', 'kiwi', 'mango', 'avocado', 'lemon', 'lime', 'capsicum', 'cucumber', 'carrot', 'zucchini', 'potato', 'sweet potato', 'onion', 'tomato', 'egg', 'bread roll', 'muffin', 'croissant', 'persimmon', 'beetroot'];
    if (countItems.some(c => name.includes(c)) && !punnetItems.some(p => name.includes(p))) {
      const roundedQty = Math.ceil(qty);
      return `Ã— ${roundedQty}`;
    }
    
    // Sliced/diced items that come from whole items - convert to whole count
    if (unit.includes('slice') || unit.includes('wedge') || unit.includes('segment')) {
      // Estimate: ~8 slices per item
      const wholeItems = Math.ceil(qty / 8);
      return `Ã— ${Math.max(1, wholeItems)}`;
    }
    
    // Leaves - buy the whole item
    if (unit.includes('leaf') || unit.includes('leaves')) {
      return 'Ã— 1';
    }
    
    // Weight-based items (meat, cheese, deli)
    if (unit === 'g' || unit === 'grams') {
      if (qty < 100) return '100g';
      if (qty < 250) return '250g';
      if (qty < 500) return '500g';
      return `${Math.ceil(qty / 100) * 100}g`;
    }
    
    // Volume-based
    if (unit === 'ml') {
      if (qty <= 250) return '250ml';
      if (qty <= 500) return '500ml';
      if (qty <= 1000) return '1L';
      return `${Math.ceil(qty / 1000)}L`;
    }
    
    // Cups/tablespoons of pantry items - just say "1" or check pantry
    if (unit.includes('cup') || unit.includes('tbsp') || unit.includes('tsp')) {
      return 'âœ“ check pantry';
    }
    
    // Handful = just buy some
    if (unit.includes('handful')) {
      return 'Ã— 1 pack';
    }
    
    // Cooked amounts - show as dry equivalent
    if (unit.includes('cooked')) {
      return '1 pack';
    }
    
    // Default: round up and show with unit
    if (unit) {
      const roundedQty = qty < 1 ? 1 : Math.ceil(qty);
      return `${roundedQty} ${unit}`;
    }
    
    // No unit - just show rounded count
    return `Ã— ${Math.ceil(qty)}`;
  };

  return (
    <div className="fixed inset-0 bg-black/50 z-50 overflow-y-auto">
      <div className="min-h-full flex items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-2xl w-full max-w-lg my-4 flex flex-col" style={{ maxHeight: 'calc(100vh - 32px)' }}>
          <div className="bg-gradient-to-r from-green-400 to-emerald-500 p-6 text-white rounded-t-3xl flex-shrink-0">
            <h2 className="text-2xl font-bold flex items-center gap-2">
              ğŸ›’ Shopping List
            </h2>
            <p className="text-white/80 mt-1">
              {totalItems} items to buy
            </p>
          </div>
          
          <div className="flex-1 overflow-y-auto p-4 min-h-0">
            {sortedCategories.length > 0 ? (
              <div className="space-y-2">
                {sortedCategories.map(category => {
                  const isOpen = expandedCats[category];
                  const items = grouped[category];
                  const doneCount = items.filter(i => checkedItems[i.key]).length;
                  return (
                    <div key={category} className="bg-gray-50 rounded-2xl overflow-hidden">
                      <button
                        onClick={() => setExpandedCats(p => ({...p, [category]: !p[category]}))}
                        className="w-full flex items-center gap-2 p-3 hover:bg-gray-100"
                      >
                        <span className="text-xl">{categoryEmojis[category] || 'ğŸ“¦'}</span>
                        <h3 className="font-bold text-gray-800 flex-1 text-left">{category}</h3>
                        <span className="text-sm text-gray-500">{doneCount}/{items.length}</span>
                        <span className={`transition-transform ${isOpen ? 'rotate-180' : ''}`}>â–¼</span>
                      </button>
                      {isOpen && (
                        <div className="px-3 pb-3 space-y-1">
                          {items.map(ing => (
                            <button
                              key={ing.key}
                              onClick={() => handleCheckItem(ing.key)}
                              className={`w-full flex items-center gap-3 p-2 rounded-xl ${checkedItems[ing.key] ? 'bg-green-50' : 'bg-white'}`}
                            >
                              <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${checkedItems[ing.key] ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300'}`}>
                                {checkedItems[ing.key] && 'âœ“'}
                              </div>
                              <span className={`flex-1 text-left ${checkedItems[ing.key] ? 'line-through text-gray-400' : 'text-gray-700'}`}>{ing.name}</span>
                              <span className="px-2 py-0.5 bg-emerald-100 text-emerald-700 rounded-full text-sm">
                                {formatPracticalQuantity(ing)}
                              </span>
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            ) : (
              <div className="text-center py-12 text-gray-500">
                <div className="text-5xl mb-3">ğŸ“</div>
                <p className="font-medium">No items yet!</p>
                <p className="text-sm mt-1">Plan some lunches to generate your shopping list</p>
              </div>
            )}
          </div>

          <div className="p-4 bg-gray-50 flex justify-end gap-3 border-t rounded-b-3xl flex-shrink-0">
            <button
              onClick={onClose}
              className="px-6 py-3 text-gray-600 font-bold hover:bg-gray-200 rounded-xl transition-all"
            >
              Close
            </button>
            <button
              onClick={() => {
                const text = sortedCategories.map(cat => 
                  `${categoryEmojis[cat] || 'ğŸ“¦'} ${cat.toUpperCase()}\n${grouped[cat].map(ing => 
                    `â˜ ${ing.name} - ${formatPracticalQuantity(ing)}`
                  ).join('\n')}`
                ).join('\n\n');
                navigator.clipboard?.writeText(text);
              }}
              className="px-6 py-3 bg-gradient-to-r from-green-400 to-emerald-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all"
            >
              ğŸ“‹ Copy List
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// Calendar Helper Functions
const generateICSFile = (title, description, startDate, durationMinutes = 30) => {
  const formatDate = (date) => {
    return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
  };
  
  const start = new Date(startDate);
  const end = new Date(start.getTime() + durationMinutes * 60000);
  
  const icsContent = [
    'BEGIN:VCALENDAR',
    'VERSION:2.0',
    'PRODID:-//PAKT//EN',
    'BEGIN:VEVENT',
    `DTSTART:${formatDate(start)}`,
    `DTEND:${formatDate(end)}`,
    `SUMMARY:${title}`,
    `DESCRIPTION:${description.replace(/\n/g, '\\n')}`,
    'END:VEVENT',
    'END:VCALENDAR'
  ].join('\r\n');
  
  return icsContent;
};

const downloadICSFile = (title, description, startDate, durationMinutes) => {
  const icsContent = generateICSFile(title, description, startDate, durationMinutes);
  const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `${title.replace(/[^a-z0-9]/gi, '_')}.ics`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
};

const generateGoogleCalendarUrl = (title, description, startDate, durationMinutes = 30) => {
  const formatGoogleDate = (date) => {
    return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
  };
  
  const start = new Date(startDate);
  const end = new Date(start.getTime() + durationMinutes * 60000);
  
  const params = new URLSearchParams({
    action: 'TEMPLATE',
    text: title,
    details: description,
    dates: `${formatGoogleDate(start)}/${formatGoogleDate(end)}`
  });
  
  return `https://calendar.google.com/calendar/render?${params.toString()}`;
};

// Get next occurrence of a day (e.g., next Sunday for batch prep)
const getNextDayDate = (dayName, hour = 18) => {
  const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const today = new Date();
  const targetDay = days.indexOf(dayName);
  const todayDay = today.getDay();
  
  let daysUntil = targetDay - todayDay;
  if (daysUntil <= 0) daysUntil += 7;
  
  const targetDate = new Date(today);
  targetDate.setDate(today.getDate() + daysUntil);
  targetDate.setHours(hour, 0, 0, 0);
  
  return targetDate;
};

// My To-Do's Component - shows prep tasks organized by when to do them
const MyToDos = ({ allWeekPlans, children, onClose, todoCredits, onUpdateTodoCredit, onTaskChecked }) => {
  // Get current day of week
  const today = new Date();
  const dayOfWeek = today.getDay();
  const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const todayName = dayNames[dayOfWeek];
  
  const schoolDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
  const todayIndex = schoolDays.indexOf(todayName);
  const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
  
  // Ref for scroll preservation
  const scrollRef = React.useRef(null);
  const scrollPosRef = React.useRef(0);
  
  // State
  const [focusDay, setFocusDay] = useState(isWeekend ? 'Monday' : todayName);
  const [checkedItems, setCheckedItems] = useState(() => {
    const saved = localStorage.getItem('lunchbox-todos-checked');
    return saved ? JSON.parse(saved) : {};
  });
  const [expandedTask, setExpandedTask] = useState(null);
  const [askWhoDidIt, setAskWhoDidIt] = useState(null); // Task ID to ask who did it

  useEffect(() => {
    localStorage.setItem('lunchbox-todos-checked', JSON.stringify(checkedItems));
  }, [checkedItems]);

  // Preserve scroll position on state updates
  const preserveScroll = (callback) => {
    if (scrollRef.current) {
      scrollPosRef.current = scrollRef.current.scrollTop;
    }
    callback();
    // Restore after React re-renders
    requestAnimationFrame(() => {
      if (scrollRef.current) {
        scrollRef.current.scrollTop = scrollPosRef.current;
      }
    });
  };

  const toggleChecked = (taskId) => {
    const currentlyChecked = checkedItems[taskId];
    const hasCredit = todoCredits?.[taskId];
    
    // If trying to check off and no credit assigned, ask who did it
    if (!currentlyChecked && !hasCredit) {
      setAskWhoDidIt(taskId);
      return;
    }
    
    // Notify parent when checking (not unchecking)
    if (!currentlyChecked && onTaskChecked) {
      onTaskChecked();
    }
    
    preserveScroll(() => {
      setCheckedItems(prev => ({ ...prev, [taskId]: !prev[taskId] }));
    });
  };
  
  // Handle selecting who did task from popup
  const handleWhoDidItSelect = (parent) => {
    if (askWhoDidIt) {
      onUpdateTodoCredit(askWhoDidIt, parent);
      setCheckedItems(prev => ({ ...prev, [askWhoDidIt]: true }));
      setAskWhoDidIt(null);
      // Notify parent that a task was checked off
      if (onTaskChecked) {
        onTaskChecked();
      }
    }
  };
  
  // Get who did this task
  const getTaskCredit = (taskId) => todoCredits?.[taskId] || null;
  
  const handleUpdateCredit = (taskId, parent) => {
    preserveScroll(() => {
      onUpdateTodoCredit(taskId, parent);
    });
  };

  const clearAllChecked = () => setCheckedItems({});

  // Gather ALL tasks from ALL children's week plans
  const allTasks = [];
  
  children.forEach(child => {
    const weekPlan = allWeekPlans[child.id] || {};
    Object.entries(weekPlan).forEach(([day, dayPlan]) => {
      Object.entries(dayPlan).forEach(([category, itemsArray]) => {
        if (itemsArray && Array.isArray(itemsArray)) {
          itemsArray.forEach(item => {
            if (item.recipe) {
              const prepTime = item.recipe.prepTime.toLowerCase();
              const isNightBefore = prepTime.includes('night before');
              const needsRecipe = item.recipe.steps && item.recipe.steps.length > 1;
              const prepMins = parseInt(prepTime) || 0;
              const isBatchPrep = prepMins >= 15;
              const isQuick = prepTime.includes('sec') || prepMins <= 3;
              
              allTasks.push({
                id: `${child.id}-${day}-${item.id}`,
                itemId: item.id,
                day,
                item,
                category,
                childId: child.id,
                childName: child.name,
                childEmoji: child.emoji || 'ğŸ‘¤',
                isNightBefore,
                isBatchPrep,
                isQuick,
                needsRecipe,
                prepTime: item.recipe.prepTime
              });
            }
          });
        }
      });
    });
  });

  // Get focused day index and previous night
  const focusDayIndex = schoolDays.indexOf(focusDay);
  const prevDay = focusDayIndex > 0 ? schoolDays[focusDayIndex - 1] : null;
  
  // Categorize tasks
  const focusDayTasks = {
    tonight: [], // Night before prep (for focused day, done previous night)
    morning: [], // Quick morning tasks for focused day
    batch: []    // Batch prep items
  };
  
  const otherDaysTasks = {};
  const seenBatchItems = new Set();

  allTasks.forEach(task => {
    // Tasks for the focused day
    if (task.day === focusDay) {
      if (task.isNightBefore) {
        // Night before tasks go into "tonight" if focus is tomorrow, else batch
        if (focusDay === schoolDays[todayIndex + 1]) {
          focusDayTasks.tonight.push(task);
        } else {
          if (!seenBatchItems.has(`${task.childId}-${task.itemId}`)) {
            seenBatchItems.add(`${task.childId}-${task.itemId}`);
            focusDayTasks.batch.push(task);
          }
        }
      } else {
        focusDayTasks.morning.push(task);
      }
    } else {
      // Tasks for other days - group by day
      if (!otherDaysTasks[task.day]) otherDaysTasks[task.day] = [];
      otherDaysTasks[task.day].push(task);
    }
  });

  // Find batch prep items - items used by ANY child on multiple days OR same item by multiple children
  const itemUsageCount = {};
  allTasks.forEach(task => {
    // Key by just itemId to group across all children
    const key = task.itemId;
    if (!itemUsageCount[key]) {
      itemUsageCount[key] = { 
        task, 
        days: [], 
        children: [],
        usages: [] // Track each unique child+day combo
      };
    }
    // Track unique days
    if (!itemUsageCount[key].days.includes(task.day)) {
      itemUsageCount[key].days.push(task.day);
    }
    // Track unique children
    if (!itemUsageCount[key].children.includes(task.childName)) {
      itemUsageCount[key].children.push(task.childName);
    }
    // Track all usages
    itemUsageCount[key].usages.push({ day: task.day, child: task.childName, childEmoji: task.childEmoji });
  });

  Object.values(itemUsageCount).forEach(({ task, days, children, usages }) => {
    // Show as batch if: multiple days OR multiple children AND item takes prep time
    const isMultiUse = days.length > 1 || children.length > 1;
    if (isMultiUse && task.isBatchPrep && !seenBatchItems.has(task.itemId)) {
      seenBatchItems.add(task.itemId);
      focusDayTasks.batch.push({ 
        ...task, 
        daysUsed: days,
        childrenUsed: children,
        usages: usages,
        id: `batch-${task.itemId}` // Unique ID for batch item
      });
    }
  });

  const totalFocusTasks = focusDayTasks.tonight.length + focusDayTasks.morning.length + focusDayTasks.batch.length;
  const completedFocusTasks = [...focusDayTasks.tonight, ...focusDayTasks.morning, ...focusDayTasks.batch]
    .filter(t => checkedItems[t.id]).length;

  // Task Item Component with expandable recipe
  const TaskItem = ({ task, showChild = true }) => {
    const isChecked = checkedItems[task.id];
    const isExpanded = expandedTask === task.id;
    const catData = FOOD_DATABASE[task.category];
    const taskCredit = getTaskCredit(task.id);
    
    return (
      <div className={`rounded-xl transition-all ${isChecked ? 'bg-green-50/50' : 'bg-white'}`}>
        <div className={`flex items-start gap-3 p-3 ${isChecked ? 'opacity-60' : ''}`}>
          <button
            onClick={() => toggleChecked(task.id)}
            className={`flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all mt-0.5 ${
              isChecked ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300 hover:border-green-400'
            }`}
          >
            {isChecked && 'âœ“'}
          </button>
          
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2 flex-wrap">
              <span className={`font-medium ${isChecked ? 'line-through text-gray-400' : 'text-gray-800'}`}>
                {task.item.emoji} {task.item.name}
              </span>
              {showChild && children.length > 1 && (
                <span className="text-xs px-1.5 py-0.5 bg-gray-100 rounded-full text-gray-500">
                  {task.childEmoji} {task.childName}
                </span>
              )}
              
              {/* Who did this task - Mum/Dad/Both icons */}
              <div className="flex items-center gap-1 ml-auto">
                <span className="text-xs text-gray-400 mr-1 hidden sm:inline">Who?</span>
                <button
                  onClick={() => handleUpdateCredit(task.id, taskCredit === 'mum' ? null : 'mum')}
                  className={`p-1 rounded transition-all text-sm ${
                    taskCredit === 'mum' 
                      ? 'bg-pink-500 text-white shadow' 
                      : 'hover:bg-pink-100 text-pink-300 hover:text-pink-500'
                  }`}
                  title="Mum did this"
                >
                  ğŸ‘©
                </button>
                <button
                  onClick={() => handleUpdateCredit(task.id, taskCredit === 'dad' ? null : 'dad')}
                  className={`p-1 rounded transition-all text-sm ${
                    taskCredit === 'dad' 
                      ? 'bg-blue-500 text-white shadow' 
                      : 'hover:bg-blue-100 text-blue-300 hover:text-blue-500'
                  }`}
                  title="Dad did this"
                >
                  ğŸ‘¨
                </button>
                <button
                  onClick={() => handleUpdateCredit(task.id, taskCredit === 'both' ? null : 'both')}
                  className={`p-1 rounded transition-all text-sm ${
                    taskCredit === 'both' 
                      ? 'bg-purple-500 text-white shadow' 
                      : 'hover:bg-purple-100 text-purple-300 hover:text-purple-500'
                  }`}
                  title="Both did this"
                >
                  ğŸ‘«
                </button>
              </div>
            </div>
            
            <div className="flex flex-wrap items-center gap-2 mt-1 text-xs">
              <span className="px-2 py-0.5 rounded-full text-white" style={{ backgroundColor: catData?.color || '#999' }}>
                {catData?.name}
              </span>
              <span className="text-gray-400">â±ï¸ {task.prepTime}</span>
              {task.daysUsed && (
                <span className="text-gray-500">ğŸ“… {task.daysUsed.join(', ')}</span>
              )}
              {task.childrenUsed && task.childrenUsed.length > 1 && (
                <span className="text-purple-500 font-medium">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ For: {task.childrenUsed.join(', ')}</span>
              )}
            </div>
            
            {/* Expandable recipe button */}
            {task.needsRecipe && !isChecked && (
              <button
                onClick={() => setExpandedTask(isExpanded ? null : task.id)}
                className="mt-2 text-xs text-teal-600 hover:text-teal-700 font-medium flex items-center gap-1"
              >
                {isExpanded ? 'â–¼ Hide steps' : 'â–¶ How to make this'}
              </button>
            )}
          </div>
        </div>
        
        {/* Expanded Recipe */}
        {isExpanded && task.item.recipe && (
          <div className="px-3 pb-3 ml-9 border-t border-gray-100 mt-1 pt-3">
            {task.item.ingredients && task.item.ingredients.length > 0 && (
              <div className="mb-3">
                <p className="text-xs font-bold text-gray-500 uppercase mb-1">You'll need:</p>
                <div className="flex flex-wrap gap-1">
                  {task.item.ingredients.map((ing, idx) => {
                    // For batch items, multiply by number of usages
                    const usageCount = task.usages ? task.usages.length : 1;
                    const totalQty = ing.qty * usageCount;
                    const isMultiple = usageCount > 1;
                    
                    return (
                      <span key={idx} className={`text-xs px-2 py-0.5 rounded ${isMultiple ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-600'}`}>
                        {totalQty} {ing.unit} {ing.name}
                        {isMultiple && ` (${usageCount}Ã— ${ing.qty}${ing.unit})`}
                      </span>
                    );
                  })}
                </div>
                {task.usages && task.usages.length > 1 && (
                  <div className="mt-2 text-xs text-purple-600 bg-purple-50 rounded-lg px-2 py-1.5">
                    ğŸ“¦ <strong>Batch breakdown:</strong> {task.usages.map((u, i) => (
                      <span key={i}>
                        {u.child} ({u.day}){i < task.usages.length - 1 ? ', ' : ''}
                      </span>
                    ))}
                  </div>
                )}
              </div>
            )}
            <p className="text-xs font-bold text-gray-500 uppercase mb-2">Steps:</p>
            <ol className="space-y-1.5">
              {task.item.recipe.steps.map((step, idx) => (
                <li key={idx} className="flex gap-2 text-sm">
                  <span className="flex-shrink-0 w-5 h-5 rounded-full bg-teal-100 text-teal-600 flex items-center justify-center text-xs font-bold">
                    {idx + 1}
                  </span>
                  <span className="text-gray-600">{step}</span>
                </li>
              ))}
            </ol>
            {task.item.recipe.tip && (
              <div className="mt-2 text-xs text-amber-700 bg-amber-50 rounded-lg px-2 py-1.5">
                {task.item.recipe.tip}
              </div>
            )}
          </div>
        )}
      </div>
    );
  };

  return (
    <div className="fixed inset-0 bg-black/50 z-50 overflow-y-auto">
      <div className="min-h-full flex items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-2xl w-full max-w-2xl my-4 flex flex-col" style={{ maxHeight: 'calc(100vh - 32px)' }}>
          {/* Header */}
          <div className="bg-gradient-to-r from-green-500 to-teal-500 p-5 text-white rounded-t-3xl flex-shrink-0">
            <div className="flex items-center justify-between">
              <div>
                <h2 className="text-2xl font-bold">âœ… My To-Do's</h2>
                <p className="text-white/80 text-sm mt-1">
                  {children.length > 1 ? `All ${children.length} kids` : children[0]?.name || 'Family'} â€¢ {completedFocusTasks}/{totalFocusTasks} done
                </p>
              </div>
              <div className="flex items-center gap-2">
                {Object.keys(checkedItems).length > 0 && (
                  <button onClick={clearAllChecked} className="text-white/70 hover:text-white text-sm underline">
                    Clear âœ“
                  </button>
                )}
              </div>
            </div>
            
            {/* Progress bar */}
            <div className="mt-3 h-2 bg-white/20 rounded-full overflow-hidden">
              <div 
                className="h-full bg-white transition-all duration-500"
                style={{ width: `${totalFocusTasks > 0 ? (completedFocusTasks / totalFocusTasks) * 100 : 0}%` }}
              />
            </div>
            
            {/* Calendar buttons */}
            {totalFocusTasks > 0 && (
              <div className="mt-3 flex gap-2 flex-wrap">
                <button
                  onClick={() => {
                    const sundayDate = getNextDayDate('Sunday', 16);
                    const taskList = [...focusDayTasks.batch, ...focusDayTasks.tonight].map(t => `â€¢ ${t.item.name} (${t.prepTime})`).join('\n');
                    downloadICSFile(
                      'ğŸ± PAKT: Batch Prep',
                      `Prep these items for the week:\n\n${taskList}`,
                      sundayDate,
                      60
                    );
                  }}
                  className="flex items-center gap-1 px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium transition-all"
                >
                  ğŸ“… Add Batch Prep to Calendar
                </button>
                <button
                  onClick={() => {
                    const sundayDate = getNextDayDate('Sunday', 16);
                    const taskList = [...focusDayTasks.batch, ...focusDayTasks.tonight].map(t => `â€¢ ${t.item.name} (${t.prepTime})`).join('%0A');
                    window.open(generateGoogleCalendarUrl(
                      'ğŸ± PAKT: Batch Prep',
                      `Prep these items for the week:\n${taskList}`,
                      sundayDate,
                      60
                    ), '_blank');
                  }}
                  className="flex items-center gap-1 px-3 py-1.5 bg-white/20 hover:bg-white/30 rounded-lg text-sm font-medium transition-all"
                >
                  ğŸ“† Google Calendar
                </button>
              </div>
            )}
          </div>

          {/* Day selector tabs */}
          <div className="flex gap-1 p-3 bg-gray-50 border-b overflow-x-auto flex-shrink-0">
            {schoolDays.map(day => {
              const isToday = day === todayName;
              const isFocused = day === focusDay;
              return (
                <button
                  key={day}
                  onClick={() => setFocusDay(day)}
                  className={`px-3 py-1.5 rounded-full font-medium text-sm whitespace-nowrap transition-all ${
                    isFocused
                      ? 'bg-teal-500 text-white shadow-md'
                      : isToday
                        ? 'bg-amber-100 text-amber-700 hover:bg-amber-200'
                        : 'bg-white text-gray-600 hover:bg-gray-100'
                  }`}
                >
                  {isToday ? `ğŸ“ ${day.slice(0,3)}` : day.slice(0,3)}
                </button>
              );
            })}
          </div>

          {/* Content */}
          <div ref={scrollRef} className="flex-1 overflow-y-auto min-h-0 p-4">
            {allTasks.length === 0 ? (
              <div className="text-center py-12 text-gray-500">
                <div className="text-5xl mb-3">ğŸ‰</div>
                <p className="font-medium">No prep needed!</p>
                <p className="text-sm mt-1">Plan some lunches to see your to-do list</p>
              </div>
            ) : (
              <div className="space-y-4">
                {/* Focused Day Header */}
                <div className="text-center py-2">
                  <h3 className="text-lg font-bold text-gray-800">
                    {focusDay === todayName ? "ğŸ¯ Today's Tasks" : `ğŸ“… ${focusDay}'s Prep`}
                  </h3>
                  {focusDay === schoolDays[todayIndex + 1] && (
                    <p className="text-xs text-gray-500">Prep tonight for tomorrow!</p>
                  )}
                </div>

                {/* Tonight's Prep (night before items) */}
                {focusDayTasks.tonight.length > 0 && (
                  <div>
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-lg">ğŸŒ™</span>
                      <h4 className="font-bold text-purple-700 text-sm">Do Tonight</h4>
                    </div>
                    <div className="space-y-2 bg-purple-50 rounded-xl p-2">
                      {focusDayTasks.tonight.map(task => (
                        <TaskItem key={task.id} task={task} />
                      ))}
                    </div>
                  </div>
                )}

                {/* Morning Tasks */}
                {focusDayTasks.morning.length > 0 && (
                  <div>
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-lg">â˜€ï¸</span>
                      <h4 className="font-bold text-amber-700 text-sm">
                        {focusDay === todayName ? 'Morning Tasks' : `${focusDay} Morning`}
                      </h4>
                    </div>
                    <div className="space-y-2 bg-amber-50 rounded-xl p-2">
                      {focusDayTasks.morning.map(task => (
                        <TaskItem key={task.id} task={task} />
                      ))}
                    </div>
                  </div>
                )}

                {/* Batch Prep */}
                {focusDayTasks.batch.length > 0 && (
                  <div>
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-lg">ğŸ“¦</span>
                      <h4 className="font-bold text-blue-700 text-sm">Batch Prep (Do Anytime)</h4>
                    </div>
                    <div className="space-y-2 bg-blue-50 rounded-xl p-2">
                      {focusDayTasks.batch.map(task => (
                        <TaskItem key={task.id} task={task} />
                      ))}
                    </div>
                  </div>
                )}

                {/* Empty state for focused day */}
                {totalFocusTasks === 0 && (
                  <div className="text-center py-8 text-gray-400">
                    <p>No tasks for {focusDay}!</p>
                    <p className="text-sm">Check other days or plan more lunches</p>
                  </div>
                )}
              </div>
            )}
          </div>

          {/* Footer */}
          <div className="p-4 bg-gray-50 border-t rounded-b-3xl flex-shrink-0">
            <div className="flex justify-between items-center">
              <div className="text-sm text-gray-500">
                {completedFocusTasks === totalFocusTasks && totalFocusTasks > 0 ? (
                  <span className="text-green-600 font-medium">ğŸ‰ All done for {focusDay}!</span>
                ) : null}
              </div>
              <button
                onClick={onClose}
                className="px-6 py-2.5 bg-gradient-to-r from-green-500 to-teal-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all"
              >
                Done
              </button>
            </div>
          </div>
        </div>
      </div>
      
      {/* Who Did It Popup */}
      {askWhoDidIt && (
        <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
          <div className="bg-white rounded-3xl shadow-2xl p-6 max-w-sm w-full text-center">
            <div className="text-4xl mb-3">âœ…</div>
            <h3 className="text-xl font-bold text-gray-800 mb-2" style={{ fontFamily: 'Fredoka, sans-serif' }}>
              Who did this task?
            </h3>
            <p className="text-gray-500 text-sm mb-6">Track who's doing the prep work!</p>
            
            <div className="flex flex-col gap-3">
              <button
                onClick={() => handleWhoDidItSelect('mum')}
                className="w-full py-3 bg-gradient-to-r from-pink-400 to-pink-500 text-white font-bold rounded-xl shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2"
              >
                <span className="text-2xl">ğŸ‘©</span> Mum did it!
              </button>
              <button
                onClick={() => handleWhoDidItSelect('dad')}
                className="w-full py-3 bg-gradient-to-r from-blue-400 to-blue-500 text-white font-bold rounded-xl shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2"
              >
                <span className="text-2xl">ğŸ‘¨</span> Dad did it!
              </button>
              <button
                onClick={() => handleWhoDidItSelect('both')}
                className="w-full py-3 bg-gradient-to-r from-purple-400 to-purple-500 text-white font-bold rounded-xl shadow-md hover:shadow-lg transition-all flex items-center justify-center gap-2"
              >
                <span className="text-2xl">ğŸ‘«</span> We both did!
              </button>
            </div>
            
            <button
              onClick={() => setAskWhoDidIt(null)}
              className="mt-4 text-gray-400 hover:text-gray-600 text-sm"
            >
              Cancel
            </button>
          </div>
        </div>
      )}
    </div>
  );
};

// New Week Summary Modal
const NewWeekSummary = ({ children, weekPlan, ateAllLunch, parentCredits, todoCredits, onStartNewWeek, onClose }) => {
  // Calculate stats for each child
  const childStats = children.map(child => {
    const childKey = child.id;
    const childWeekPlan = weekPlan[childKey] || {};
    const childAteAll = ateAllLunch[childKey] || {};
    
    let totalItems = 0;
    let daysPlanned = 0;
    let daysAteAll = 0;
    let dislikedItemsTried = 0;
    
    DAYS.forEach(day => {
      const dayPlan = childWeekPlan[day];
      if (dayPlan) {
        const dayItems = Object.values(dayPlan).reduce((sum, arr) => sum + (arr?.length || 0), 0);
        if (dayItems > 0) {
          daysPlanned++;
          totalItems += dayItems;
          
          // Check for disliked items
          Object.values(dayPlan).forEach(items => {
            if (items && Array.isArray(items)) {
              items.forEach(item => {
                if (child.dislikes?.includes(item.id)) {
                  dislikedItemsTried++;
                }
              });
            }
          });
        }
        if (childAteAll[day]) {
          daysAteAll++;
        }
      }
    });
    
    return {
      child,
      totalItems,
      daysPlanned,
      daysAteAll,
      dislikedItemsTried,
      points: child.points || 0
    };
  });

  // Calculate parent competition stats (lunches + todos)
  const parentStats = { mum: { lunches: 0, todos: 0 }, dad: { lunches: 0, todos: 0 }, both: { lunches: 0, todos: 0 } };
  
  // Count lunches made
  Object.values(parentCredits || {}).forEach(childCredits => {
    Object.values(childCredits || {}).forEach(dayCredits => {
      if (dayCredits?.madeBy === 'mum') parentStats.mum.lunches++;
      else if (dayCredits?.madeBy === 'dad') parentStats.dad.lunches++;
      else if (dayCredits?.madeBy === 'both') parentStats.both.lunches++;
    });
  });
  
  // Count todos completed
  Object.values(todoCredits || {}).forEach(credit => {
    if (credit === 'mum') parentStats.mum.todos++;
    else if (credit === 'dad') parentStats.dad.todos++;
    else if (credit === 'both') parentStats.both.todos++;
  });
  
  const mumTotal = parentStats.mum.lunches + parentStats.mum.todos;
  const dadTotal = parentStats.dad.lunches + parentStats.dad.todos;
  const bothTotal = parentStats.both.lunches + parentStats.both.todos;
  const totalWork = mumTotal + dadTotal + bothTotal;
  
  const getParentWinner = () => {
    if (mumTotal > dadTotal) return 'mum';
    if (dadTotal > mumTotal) return 'dad';
    return 'tie';
  };
  const winner = getParentWinner();

  const totalPointsEarned = childStats.reduce((sum, s) => sum + s.points, 0);
  const allAteWell = childStats.every(s => s.daysAteAll >= s.daysPlanned * 0.8);
  
  // Stable message index based on totals (won't change on re-render)
  const messageIndex = (mumTotal + dadTotal + bothTotal + totalPointsEarned) % 10;
  
  // Find the kid with most points for winner badge
  const topKid = childStats.reduce((best, curr) => 
    curr.points > (best?.points || 0) ? curr : best, null);

  // Cheeky messages with subtle innuendos ğŸ˜
  // Key = the winner. So 'mum' messages play when MUM wins.
  const funMessages = {
    mum: [
      "Mum's been the kitchen queen! ğŸ‘©â€ğŸ³ Daddy... time to treat her like royalty tonight ğŸ‘‘ğŸ˜",
      "Mum wins! ğŸ† She deserves some quality time... after the kids go to bed ğŸ˜‰",
      "Mum worked her magic all week! Time for Dad to work some magic of his own... like a massage ğŸ’†â€â™€ï¸ğŸ˜",
      "Mummy's hands were busy! Now Dad needs to keep her hands busy... holding a glass of wine! ğŸ·ğŸ˜‰",
      "Mum was on fire in the kitchen! ğŸ”¥ Now it's Dad's turn to... heat things up? ğŸ˜",
      "Queen of the lunchbox! ğŸ‘‘ Dad, maybe run her a bath... and join her? ğŸ›ğŸ’•",
      "Mum absolutely smashed it! Time for Dad to smash... some chores so she can relax ğŸ˜",
      "Mummy brought the heat! ğŸŒ¶ï¸ Your move Dad... keep that energy going tonight ğŸ˜‰",
      "She packed, she prepped, she conquered! ğŸ’ª Dad owes her a foot rub... for starters ğŸ¦¶ğŸ˜",
      "Mum = lunch legend! Dad, you know what legends deserve... a lie-in and breakfast in bed! ğŸ›ï¸"
    ],
    dad: [
      "Dad's been working hard in the kitchen! ğŸ‘¨â€ğŸ³ Mummy... time to reward him in the bedroom... with breakfast in bed! ğŸ˜",
      "Dad wins this week! ğŸ† He deserves something special tonight... like a back rub that leads to... a good night's sleep! ğŸ’†â€â™‚ï¸",
      "Dad put in the effort! Maybe Mum can show her appreciation... after the kids are asleep ğŸ˜‰",
      "Dad's hands were busy all week! ğŸ‘¨â€ğŸ³ Time for Mum to keep his hands busy... doing dishes! Just kidding ğŸ˜",
      "Daddy dominated the kitchen! Now it's Mummy's turn to... dominate movie night choices? ğŸ¬ğŸ˜‰",
      "King of the lunchbox! ğŸ‘‘ Mum, maybe show him just how impressed you are... privately ğŸ”’ğŸ˜",
      "Dad absolutely killed it! Time for Mum to kill... the lights ğŸ˜‰ğŸ’¡",
      "Daddy brought the snacks! ğŸ± Now Mum... bring something to the bedroom ğŸ˜",
      "He chopped, he prepped, he won! ğŸ† Mum, you know what winners deserve... ğŸ˜‰",
      "Dad = lunch legend! Mum, legends deserve... well, you know what legends deserve ğŸ˜ğŸ”¥"
    ],
    tie: [
      "A perfect tie! ğŸ¤ You both deserve a reward... maybe together? ğŸ˜",
      "Equal effort deserves equal... celebration! Lock the bedroom door! ğŸ”’ğŸ’•",
      "Teamwork makes the dream work! ğŸ’ª Now celebrate as a team... privately ğŸ˜‰",
      "50/50 split! That's called... partnership goals! Time for a date night! ğŸ’‘",
      "You're both winners! The real reward is each other... after 8pm ğŸ˜",
      "Perfect partners in the kitchen! ğŸ‘¨â€ğŸ³ğŸ‘©â€ğŸ³ Now be perfect partners... elsewhere ğŸ˜‰",
      "Balanced effort = balanced reward! Kids to bed early tonight? ğŸ›ï¸ğŸ˜",
      "Tag team champions! ğŸ† Now tag team... Netflix? Or... ğŸ˜‰",
      "What a duo! ğŸ’• You deserve each other... literally, tonight! ğŸ˜",
      "Kitchen power couple! ğŸ”¥ Now take that power... to the bedroom! ğŸ˜‰ğŸ”’"
    ]
  };

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden">
        {/* Header with confetti effect and Benny */}
        <div className="bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500 p-6 text-white text-center relative overflow-hidden">
          <div className="absolute inset-0 opacity-20">
            {[...Array(20)].map((_, i) => (
              <div
                key={i}
                className="absolute text-2xl animate-bounce"
                style={{
                  left: `${Math.random() * 100}%`,
                  top: `${Math.random() * 100}%`,
                  animationDelay: `${Math.random() * 2}s`,
                  animationDuration: `${1 + Math.random() * 2}s`
                }}
              >
                {['ğŸ‰', 'â­', 'ğŸŒŸ', 'âœ¨', 'ğŸŠ'][Math.floor(Math.random() * 5)]}
              </div>
            ))}
          </div>
          <div className="relative">
            {/* Benny celebrating */}
            <div className="mb-2">
              <BennyWombat mood="happy" size="md" />
            </div>
            <h2 className="text-3xl font-black mb-2" style={{ fontFamily: 'Fredoka, Comic Sans MS, cursive' }}>
              ğŸ‰ Week Complete!
            </h2>
            <p className="text-white/90">Bonzer effort! Let's see how you went!</p>
          </div>
        </div>

        {/* Content */}
        <div className="p-4 max-h-[50vh] overflow-y-auto">
          {/* Kids summary */}
          {childStats.map(({ child, totalItems, daysPlanned, daysAteAll, dislikedItemsTried, points }) => {
            const isTopKid = topKid && topKid.child.id === child.id && points > 0 && childStats.length > 1;
            return (
            <div key={child.id} className={`rounded-2xl p-4 mb-3 border-2 relative overflow-hidden ${
              isTopKid 
                ? 'bg-gradient-to-r from-yellow-50 via-amber-50 to-yellow-50 border-yellow-400 ring-2 ring-yellow-400 ring-offset-2' 
                : 'bg-gradient-to-r from-gray-50 to-white border-gray-100'
            }`}>
              {/* Winner Badge */}
              {isTopKid && (
                <div className="absolute -top-1 -right-1">
                  <div className="bg-gradient-to-br from-yellow-400 to-amber-500 text-white px-3 py-1 rounded-bl-xl rounded-tr-xl font-bold text-xs shadow-lg animate-pulse">
                    ğŸ‘‘ TOP SCORER!
                  </div>
                </div>
              )}
              {isTopKid && (
                <div className="absolute inset-0 pointer-events-none">
                  <div className="absolute top-2 left-2 text-2xl animate-bounce" style={{ animationDelay: '0s' }}>â­</div>
                  <div className="absolute top-4 right-12 text-xl animate-bounce" style={{ animationDelay: '0.2s' }}>âœ¨</div>
                  <div className="absolute bottom-2 left-8 text-lg animate-bounce" style={{ animationDelay: '0.4s' }}>ğŸŒŸ</div>
                </div>
              )}
              
              <div className="flex items-center gap-3 mb-3">
                <div className={`w-12 h-12 rounded-full flex items-center justify-center text-2xl ${
                  isTopKid 
                    ? 'bg-gradient-to-br from-yellow-200 to-amber-300 ring-2 ring-yellow-400' 
                    : 'bg-gradient-to-br from-amber-100 to-orange-100'
                }`}>
                  {child.avatar || 'ğŸ‘¦'}
                </div>
                <div>
                  <h3 className="font-bold text-lg text-gray-800" style={{ fontFamily: 'Fredoka, Comic Sans MS, cursive' }}>
                    {child.name} {isTopKid && 'ğŸ†'}
                  </h3>
                  <div className="flex items-center gap-2">
                    <span className={`text-xs px-2 py-0.5 rounded-full font-bold ${
                      isTopKid 
                        ? 'bg-gradient-to-r from-yellow-400 to-amber-500 text-white animate-pulse' 
                        : 'bg-gradient-to-r from-yellow-400 to-amber-500 text-white'
                    }`}>
                      â­ {points} points
                    </span>
                    {isTopKid && <span className="text-xs text-amber-600 font-bold">WINNER!</span>}
                  </div>
                </div>
              </div>
              
              <div className="grid grid-cols-3 gap-2 text-center">
                <div className="bg-blue-50 rounded-xl p-2">
                  <div className="text-2xl font-bold text-blue-600">{daysPlanned}</div>
                  <div className="text-xs text-blue-600">Days Planned</div>
                </div>
                <div className="bg-green-50 rounded-xl p-2">
                  <div className="text-2xl font-bold text-green-600">{daysAteAll}</div>
                  <div className="text-xs text-green-600">Ate All! ğŸ½ï¸</div>
                </div>
                <div className="bg-orange-50 rounded-xl p-2">
                  <div className="text-2xl font-bold text-orange-600">{dislikedItemsTried}</div>
                  <div className="text-xs text-orange-600">Brave Tries ğŸ’ª</div>
                </div>
              </div>
              
              {daysAteAll >= daysPlanned && daysPlanned > 0 && (
                <div className="mt-3 text-center text-sm font-bold text-green-600 bg-green-50 rounded-xl py-2">
                  ğŸ† Perfect Week! Ate everything!
                </div>
              )}
            </div>
          )})}

          {/* Parent Competition */}
          {totalWork > 0 && (
            <div className={`rounded-2xl p-4 mb-3 text-center border-2 ${
              winner === 'mum' ? 'bg-gradient-to-r from-pink-50 to-rose-50 border-pink-200' :
              winner === 'dad' ? 'bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200' :
              'bg-gradient-to-r from-purple-50 to-violet-50 border-purple-200'
            }`}>
              <h4 className="font-bold text-lg mb-3" style={{ fontFamily: 'Fredoka, Comic Sans MS, cursive' }}>
                ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Parent Showdown! ğŸ‘Š
              </h4>
              
              <div className="flex justify-center gap-4 mb-3">
                <div className={`px-4 py-2 rounded-xl ${winner === 'mum' ? 'bg-pink-200 ring-2 ring-pink-400' : 'bg-pink-100'}`}>
                  <div className="text-2xl">ğŸ‘©</div>
                  <div className="font-bold text-pink-700">{mumTotal} tasks</div>
                  <div className="text-xs text-pink-500">
                    {parentStats.mum.lunches}ğŸ± + {parentStats.mum.todos}âœ…
                  </div>
                </div>
                <div className="flex items-center text-2xl">âš¡</div>
                <div className={`px-4 py-2 rounded-xl ${winner === 'dad' ? 'bg-blue-200 ring-2 ring-blue-400' : 'bg-blue-100'}`}>
                  <div className="text-2xl">ğŸ‘¨</div>
                  <div className="font-bold text-blue-700">{dadTotal} tasks</div>
                  <div className="text-xs text-blue-500">
                    {parentStats.dad.lunches}ğŸ± + {parentStats.dad.todos}âœ…
                  </div>
                </div>
              </div>
              
              {bothTotal > 0 && (
                <div className="text-sm text-purple-600 mb-2">
                  + {bothTotal} tasks done together! ğŸ’•
                </div>
              )}
              
              <p className={`text-sm font-medium italic ${
                winner === 'mum' ? 'text-pink-700' :
                winner === 'dad' ? 'text-blue-700' :
                'text-purple-700'
              }`}>
                {funMessages[winner][messageIndex % funMessages[winner].length]}
              </p>
            </div>
          )}

          {/* Parent appreciation */}
          <div className="bg-gradient-to-r from-pink-50 to-purple-50 rounded-2xl p-4 text-center border-2 border-pink-100">
            <div className="text-4xl mb-2">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
            <h4 className="font-bold text-purple-700 mb-1" style={{ fontFamily: 'Fredoka, Comic Sans MS, cursive' }}>
              {allAteWell ? 'Super Parents Award!' : 'Amazing Job, Mum & Dad!'}
            </h4>
            <p className="text-sm text-purple-600">
              {allAteWell 
                ? 'Your kids ate so well this week! You\'re crushing this parenting thing! ğŸ‰'
                : 'Thanks for creating healthy, delicious lunches with love. Your effort makes all the difference! ğŸ’•'
              }
            </p>
            {totalPointsEarned > 0 && (
              <div className="mt-2 text-xs text-purple-500">
                Family earned {totalPointsEarned} total points this week!
              </div>
            )}
          </div>
        </div>

        {/* Actions */}
        <div className="p-4 bg-gray-50 border-t flex gap-3">
          <button
            onClick={onClose}
            className="flex-1 px-4 py-3 bg-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-300 transition-all"
          >
            Keep Planning
          </button>
          <button
            onClick={onStartNewWeek}
            className="flex-1 px-4 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition-all"
          >
            ğŸš€ Start Fresh Week!
          </button>
        </div>
      </div>
    </div>
  );
};

// Week History Modal
const WeekHistoryModal = ({ history, onClose }) => {
  const [expandedWeek, setExpandedWeek] = useState(null);
  const [selectedChild, setSelectedChild] = useState(null);
  const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
  
  if (!history || history.length === 0) {
    return (
      <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md p-6 text-center">
          <div className="text-5xl mb-4">ğŸ“Š</div>
          <h2 className="text-xl font-bold text-gray-800 mb-2">No History Yet</h2>
          <p className="text-gray-500 mb-6">Complete your first week to start tracking progress!</p>
          <button onClick={onClose} className="px-6 py-2 bg-gray-200 rounded-xl font-bold">Close</button>
        </div>
      </div>
    );
  }
  
  const expandedWeekData = expandedWeek ? history.find(w => w.id === expandedWeek) : null;
  const selectedChildData = expandedWeekData && selectedChild 
    ? expandedWeekData.childStats?.find(c => c.id === selectedChild) 
    : null;
  
  return (
    <div className="fixed inset-0 bg-black/50 z-50 overflow-y-auto">
      <div className="min-h-full flex items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-2xl w-full max-w-lg my-4">
          <div className="bg-gradient-to-r from-indigo-500 to-purple-600 p-4 sm:p-6 text-white rounded-t-3xl">
            <h2 className="text-xl sm:text-2xl font-bold">ğŸ“Š Week History</h2>
            <p className="text-white/80 text-sm">
              {expandedWeek ? 'Tap a child to see their lunches' : 'Tap a week to see details'}
            </p>
          </div>
          
          <div className="p-4 max-h-[60vh] overflow-y-auto space-y-3">
            {expandedWeek ? (
              <>
                {/* Back button */}
                <button 
                  onClick={() => { setExpandedWeek(null); setSelectedChild(null); }}
                  className="flex items-center gap-2 text-indigo-600 font-medium mb-2"
                >
                  â† Back to all weeks
                </button>
                
                <div className="bg-indigo-50 rounded-xl p-3 mb-3">
                  <span className="font-bold text-indigo-800">Week ending {expandedWeekData?.weekEnding}</span>
                </div>
                
                {/* Child selector */}
                <div className="flex gap-2 flex-wrap mb-3">
                  {expandedWeekData?.childStats?.map(stat => (
                    <button
                      key={stat.id}
                      onClick={() => setSelectedChild(stat.id)}
                      className={`flex items-center gap-2 px-3 py-2 rounded-xl transition-all ${
                        selectedChild === stat.id 
                          ? 'bg-indigo-500 text-white' 
                          : 'bg-gray-100 hover:bg-gray-200'
                      }`}
                    >
                      <span>{stat.avatar}</span>
                      <span className="font-medium">{stat.name}</span>
                    </button>
                  ))}
                </div>
                
                {/* Day details for selected child */}
                {selectedChildData?.weekPlan ? (
                  <div className="space-y-2">
                    {DAYS.map(day => {
                      const dayPlan = selectedChildData.weekPlan[day];
                      const hasItems = dayPlan && Object.values(dayPlan).some(items => items?.length > 0);
                      
                      if (!hasItems) {
                        return (
                          <div key={day} className="bg-gray-50 rounded-xl p-3">
                            <span className="font-medium text-gray-400">{day}: No lunch planned</span>
                          </div>
                        );
                      }
                      
                      return (
                        <div key={day} className="bg-gray-50 rounded-xl p-3">
                          <span className="font-bold text-gray-800">{day}</span>
                          <div className="flex flex-wrap gap-1 mt-2">
                            {Object.entries(dayPlan).map(([category, items]) => 
                              items?.map(item => (
                                <span key={item.id} className="text-xs bg-white px-2 py-1 rounded-full border">
                                  {item.emoji || 'ğŸ½ï¸'} {item.name}
                                </span>
                              ))
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                ) : (
                  <p className="text-gray-500 text-center py-4">Select a child to see their lunches</p>
                )}
              </>
            ) : (
              /* Week list */
              history.map((week, idx) => (
                <button
                  key={week.id}
                  onClick={() => { setExpandedWeek(week.id); setSelectedChild(week.childStats?.[0]?.id); }}
                  className="w-full bg-gray-50 hover:bg-gray-100 rounded-xl p-3 text-left transition-all"
                >
                  <div className="flex justify-between items-center mb-2">
                    <span className="font-bold text-gray-800">Week ending {week.weekEnding}</span>
                    <div className="flex items-center gap-2">
                      {idx === 0 && <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">Latest</span>}
                      <span className="text-indigo-500">â†’</span>
                    </div>
                  </div>
                  <div className="grid grid-cols-2 gap-2 text-sm">
                    {week.childStats?.map(stat => (
                      <div key={stat.id} className="flex items-center gap-2">
                        <span>{stat.avatar}</span>
                        <span className="text-gray-600">{stat.name}: <span className="font-bold text-green-600">+{stat.pointsEarned}pts</span></span>
                      </div>
                    ))}
                  </div>
                  <div className="text-xs text-gray-500 mt-2">
                    {week.totalMealsPlanned} meals planned â€¢ Tap to view details
                  </div>
                </button>
              ))
            )}
          </div>
          
          <div className="p-4 border-t">
            <button onClick={onClose} className="w-full py-2 bg-gray-200 rounded-xl font-bold">Close</button>
          </div>
        </div>
      </div>
    </div>
  );
};

// Favorites Modal
const FavoritesModal = ({ favorites, onApply, onDelete, onClose, children, selectedChild, weekPlan }) => {
  const [selectedFavorite, setSelectedFavorite] = useState(null);
  const [applyTo, setApplyTo] = useState({ child: selectedChild?.id, day: 'Monday' });
  const DAYS = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
  
  return (
    <div className="fixed inset-0 bg-black/50 z-50 overflow-y-auto">
      <div className="min-h-full flex items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-2xl w-full max-w-lg my-4">
          <div className="bg-gradient-to-r from-pink-500 to-rose-500 p-4 sm:p-6 text-white rounded-t-3xl">
            <h2 className="text-xl sm:text-2xl font-bold">â¤ï¸ Favorite Lunches</h2>
            <p className="text-white/80 text-sm">Quick-apply saved combinations</p>
          </div>
          
          <div className="p-4 max-h-96 overflow-y-auto">
            {favorites.length === 0 ? (
              <div className="text-center py-8 text-gray-500">
                <div className="text-4xl mb-2">ğŸ’¾</div>
                <p>No favorites saved yet!</p>
                <p className="text-sm mt-1">Save a lunch from the planner to reuse it.</p>
              </div>
            ) : (
              <div className="space-y-3">
                {favorites.map(fav => {
                  const itemCount = Object.values(fav.items || {}).reduce((sum, arr) => sum + (arr?.length || 0), 0);
                  return (
                    <div key={fav.id} className={`border-2 rounded-xl p-3 cursor-pointer transition-all ${selectedFavorite === fav.id ? 'border-pink-500 bg-pink-50' : 'border-gray-200'}`}
                      onClick={() => setSelectedFavorite(fav.id)}>
                      <div className="flex justify-between items-start">
                        <div>
                          <h3 className="font-bold text-gray-800">{fav.name}</h3>
                          <p className="text-sm text-gray-500">{itemCount} items</p>
                        </div>
                        <button onClick={(e) => { e.stopPropagation(); onDelete(fav.id); }}
                          className="text-red-400 hover:text-red-600 p-1">ğŸ—‘ï¸</button>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
            
            {selectedFavorite && (
              <div className="mt-4 p-3 bg-gray-50 rounded-xl">
                <p className="text-sm font-medium text-gray-700 mb-2">Apply to:</p>
                <div className="flex gap-2 flex-wrap">
                  <select value={applyTo.child} onChange={(e) => setApplyTo(prev => ({ ...prev, child: e.target.value }))}
                    className="flex-1 p-2 border rounded-lg text-sm">
                    {children.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                  </select>
                  <select value={applyTo.day} onChange={(e) => setApplyTo(prev => ({ ...prev, day: e.target.value }))}
                    className="flex-1 p-2 border rounded-lg text-sm">
                    {DAYS.map(d => <option key={d} value={d}>{d}</option>)}
                  </select>
                </div>
                <button onClick={() => { onApply(selectedFavorite, applyTo.child, applyTo.day); setSelectedFavorite(null); }}
                  className="w-full mt-2 py-2 bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-lg font-bold">
                  Apply Favorite
                </button>
              </div>
            )}
          </div>
          
          <div className="p-4 border-t">
            <button onClick={onClose} className="w-full py-2 bg-gray-200 rounded-xl font-bold">Close</button>
          </div>
        </div>
      </div>
    </div>
  );
};

// Copy Lunch Modal
const CopyLunchModal = ({ day, fromChild, children, onCopy, onClose }) => {
  const otherChildren = children.filter(c => c.id !== fromChild?.id);
  
  if (otherChildren.length === 0) {
    return (
      <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6 text-center">
          <div className="text-4xl mb-3">ğŸ‘¶</div>
          <h3 className="font-bold text-gray-800 mb-2">Add Another Child</h3>
          <p className="text-gray-500 text-sm mb-4">You need at least 2 children to copy lunches between them.</p>
          <button onClick={onClose} className="px-6 py-2 bg-gray-200 rounded-xl font-bold">OK</button>
        </div>
      </div>
    );
  }
  
  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl w-full max-w-sm p-6">
        <h3 className="text-lg font-bold text-gray-800 mb-1">ğŸ“‹ Copy {day}'s Lunch</h3>
        <p className="text-sm text-gray-500 mb-4">From {fromChild?.name} to:</p>
        
        <div className="space-y-2">
          {otherChildren.map(child => (
            <button key={child.id}
              onClick={() => onCopy(fromChild.id, child.id, day)}
              className="w-full p-3 bg-gray-50 hover:bg-blue-50 rounded-xl flex items-center gap-3 transition-all">
              <span className="text-2xl">{child.avatar || 'ğŸ‘¦'}</span>
              <span className="font-medium text-gray-800">{child.name}</span>
            </button>
          ))}
        </div>
        
        <button onClick={onClose} className="w-full mt-4 py-2 bg-gray-200 rounded-xl font-bold">Cancel</button>
      </div>
    </div>
  );
};

// Progress Bar Component - guides users through weekly workflow
const PROGRESS_STEPS = [
  { id: 'plan', label: 'Plan', emoji: 'ğŸ“', description: 'Plan at least one lunch' },
  { id: 'shop', label: 'Shop', emoji: 'ğŸ›’', description: 'Check off a shopping item' },
  { id: 'prep', label: 'Prep', emoji: 'âœ…', description: 'Complete a to-do task' },
  { id: 'chore', label: 'Chore', emoji: 'ğŸ§¹', description: 'Complete a chore' },
  { id: 'make', label: 'Make', emoji: 'ğŸ‘¨â€ğŸ³', description: 'Mark who made lunch' },
  { id: 'eat', label: 'Eat', emoji: 'ğŸ½ï¸', description: 'Mark lunch as eaten' },
];

const ProgressBar = ({ progress, onShowDetails, onSkip }) => {
  const completedSteps = [
    progress.plannedLunch,
    progress.checkedShoppingItem,
    progress.completedTodo,
    progress.completedChore,
    progress.madeLunch,
    progress.ateAll
  ].filter(Boolean).length;
  
  const isComplete = completedSteps === 6 || progress.skipped;
  
  return (
    <div 
      onClick={onShowDetails}
      className="bg-white/80 backdrop-blur-sm rounded-2xl p-3 shadow-md cursor-pointer hover:shadow-lg transition-all mb-4"
    >
      <div className="flex items-center justify-between mb-2">
        <div className="flex flex-col">
          <span className="text-sm font-bold text-gray-700">Weekly Progress</span>
          <span className="text-[10px] text-gray-400">Tap for more info</span>
        </div>
        <div className="flex items-center gap-2">
          {isComplete && <span className="text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded-full">Complete!</span>}
          <span className="text-xs text-gray-500">{completedSteps}/6 steps</span>
        </div>
      </div>
      <div className="flex gap-1">
        {PROGRESS_STEPS.map((step, idx) => {
          const isStepComplete = [
            progress.plannedLunch,
            progress.checkedShoppingItem,
            progress.completedTodo,
            progress.completedChore,
            progress.madeLunch,
            progress.ateAll
          ][idx];
          return (
            <div 
              key={step.id}
              className={`flex-1 h-2 rounded-full transition-all ${
                isStepComplete ? 'bg-gradient-to-r from-green-400 to-emerald-500' : 'bg-gray-200'
              }`}
            />
          );
        })}
      </div>
    </div>
  );
};

// Progress Details Modal
const ProgressDetails = ({ progress, onClose, onSkip }) => {
  const steps = [
    { ...PROGRESS_STEPS[0], complete: progress.plannedLunch },
    { ...PROGRESS_STEPS[1], complete: progress.checkedShoppingItem },
    { ...PROGRESS_STEPS[2], complete: progress.completedTodo },
    { ...PROGRESS_STEPS[3], complete: progress.completedChore },
    { ...PROGRESS_STEPS[4], complete: progress.madeLunch },
    { ...PROGRESS_STEPS[5], complete: progress.ateAll },
  ];
  
  const currentStepIndex = steps.findIndex(s => !s.complete);
  const isComplete = currentStepIndex === -1 || progress.skipped;
  
  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl max-w-md w-full overflow-hidden">
        <div className="bg-gradient-to-r from-purple-500 to-indigo-500 p-5 text-white text-center">
          <div className="text-4xl mb-2">ğŸ“Š</div>
          <h2 className="text-xl font-bold">Your Weekly Progress</h2>
          <p className="text-white/80 text-sm mt-1">Your lunchbox journey this week</p>
        </div>
        
        <div className="p-5">
          <div className="space-y-3">
            {steps.map((step, idx) => (
              <div 
                key={step.id}
                className={`flex items-center gap-3 p-3 rounded-xl transition-all ${
                  step.complete 
                    ? 'bg-green-50 border border-green-200' 
                    : idx === currentStepIndex && !progress.skipped
                      ? 'bg-orange-50 border-2 border-orange-300'
                      : 'bg-gray-50 border border-gray-200'
                }`}
              >
                <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl ${
                  step.complete ? 'bg-green-500 text-white' : 'bg-gray-200'
                }`}>
                  {step.complete ? 'âœ“' : step.emoji}
                </div>
                <div className="flex-1">
                  <p className={`font-bold ${step.complete ? 'text-green-700' : 'text-gray-700'}`}>
                    {step.label}
                  </p>
                  <p className="text-xs text-gray-500">{step.description}</p>
                </div>
                {idx === currentStepIndex && !step.complete && !progress.skipped && (
                  <span className="text-xs bg-orange-200 text-orange-700 px-2 py-1 rounded-full">Next</span>
                )}
              </div>
            ))}
          </div>
          
          {!isComplete && (
            <button
              onClick={onSkip}
              className="w-full mt-4 py-3 text-gray-500 font-medium hover:bg-gray-100 rounded-xl transition-all text-sm"
            >
              Skip this week â†’
            </button>
          )}
          
          <button
            onClick={onClose}
            className="w-full mt-2 py-3 bg-gradient-to-r from-purple-500 to-indigo-500 text-white font-bold rounded-xl"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  );
};

// Calculate max possible weekly points for guidance
const calculateMaxWeeklyPoints = () => {
  // Per lunchbox slot points (assuming average full lunchbox)
  // Typical lunchbox: 1 fruit (10), 1 veggie (15), 1 protein (20), 1 dairy (12), 1 grain (5), 1 drink (5) = 67 pts
  // Plus possible extras and "ate all" bonus (10) = ~77 pts per day
  // 5 school days = ~385 pts per week (realistic max)
  // Theoretical max with all slots filled: ~500-600 pts
  return { realistic: 400, theoretical: 600 };
};

// Rewards Modal Component
const RewardsModal = ({ rewards, onAddReward, onDeleteReward, onRedeemReward, children, onClose }) => {
  const [showAddForm, setShowAddForm] = useState(false);
  const [newRewardName, setNewRewardName] = useState('');
  const [newRewardPoints, setNewRewardPoints] = useState(50);
  const [selectedChild, setSelectedChild] = useState(children[0]?.id || null);
  const [error, setError] = useState('');
  
  const maxPoints = calculateMaxWeeklyPoints();
  
  const handleAddReward = () => {
    if (!newRewardName.trim()) {
      setError('Please enter a reward name');
      return;
    }
    if (newRewardPoints < 10) {
      setError('Minimum 10 points required');
      return;
    }
    
    onAddReward({
      id: Date.now(),
      name: newRewardName.trim(),
      pointsCost: newRewardPoints,
      createdAt: new Date().toISOString()
    });
    
    setNewRewardName('');
    setNewRewardPoints(50);
    setShowAddForm(false);
    setError('');
  };
  
  const getPointRangeLabel = (points) => {
    if (points <= 50) return { label: 'Quick Win', color: 'text-green-600', desc: '~1 day of healthy eating' };
    if (points <= 150) return { label: 'Short Goal', color: 'text-blue-600', desc: '~2-3 days of healthy eating' };
    if (points <= 300) return { label: 'Weekly Goal', color: 'text-purple-600', desc: '~1 week of healthy eating' };
    if (points <= 500) return { label: 'Big Achievement', color: 'text-orange-600', desc: '~1-2 weeks of healthy eating' };
    if (points <= 1000) return { label: 'Epic Goal', color: 'text-red-600', desc: '~2-3 weeks of consistency' };
    if (points <= 2000) return { label: 'Super Epic Goal', color: 'text-pink-600', desc: '~1 month of great eating' };
    if (points <= 3500) return { label: 'Legendary Goal', color: 'text-indigo-600', desc: '~2 months - amazing dedication!' };
    return { label: 'Ultimate Champion', color: 'text-amber-600', desc: '~3+ months - the ultimate reward!' };
  };
  
  const pointRange = getPointRangeLabel(newRewardPoints);
  
  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl max-w-md w-full overflow-hidden max-h-[90vh] flex flex-col">
        {/* Header */}
        <div className="bg-gradient-to-r from-amber-500 to-orange-500 p-5 text-white text-center flex-shrink-0">
          <div className="text-4xl mb-2">ğŸ†</div>
          <h2 className="text-xl font-bold">Family Rewards</h2>
          <p className="text-white/80 text-sm mt-1">Create rewards your kids can earn!</p>
        </div>
        
        {/* Content */}
        <div className="p-5 overflow-y-auto flex-1">
          {/* Info Box */}
          <div className="bg-amber-50 border border-amber-200 rounded-xl p-3 mb-4">
            <p className="text-sm text-amber-800">
              <strong>ğŸ’¡ How it works:</strong> Kids earn points by eating healthy + completing chores! 
              Create custom rewards they can work towards! Sweets cost -20 points.
            </p>
            <p className="text-xs text-amber-600 mt-2">
              ğŸ“Š Typical weekly earnings: <strong>~{maxPoints.realistic} points</strong>
            </p>
          </div>
          
          {/* Children's Points Summary */}
          {children.length > 0 && (
            <div className="mb-4">
              <h3 className="text-sm font-bold text-gray-700 mb-2">Current Points</h3>
              <div className="flex flex-wrap gap-2">
                {children.map(child => (
                  <div 
                    key={child.id}
                    className="flex items-center gap-2 bg-gray-100 rounded-full px-3 py-1.5"
                  >
                    <span>{child.avatar}</span>
                    <span className="font-medium text-sm">{child.name}</span>
                    <span className="text-amber-600 font-bold">â­ {child.points || 0}</span>
                  </div>
                ))}
              </div>
            </div>
          )}
          
          {/* Rewards List */}
          <div className="mb-4">
            <h3 className="text-sm font-bold text-gray-700 mb-2">Your Rewards</h3>
            {rewards.length === 0 ? (
              <div className="text-center py-6 bg-gray-50 rounded-xl">
                <div className="text-3xl mb-2">ğŸ</div>
                <p className="text-gray-500 text-sm">No rewards yet!</p>
                <p className="text-gray-400 text-xs">Add your first reward below</p>
              </div>
            ) : (
              <div className="space-y-2">
                {rewards.map(reward => (
                  <div key={reward.id} className="bg-gray-50 rounded-xl p-3">
                    <div className="flex items-center justify-between mb-2">
                      <span className="font-medium text-gray-800">{reward.name}</span>
                      <span className="text-amber-600 font-bold">â­ {reward.pointsCost}</span>
                    </div>
                    <div className="flex items-center gap-2 flex-wrap">
                      {children.map(child => {
                        const canAfford = (child.points || 0) >= reward.pointsCost;
                        return (
                          <button
                            key={child.id}
                            onClick={() => canAfford && onRedeemReward(reward, child)}
                            disabled={!canAfford}
                            className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium transition-all ${
                              canAfford 
                                ? 'bg-green-100 text-green-700 hover:bg-green-200' 
                                : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                            }`}
                          >
                            <span>{child.avatar}</span>
                            <span className="font-bold">{child.name}</span>
                            <span>{canAfford ? 'âœ“ Redeem' : `(Need ${reward.pointsCost - (child.points || 0)})`}</span>
                          </button>
                        );
                      })}
                      <button
                        onClick={() => onDeleteReward(reward.id)}
                        className="ml-auto text-red-400 hover:text-red-600 text-xs"
                      >
                        ğŸ—‘ï¸
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
          
          {/* Add Reward Form */}
          {showAddForm ? (
            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
              <h4 className="font-bold text-gray-800 mb-3">Create New Reward</h4>
              
              <div className="mb-3">
                <label className="block text-sm font-medium text-gray-700 mb-1">Reward Name</label>
                <input
                  type="text"
                  value={newRewardName}
                  onChange={(e) => setNewRewardName(e.target.value)}
                  placeholder="e.g., 1 hour iPad time, Movie night..."
                  className="w-full px-3 py-2 border-2 border-gray-200 rounded-xl focus:border-amber-400 focus:outline-none"
                  maxLength={50}
                />
              </div>
              
              <div className="mb-3">
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  Points Required:
                </label>
                <div className="flex items-center gap-3 mb-2">
                  <input
                    type="range"
                    min="10"
                    max="5000"
                    step="10"
                    value={newRewardPoints}
                    onChange={(e) => setNewRewardPoints(parseInt(e.target.value))}
                    className="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-amber-500"
                  />
                  <input
                    type="number"
                    min="10"
                    max="5000"
                    step="10"
                    value={newRewardPoints}
                    onChange={(e) => {
                      const val = Math.min(5000, Math.max(10, parseInt(e.target.value) || 10));
                      setNewRewardPoints(val);
                    }}
                    className="w-20 px-2 py-1 border-2 border-gray-200 rounded-lg text-center font-bold text-amber-600 focus:border-amber-400 focus:outline-none"
                  />
                </div>
                <div className="flex justify-between text-xs text-gray-400">
                  <span>10</span>
                  <span>500</span>
                  <span>1500</span>
                  <span>3000</span>
                  <span>5000</span>
                </div>
              </div>
              
              {/* Point Range Guidance */}
              <div className={`bg-white rounded-lg p-2 mb-3 border ${pointRange.color.replace('text-', 'border-')}`}>
                <div className="flex items-center justify-between">
                  <span className={`font-bold text-sm ${pointRange.color}`}>{pointRange.label}</span>
                  <span className="text-xs text-gray-500">{pointRange.desc}</span>
                </div>
              </div>
              
              {error && <p className="text-red-500 text-sm mb-3">{error}</p>}
              
              <div className="flex gap-2">
                <button
                  onClick={() => { setShowAddForm(false); setError(''); }}
                  className="flex-1 py-2 text-gray-600 font-medium hover:bg-gray-100 rounded-xl transition-all"
                >
                  Cancel
                </button>
                <button
                  onClick={handleAddReward}
                  className="flex-1 py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold rounded-xl"
                >
                  Add Reward
                </button>
              </div>
            </div>
          ) : (
            <button
              onClick={() => setShowAddForm(true)}
              className="w-full py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold rounded-xl flex items-center justify-center gap-2"
            >
              â• Add New Reward
            </button>
          )}
        </div>
        
        {/* Footer */}
        <div className="p-4 border-t flex-shrink-0">
          <button
            onClick={onClose}
            className="w-full py-3 text-gray-600 font-medium hover:bg-gray-100 rounded-xl transition-all"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  );
};

// More Menu Component
const MoreMenu = ({ onClose, onClearData, onResetPoints }) => {
  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl max-w-sm w-full overflow-hidden">
        <div className="bg-gradient-to-r from-gray-600 to-gray-700 p-5 text-white text-center">
          <div className="text-4xl mb-2">âš™ï¸</div>
          <h2 className="text-xl font-bold">More Options</h2>
        </div>
        
        <div className="p-5 space-y-3">
          <button
            onClick={onResetPoints}
            className="w-full py-4 px-4 bg-amber-50 hover:bg-amber-100 text-amber-600 font-medium rounded-xl transition-all flex items-center justify-center gap-2"
          >
            â­ Reset Points
          </button>
          
          <button
            onClick={onClearData}
            className="w-full py-4 px-4 bg-red-50 hover:bg-red-100 text-red-600 font-medium rounded-xl transition-all flex items-center justify-center gap-2"
          >
            ğŸ—‘ï¸ Clear All Data
          </button>
          
          <button
            onClick={onClose}
            className="w-full py-3 text-gray-500 font-medium hover:bg-gray-100 rounded-xl transition-all"
          >
            â† Back
          </button>
        </div>
      </div>
    </div>
  );
};

// Reset Points Modal
const ResetPointsModal = ({ children, onResetPoints, onClose }) => {
  const [selectedChildren, setSelectedChildren] = useState([]);
  
  const toggleChild = (childId) => {
    setSelectedChildren(prev => 
      prev.includes(childId) 
        ? prev.filter(id => id !== childId)
        : [...prev, childId]
    );
  };
  
  const selectAll = () => {
    setSelectedChildren(children.map(c => c.id));
  };
  
  const selectNone = () => {
    setSelectedChildren([]);
  };
  
  const handleReset = () => {
    if (selectedChildren.length > 0) {
      onResetPoints(selectedChildren);
      onClose();
    }
  };
  
  return (
    <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl max-w-sm w-full overflow-hidden">
        <div className="bg-gradient-to-r from-amber-500 to-orange-500 p-5 text-white text-center">
          <div className="text-4xl mb-2">â­</div>
          <h2 className="text-xl font-bold">Reset Points</h2>
          <p className="text-white/80 text-sm mt-1">Select children to reset their points to 0</p>
        </div>
        
        <div className="p-5">
          {children.length === 0 ? (
            <p className="text-center text-gray-500 py-4">No children added yet</p>
          ) : (
            <>
              {/* Quick Select Buttons */}
              <div className="flex gap-2 mb-4">
                <button
                  onClick={selectAll}
                  className="flex-1 py-2 px-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-xl text-sm transition-all"
                >
                  Select All
                </button>
                <button
                  onClick={selectNone}
                  className="flex-1 py-2 px-3 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium rounded-xl text-sm transition-all"
                >
                  Select None
                </button>
              </div>
              
              {/* Children List */}
              <div className="space-y-2 mb-4">
                {children.map(child => (
                  <button
                    key={child.id}
                    onClick={() => toggleChild(child.id)}
                    className={`w-full flex items-center gap-3 p-3 rounded-xl transition-all ${
                      selectedChildren.includes(child.id)
                        ? 'bg-amber-100 border-2 border-amber-400'
                        : 'bg-gray-50 border-2 border-transparent hover:bg-gray-100'
                    }`}
                  >
                    <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${
                      selectedChildren.includes(child.id)
                        ? 'bg-amber-500 border-amber-500 text-white'
                        : 'border-gray-300'
                    }`}>
                      {selectedChildren.includes(child.id) && 'âœ“'}
                    </div>
                    <span className="text-2xl">{child.avatar}</span>
                    <span className="font-medium text-gray-800 flex-1 text-left">{child.name}</span>
                    <span className="text-amber-600 font-bold">â­ {child.points || 0}</span>
                  </button>
                ))}
              </div>
              
              {/* Action Buttons */}
              <button
                onClick={handleReset}
                disabled={selectedChildren.length === 0}
                className="w-full py-3 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold rounded-xl disabled:opacity-50 disabled:cursor-not-allowed mb-2"
              >
                Reset {selectedChildren.length > 0 ? `${selectedChildren.length} Child${selectedChildren.length > 1 ? 'ren' : ''}'s` : ''} Points to 0
              </button>
            </>
          )}
          
          <button
            onClick={onClose}
            className="w-full py-3 text-gray-500 font-medium hover:bg-gray-100 rounded-xl transition-all"
          >
            Cancel
          </button>
        </div>
      </div>
    </div>
  );
};

// Clear Data Confirmation Modal
const ClearDataConfirm = ({ onConfirm, onCancel }) => {
  const [confirmText, setConfirmText] = useState('');
  
  return (
    <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl max-w-sm w-full overflow-hidden">
        <div className="bg-gradient-to-r from-red-500 to-orange-500 p-5 text-white text-center">
          <div className="text-4xl mb-2">âš ï¸</div>
          <h2 className="text-xl font-bold">Clear All Data?</h2>
        </div>
        
        <div className="p-5">
          <p className="text-gray-600 text-sm mb-4">
            This will permanently delete all your children, meal plans, favorites, and history. 
            Your license key will be preserved.
          </p>
          
          <p className="text-gray-700 text-sm font-medium mb-2">
            Type <span className="font-bold text-red-600">DELETE</span> to confirm:
          </p>
          
          <input
            type="text"
            value={confirmText}
            onChange={(e) => setConfirmText(e.target.value)}
            placeholder="Type DELETE"
            className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-400 focus:outline-none mb-4"
          />
          
          <div className="flex gap-3">
            <button
              onClick={onCancel}
              className="flex-1 py-3 text-gray-600 font-medium hover:bg-gray-100 rounded-xl transition-all"
            >
              Cancel
            </button>
            <button
              onClick={onConfirm}
              disabled={confirmText !== 'DELETE'}
              className="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Delete All
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

// Main App Component

// Chore Manager Component - for adding/editing chores on child profile
const ChoreManager = ({ child, onAddChore, onUpdateChore, onDeleteChore, onShowCopy }) => {
  const [showAddForm, setShowAddForm] = useState(false);
  const [newChoreName, setNewChoreName] = useState('');
  const [newChorePoints, setNewChorePoints] = useState(10);
  const [newChoreDays, setNewChoreDays] = useState([]);
  const [editingChore, setEditingChore] = useState(null);
  const allDays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  
  const toggleDay = (day) => setNewChoreDays(prev => prev.includes(day) ? prev.filter(d => d !== day) : [...prev, day]);
  
  const handleAdd = () => {
    if (!newChoreName.trim()) return;
    onAddChore(child.id, { name: newChoreName.trim(), points: newChorePoints, days: newChoreDays });
    setNewChoreName('');
    setNewChorePoints(10);
    setNewChoreDays([]);
    setShowAddForm(false);
  };
  
  const handleUpdate = () => {
    if (!editingChore || !newChoreName.trim()) return;
    onUpdateChore(child.id, editingChore.id, { name: newChoreName.trim(), points: newChorePoints, days: newChoreDays });
    setEditingChore(null);
    setNewChoreName('');
    setNewChorePoints(10);
    setNewChoreDays([]);
  };
  
  const startEdit = (chore) => {
    setEditingChore(chore);
    setNewChoreName(chore.name);
    setNewChorePoints(chore.points);
    setNewChoreDays(chore.days || []);
    setShowAddForm(true);
  };
  
  const chores = child.chores || [];
  
  return (
    <div className="mt-4">
      <div className="flex items-center justify-between mb-2">
        <label className="block text-sm font-bold text-gray-700">ğŸ§¹ Chores</label>
        <div className="flex gap-2">
          {chores.length > 0 && (
            <button
              type="button"
              onClick={() => onShowCopy(child.id)}
              className="text-xs px-2 py-1 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200"
            >
              Copy to others
            </button>
          )}
          <button
            type="button"
            onClick={() => { setShowAddForm(true); setEditingChore(null); setNewChoreName(''); setNewChorePoints(10); setNewChoreDays([]); }}
            className="text-xs px-2 py-1 bg-green-100 text-green-600 rounded-lg hover:bg-green-200"
          >
            + Add chore
          </button>
        </div>
      </div>
      
      {showAddForm && (
        <div className="bg-amber-50 rounded-xl p-3 mb-3 border border-amber-200">
          <input
            type="text"
            value={newChoreName}
            onChange={(e) => setNewChoreName(e.target.value)}
            placeholder="Chore name (e.g., Make bed)"
            className="w-full p-2 rounded-lg border border-gray-300 mb-2 text-sm"
            maxLength={30}
          />
          <div className="flex items-center gap-2 mb-2">
            <span className="text-sm text-gray-600">Points:</span>
            <input
              type="range"
              min="5"
              max="50"
              step="5"
              value={newChorePoints}
              onChange={(e) => setNewChorePoints(parseInt(e.target.value))}
              className="flex-1"
            />
            <input
              type="number"
              min="5"
              max="50"
              step="5"
              value={newChorePoints}
              onChange={(e) => {
                const val = Math.min(50, Math.max(5, parseInt(e.target.value) || 5));
                setNewChorePoints(val);
              }}
              className="w-14 px-1 py-1 border border-gray-300 rounded text-center font-bold text-amber-600 text-sm focus:border-amber-400 focus:outline-none"
            />
          </div>
          <div className="mb-2">
            <span className="text-xs text-gray-500 block mb-1">Days (optional - leave empty for anytime):</span>
            <div className="flex flex-wrap gap-1">
              {allDays.map(day => (
                <button key={day} type="button" onClick={() => toggleDay(day)}
                  className={`px-2 py-1 text-xs rounded font-medium ${newChoreDays.includes(day) ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-600'}`}
                >{day}</button>
              ))}
            </div>
          </div>
          <div className="flex gap-2">
            <button type="button" onClick={() => { setShowAddForm(false); setEditingChore(null); }}
              className="flex-1 py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm">Cancel</button>
            <button type="button" onClick={editingChore ? handleUpdate : handleAdd} disabled={!newChoreName.trim()}
              className="flex-1 py-2 bg-green-500 text-white rounded-lg text-sm font-bold disabled:opacity-50">{editingChore ? 'Update' : 'Add'}</button>
          </div>
        </div>
      )}
      
      {chores.length === 0 ? (
        <p className="text-xs text-gray-400 text-center py-2">No chores added yet</p>
      ) : (
        <div className="space-y-2">
          {chores.map(chore => (
            <div key={chore.id} className="flex items-center justify-between bg-white rounded-lg p-2 border border-gray-200">
              <div className="flex-1">
                <div className="flex items-center gap-2">
                  <span className="text-sm font-medium">{chore.name}</span>
                  <span className="text-xs bg-amber-100 text-amber-700 px-1.5 py-0.5 rounded-full">{chore.points} pts</span>
                </div>
                {chore.days && chore.days.length > 0 && (
                  <div className="flex gap-1 mt-1">{chore.days.map(d => <span key={d} className="text-[10px] bg-purple-100 text-purple-600 px-1 rounded">{d}</span>)}</div>
                )}
              </div>
              <div className="flex gap-1">
                <button type="button" onClick={() => startEdit(chore)} className="p-1 text-gray-400 hover:text-blue-500">âœï¸</button>
                <button type="button" onClick={() => onDeleteChore(child.id, chore.id)} className="p-1 text-gray-400 hover:text-red-500">ğŸ—‘ï¸</button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
};

// Copy Chores Modal
const CopyChoresModal = ({ fromChild, allChildren, onCopy, onClose }) => {
  const [selectedChores, setSelectedChores] = useState((fromChild?.chores || []).map(c => c.id));
  const [selectedChildren, setSelectedChildren] = useState([]);
  
  if (!fromChild) return null;
  const otherChildren = allChildren.filter(c => c.id !== fromChild.id);
  
  const toggleChore = (choreId) => {
    setSelectedChores(prev => prev.includes(choreId) ? prev.filter(id => id !== choreId) : [...prev, choreId]);
  };
  
  const toggleChild = (childId) => {
    setSelectedChildren(prev => prev.includes(childId) ? prev.filter(id => id !== childId) : [...prev, childId]);
  };
  
  const handleCopy = () => {
    if (selectedChores.length > 0 && selectedChildren.length > 0) {
      onCopy(fromChild.id, selectedChildren, selectedChores);
      onClose();
    }
  };
  
  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl max-w-md w-full overflow-hidden">
        <div className="bg-gradient-to-r from-blue-500 to-cyan-500 p-5 text-white">
          <h2 className="text-xl font-bold">Copy Chores</h2>
          <p className="text-white/80 text-sm">From {fromChild.name} to other children</p>
        </div>
        <div className="p-5">
          <div className="mb-4">
            <h3 className="font-bold text-gray-700 mb-2">Select chores to copy:</h3>
            <div className="space-y-2 max-h-32 overflow-y-auto">
              {(fromChild.chores || []).map(chore => (
                <label key={chore.id} className="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" checked={selectedChores.includes(chore.id)} onChange={() => toggleChore(chore.id)} className="w-4 h-4" />
                  <span className="text-sm">{chore.name}</span>
                  <span className="text-xs text-gray-400">({chore.points} pts)</span>
                </label>
              ))}
            </div>
          </div>
          <div className="mb-4">
            <h3 className="font-bold text-gray-700 mb-2">Copy to:</h3>
            {otherChildren.length === 0 ? (
              <p className="text-sm text-gray-400">No other children to copy to</p>
            ) : (
              <div className="space-y-2">
                {otherChildren.map(child => (
                  <label key={child.id} className="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" checked={selectedChildren.includes(child.id)} onChange={() => toggleChild(child.id)} className="w-4 h-4" />
                    <span className="text-lg">{child.avatar}</span>
                    <span className="text-sm">{child.name}</span>
                  </label>
                ))}
              </div>
            )}
          </div>
          <div className="flex gap-2">
            <button onClick={onClose} className="flex-1 py-3 text-gray-500 hover:bg-gray-100 rounded-xl font-medium">Cancel</button>
            <button onClick={handleCopy} disabled={selectedChores.length === 0 || selectedChildren.length === 0} className="flex-1 py-3 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-xl font-bold disabled:opacity-50">Copy</button>
          </div>
        </div>
      </div>
    </div>
  );
};

// Chores View Component
const ChoresView = ({ child, children, choreProgress, onToggleChore }) => {
  const [askWhoDidIt, setAskWhoDidIt] = useState(null);
  const [selectedHelpers, setSelectedHelpers] = useState([]);
  const chores = child?.chores || [];
  
  if (chores.length === 0) {
    return (
      <div className="text-center py-10 bg-white/80 rounded-3xl shadow-lg">
        <div className="text-6xl mb-4">ğŸ§¹</div>
        <h3 className="text-xl font-bold text-gray-700 mb-2">No Chores Yet</h3>
        <p className="text-gray-500">Add chores in the child's profile!</p>
      </div>
    );
  }
  
  const siblings = children.filter(c => c.id !== child.id);
  
  const handleCheck = (choreId, day = null) => {
    const key = day ? `${child.id}-${choreId}-${day}` : `${child.id}-${choreId}`;
    if (choreProgress[key]?.completed) {
      onToggleChore(child.id, choreId, day, null);
    } else if (siblings.length > 0) {
      setAskWhoDidIt({ choreId, day });
      setSelectedHelpers([]);
    } else {
      onToggleChore(child.id, choreId, day, { type: 'self' });
    }
  };
  
  const handleComplete = (type, data = {}) => {
    if (!askWhoDidIt) return;
    onToggleChore(child.id, askWhoDidIt.choreId, askWhoDidIt.day, { type, ...data });
    setAskWhoDidIt(null);
    setSelectedHelpers([]);
  };
  
  const toggleHelper = (id) => setSelectedHelpers(prev => prev.includes(id) ? prev.filter(h => h !== id) : [...prev, id]);
  
  const getCompletedCount = () => {
    let count = 0;
    chores.forEach(chore => {
      if (chore.days?.length > 0) {
        chore.days.forEach(day => { if (choreProgress[`${child.id}-${chore.id}-${day}`]?.completed) count++; });
      } else {
        if (choreProgress[`${child.id}-${chore.id}`]?.completed) count++;
      }
    });
    return count;
  };
  
  const getTotalCount = () => chores.reduce((sum, c) => sum + (c.days?.length > 0 ? c.days.length : 1), 0);
  
  return (
    <div className="space-y-4">
      {askWhoDidIt && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-3xl shadow-2xl max-w-sm w-full overflow-hidden">
            <div className="bg-gradient-to-r from-purple-500 to-pink-500 p-5 text-white text-center">
              <div className="text-4xl mb-2">ğŸ¤</div>
              <h2 className="text-xl font-bold">Who did this chore?</h2>
            </div>
            <div className="p-5 space-y-3">
              <button onClick={() => handleComplete('self')} className="w-full py-3 bg-gradient-to-r from-green-400 to-emerald-500 text-white rounded-xl font-bold">
                {child.avatar} {child.name} did it
              </button>
              {siblings.length > 0 && (
                <>
                  <div className="bg-blue-50 rounded-xl p-3 border border-blue-200">
                    <p className="text-sm text-blue-700 font-medium mb-2 text-center">ğŸ¤ Sibling(s) helped! (Everyone gets points)</p>
                    <div className="flex flex-wrap gap-2 justify-center">
                      {siblings.map(s => (
                        <button key={s.id} onClick={() => toggleHelper(s.id)}
                          className={`px-3 py-2 rounded-lg font-medium ${selectedHelpers.includes(s.id) ? 'bg-blue-500 text-white' : 'bg-white text-gray-700 border'}`}
                        >{s.avatar} {s.name}</button>
                      ))}
                    </div>
                    {selectedHelpers.length > 0 && (
                      <button onClick={() => handleComplete('helped', { helpers: selectedHelpers })} className="w-full mt-2 py-2 bg-blue-500 text-white rounded-lg font-bold">âœ“ Confirm</button>
                    )}
                  </div>
                  <div className="bg-purple-50 rounded-xl p-3 border border-purple-200">
                    <p className="text-sm text-purple-700 font-medium mb-2 text-center">â­ Sibling did it! (+5 bonus)</p>
                    <div className="flex flex-wrap gap-2 justify-center">
                      {siblings.map(s => (
                        <button key={s.id} onClick={() => handleComplete('sibling_did', { siblingId: s.id })}
                          className="px-3 py-2 bg-purple-500 text-white rounded-lg font-medium">{s.avatar} {s.name} did it all</button>
                      ))}
                    </div>
                  </div>
                </>
              )}
              <button onClick={() => { setAskWhoDidIt(null); setSelectedHelpers([]); }} className="w-full py-2 text-gray-500 hover:bg-gray-100 rounded-xl">Cancel</button>
            </div>
          </div>
        </div>
      )}
      
      <div className="bg-white/90 rounded-2xl p-4 shadow-md">
        <div className="flex items-center justify-between mb-4">
          <h3 className="font-bold text-gray-700 text-lg">{child.name}'s Chores</h3>
          <span className="text-sm bg-purple-100 text-purple-700 px-2 py-1 rounded-full">{getCompletedCount()}/{getTotalCount()} done</span>
        </div>
        <div className="space-y-3">
          {chores.map(chore => {
            const hasDays = chore.days?.length > 0;
            
            if (hasDays) {
              return (
                <div key={chore.id} className="bg-gray-50 rounded-xl p-3 border border-gray-200">
                  <div className="flex items-center justify-between mb-2">
                    <span className="font-medium text-gray-700">{chore.name}</span>
                    <span className="text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full">{chore.points} pts/day</span>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {chore.days.map(day => {
                      const key = `${child.id}-${chore.id}-${day}`;
                      const done = choreProgress[key]?.completed;
                      const res = choreProgress[key]?.result || {};
                      const helpers = (res.helpers || []).map(id => children.find(c => c.id === id)).filter(Boolean);
                      const sibDid = res.type === 'sibling_did' ? children.find(c => c.id === res.siblingId) : null;
                      return (
                        <button key={day} onClick={() => handleCheck(chore.id, day)}
                          className={`flex flex-col items-center p-2 rounded-lg min-w-[50px] ${done ? 'bg-green-100 border-2 border-green-400' : 'bg-white border border-gray-300 hover:border-purple-400'}`}>
                          <span className="text-xs font-medium text-gray-500">{day}</span>
                          <span className={`text-lg ${done ? 'text-green-600' : 'text-gray-300'}`}>{done ? 'âœ“' : 'â—‹'}</span>
                          {helpers.length > 0 && <span className="text-[10px] text-blue-600">{helpers.map(h => h.avatar).join('')}</span>}
                          {sibDid && <span className="text-[10px] text-purple-600">{sibDid.avatar}â­</span>}
                        </button>
                      );
                    })}
                  </div>
                </div>
              );
            }
            
            const key = `${child.id}-${chore.id}`;
            const done = choreProgress[key]?.completed;
            const res = choreProgress[key]?.result || {};
            const helpers = (res.helpers || []).map(id => children.find(c => c.id === id)).filter(Boolean);
            const sibDid = res.type === 'sibling_did' ? children.find(c => c.id === res.siblingId) : null;
            
            return (
              <div key={chore.id} onClick={() => handleCheck(chore.id)}
                className={`flex items-center justify-between p-3 rounded-xl cursor-pointer ${done ? 'bg-green-100 border-2 border-green-300' : 'bg-gray-50 border border-gray-200 hover:bg-gray-100'}`}>
                <div className="flex items-center gap-3">
                  <div className={`w-7 h-7 rounded-full flex items-center justify-center text-white text-sm font-bold ${done ? 'bg-green-500' : 'bg-gray-300'}`}>{done ? 'âœ“' : ''}</div>
                  <div>
                    <span className={`font-medium ${done ? 'line-through text-gray-500' : 'text-gray-700'}`}>{chore.name}</span>
                    {helpers.length > 0 && <div className="text-xs text-blue-600">ğŸ¤ {helpers.map(h => h.name).join(', ')} helped</div>}
                    {sibDid && <div className="text-xs text-purple-600">â­ {sibDid.name} did it (+5)</div>}
                  </div>
                </div>
                <span className={`text-sm font-bold px-2 py-1 rounded-lg ${done ? 'bg-green-200 text-green-700' : 'bg-amber-100 text-amber-700'}`}>{chore.points} pts</span>
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
};

// Tab Navigation Component
const TabNavigation = ({ activeTab, onTabChange, hasChores }) => (
  <div className="flex gap-2 mb-4">
    <button onClick={() => onTabChange('lunches')}
      className={`flex-1 py-2.5 rounded-xl font-bold transition-all flex items-center justify-center gap-2 ${
        activeTab === 'lunches' ? 'bg-gradient-to-r from-orange-400 to-pink-500 text-white shadow-lg' : 'bg-white/80 text-gray-600 hover:bg-white'
      }`}>
      <BentoIcon size={20} /> Lunches
    </button>
    <button onClick={() => onTabChange('chores')}
      className={`flex-1 py-2.5 rounded-xl font-bold transition-all flex items-center justify-center gap-2 ${
        activeTab === 'chores' ? 'bg-gradient-to-r from-purple-400 to-indigo-500 text-white shadow-lg' : 'bg-white/80 text-gray-600 hover:bg-white'
      }`}>
      ğŸ§¹ Chores {!hasChores && <span className="text-xs opacity-70">(Add!)</span>}
    </button>
  </div>
);

function LunchboxApp() {
  // No login required - app is ready to use immediately
  const [children, setChildren] = useState(() => {
    const saved = localStorage.getItem('lunchbox-children');
    return saved ? JSON.parse(saved) : [];
  });
  const [selectedChild, setSelectedChild] = useState(null);
  const [editingChild, setEditingChild] = useState(null);
  const [showAddChild, setShowAddChild] = useState(false);
  
  const [currentView, setCurrentView] = useState('planner'); // 'planner' | 'day'
  const [currentDay, setCurrentDay] = useState('Monday');
  const [weekPlan, setWeekPlan] = useState(() => {
    const saved = localStorage.getItem('lunchbox-weekplan');
    return saved ? JSON.parse(saved) : {};
  });
  
  // NEW: Week history for tracking progress over time
  const [weekHistory, setWeekHistory] = useState(() => {
    const saved = localStorage.getItem('lunchbox-week-history');
    return saved ? JSON.parse(saved) : [];
  });
  
  // NEW: Favorite lunch combinations
  const [favorites, setFavorites] = useState(() => {
    const saved = localStorage.getItem('lunchbox-favorites');
    return saved ? JSON.parse(saved) : [];
  });
  
  // Persist new state to localStorage
  useEffect(() => {
    localStorage.setItem('lunchbox-week-history', JSON.stringify(weekHistory));
  }, [weekHistory]);
  
  useEffect(() => {
    localStorage.setItem('lunchbox-favorites', JSON.stringify(favorites));
  }, [favorites]);
  
  // Persist children to localStorage
  useEffect(() => {
    localStorage.setItem('lunchbox-children', JSON.stringify(children));
  }, [children]);
  
  // Keep selectedChild in sync with children array (for points updates etc)
  useEffect(() => {
    if (selectedChild) {
      const updated = children.find(c => c.id === selectedChild.id);
      if (updated && JSON.stringify(updated) !== JSON.stringify(selectedChild)) {
        setSelectedChild(updated);
      }
    }
  }, [children]);
  
  // Persist weekPlan to localStorage
  useEffect(() => {
    localStorage.setItem('lunchbox-weekplan', JSON.stringify(weekPlan));
  }, [weekPlan]);
  const [daySelections, setDaySelections] = useState({});
  const [viewingDay, setViewingDay] = useState(null); // For viewing completed lunchbox
  const [selectedCategory, setSelectedCategory] = useState(null); // For food selector modal
  const [manualComplete, setManualComplete] = useState(false); // Manual "lunchbox is full" override
  
  const [showShoppingList, setShowShoppingList] = useState(false);
  const [showToDos, setShowToDos] = useState(false);
  const [showNewWeekSummary, setShowNewWeekSummary] = useState(false);
  const [showHistory, setShowHistory] = useState(false);
  const [showFavorites, setShowFavorites] = useState(false);
  const [showInstallGuide, setShowInstallGuide] = useState(false);
  const [licenseStatus, setLicenseStatus] = useState(() => getLicenseStatus());
  const [showPaywall, setShowPaywall] = useState(false);
  const [copyLunchModal, setCopyLunchModal] = useState({ show: false, day: null, fromChild: null });
  
  // Progress tracking state
  const [weekProgress, setWeekProgress] = useState(() => {
    const saved = localStorage.getItem('lunchbox-week-progress');
    return saved ? JSON.parse(saved) : {
      plannedLunch: false,
      checkedShoppingItem: false,
      completedTodo: false,
      completedChore: false,
      madeLunch: false,
      ateAll: false,
      skipped: false
    };
  });
  const [showProgressDetails, setShowProgressDetails] = useState(false);
  
  // Chores state
  const [choreProgress, setChoreProgress] = useState(() => {
    const saved = localStorage.getItem('lunchbox-chore-progress');
    return saved ? JSON.parse(saved) : {};
  });
  const [activeTab, setActiveTab] = useState('lunches');
  const [showCopyChores, setShowCopyChores] = useState(null);
  
  // More menu state
  const [showMore, setShowMore] = useState(false);
  const [showClearDataConfirm, setShowClearDataConfirm] = useState(false);
  const [showResetPoints, setShowResetPoints] = useState(false);
  
  // Rewards state
  const [customRewards, setCustomRewards] = useState(() => {
    const saved = localStorage.getItem('lunchbox-custom-rewards');
    return saved ? JSON.parse(saved) : [];
  });
  const [showRewards, setShowRewards] = useState(false);
  const [showSupportModal, setShowSupportModal] = useState(false);
  
  // Benny popup state
  const [bennyPopup, setBennyPopup] = useState({ show: false, mood: 'happy', message: '' });
  
  // Tutorial state
  const homeTutorial = useTutorial('home');
  const plannerTutorial = useTutorial('planner');
  const bentoTutorial = useTutorial('bento');
  
  // Show Benny with a message
  const showBenny = (mood, messageType) => {
    const message = getRandomBennyMessage(messageType);
    setBennyPopup({ show: true, mood, message });
  };
  
  // Show welcome Benny on first load
  useEffect(() => {
    if (!homeTutorial.hasSeenTutorial && children.length === 0) {
      setTimeout(() => {
        showBenny('happy', 'greeting');
      }, 500);
    }
  }, []);
  
  // Check license status on load
  useEffect(() => {
    const status = getLicenseStatus();
    setLicenseStatus(status);
    if (!status.valid) {
      setShowPaywall(true);
    }
  }, []);
  
  // Track manual complete status per child per day
  const [manualCompleteByDay, setManualCompleteByDay] = useState(() => {
    const saved = localStorage.getItem('lunchbox-manual-complete');
    return saved ? JSON.parse(saved) : {};
  });
  
  // Save manualCompleteByDay to localStorage
  useEffect(() => {
    localStorage.setItem('lunchbox-manual-complete', JSON.stringify(manualCompleteByDay));
  }, [manualCompleteByDay]);
  
  // Track parent credits: who made lunch, who did prep, who did shopping
  const [parentCredits, setParentCredits] = useState(() => {
    const saved = localStorage.getItem('lunchbox-parent-credits');
    return saved ? JSON.parse(saved) : {};
  });
  
  // Save parentCredits to localStorage
  useEffect(() => {
    localStorage.setItem('lunchbox-parent-credits', JSON.stringify(parentCredits));
  }, [parentCredits]);
  
  // Track who did each to-do task (for parent competition)
  const [todoCredits, setTodoCredits] = useState(() => {
    const saved = localStorage.getItem('lunchbox-todo-credits');
    return saved ? JSON.parse(saved) : {};
  });
  
  // Save todoCredits to localStorage
  useEffect(() => {
    localStorage.setItem('lunchbox-todo-credits', JSON.stringify(todoCredits));
  }, [todoCredits]);
  
  // Track which days each child ate all their lunch
  const [ateAllLunch, setAteAllLunch] = useState(() => {
    const saved = localStorage.getItem('lunchbox-ate-all');
    return saved ? JSON.parse(saved) : {};
  });
  
  // Save ateAllLunch to localStorage
  useEffect(() => {
    localStorage.setItem('lunchbox-ate-all', JSON.stringify(ateAllLunch));
  }, [ateAllLunch]);
  
  // Save weekProgress to localStorage
  useEffect(() => {
    localStorage.setItem('lunchbox-week-progress', JSON.stringify(weekProgress));
  }, [weekProgress]);
  
  // Save choreProgress to localStorage
  useEffect(() => {
    localStorage.setItem('lunchbox-chore-progress', JSON.stringify(choreProgress));
  }, [choreProgress]);
  
  // Save customRewards to localStorage
  useEffect(() => {
    localStorage.setItem('lunchbox-custom-rewards', JSON.stringify(customRewards));
  }, [customRewards]);

  // Custom Foods state - allows users to add their own food items
  const [customFoods, setCustomFoods] = useState(() => {
    const saved = localStorage.getItem('lunchbox-custom-foods');
    return saved ? JSON.parse(saved) : {};
  });

  // Save customFoods to localStorage
  useEffect(() => {
    localStorage.setItem('lunchbox-custom-foods', JSON.stringify(customFoods));
  }, [customFoods]);

  // Custom food handlers
  const handleAddCustomFood = (category, item) => {
    setCustomFoods(prev => ({
      ...prev,
      [category]: [...(prev[category] || []), item]
    }));
  };

  const handleEditCustomFood = (category, item) => {
    setCustomFoods(prev => ({
      ...prev,
      [category]: (prev[category] || []).map(f => f.id === item.id ? item : f)
    }));
  };

  const handleDeleteCustomFood = (category, itemId) => {
    setCustomFoods(prev => ({
      ...prev,
      [category]: (prev[category] || []).filter(f => f.id !== itemId)
    }));
  };
  
  // Chore management functions
  const handleAddChore = (childId, chore) => {
    const newChore = { ...chore, id: Date.now().toString(), days: chore.days || [] };
    setChildren(prev => prev.map(child => {
      if (child.id === childId) {
        return { ...child, chores: [...(child.chores || []), newChore] };
      }
      return child;
    }));
    // Also update editingChild so UI reflects changes immediately
    if (editingChild?.id === childId) {
      setEditingChild(prev => ({ ...prev, chores: [...(prev.chores || []), newChore] }));
    }
  };
  
  const handleUpdateChore = (childId, choreId, updates) => {
    setChildren(prev => prev.map(child => {
      if (child.id === childId) {
        return { ...child, chores: (child.chores || []).map(c => c.id === choreId ? { ...c, ...updates } : c) };
      }
      return child;
    }));
    // Also update editingChild
    if (editingChild?.id === childId) {
      setEditingChild(prev => ({ ...prev, chores: (prev.chores || []).map(c => c.id === choreId ? { ...c, ...updates } : c) }));
    }
  };
  
  const handleDeleteChore = (childId, choreId) => {
    setChildren(prev => prev.map(child => {
      if (child.id === childId) {
        return { ...child, chores: (child.chores || []).filter(c => c.id !== choreId) };
      }
      return child;
    }));
    // Also update editingChild
    if (editingChild?.id === childId) {
      setEditingChild(prev => ({ ...prev, chores: (prev.chores || []).filter(c => c.id !== choreId) }));
    }
  };
  
  const handleCopyChores = (fromChildId, toChildIds, choreIds) => {
    const fromChild = children.find(c => c.id === fromChildId);
    if (!fromChild?.chores) return;
    const choresToCopy = fromChild.chores.filter(c => choreIds.includes(c.id));
    setChildren(prev => prev.map(child => {
      if (toChildIds.includes(child.id)) {
        const existingNames = (child.chores || []).map(c => c.name.toLowerCase());
        const newChores = choresToCopy.filter(c => !existingNames.includes(c.name.toLowerCase()))
          .map(c => ({ ...c, id: Date.now().toString() + Math.random() }));
        return { ...child, chores: [...(child.chores || []), ...newChores] };
      }
      return child;
    }));
  };
  
  const handleToggleChore = (childId, choreId, day = null, result = null) => {
    const key = day ? `${childId}-${choreId}-${day}` : `${childId}-${choreId}`;
    const wasCompleted = choreProgress[key]?.completed;
    
    if (wasCompleted) {
      setChoreProgress(prev => ({ ...prev, [key]: undefined }));
      return;
    }
    
    if (!result) return;
    
    const child = children.find(c => c.id === childId);
    const chore = child?.chores?.find(c => c.id === choreId);
    
    trackEvent('chore_completed', { 
      child_name: child?.name || 'unknown',
      chore_name: chore?.name || 'unknown'
    });
    
    setChoreProgress(prev => ({ ...prev, [key]: { completed: true, result, date: new Date().toISOString() } }));
    setWeekProgress(prev => ({ ...prev, completedChore: true }));
    
    if (!chore) return;
    
    const pts = chore.points || 0;
    
    if (result.type === 'self') {
      setChildren(prev => prev.map(c => c.id === childId ? { ...c, points: (c.points || 0) + pts } : c));
    } else if (result.type === 'helped') {
      setChildren(prev => prev.map(c => (c.id === childId || (result.helpers || []).includes(c.id)) ? { ...c, points: (c.points || 0) + pts } : c));
      showBenny('happy', 'kindness');
    } else if (result.type === 'sibling_did') {
      setChildren(prev => prev.map(c => c.id === result.siblingId ? { ...c, points: (c.points || 0) + pts + 5 } : c));
      showBenny('happy', 'kindness');
    }
  };
  
  // Reward management functions
  const handleAddReward = (reward) => {
    setCustomRewards(prev => [...prev, reward]);
  };
  
  const handleDeleteReward = (rewardId) => {
    setCustomRewards(prev => prev.filter(r => r.id !== rewardId));
  };
  
  const handleRedeemReward = (reward, child) => {
    trackEvent('reward_redeemed', { 
      reward_name: reward.name,
      child_name: child.name,
      points_cost: reward.pointsCost
    });
    // Deduct points from child
    setChildren(prev => prev.map(c => 
      c.id === child.id 
        ? { ...c, points: Math.max(0, (c.points || 0) - reward.pointsCost) }
        : c
    ));
    // Show Benny celebrating
    showBenny('excited', 'points');
  };
  
  // Reset points for selected children
  const handleResetChildrenPoints = (childIds) => {
    setChildren(prev => prev.map(c => 
      childIds.includes(c.id) 
        ? { ...c, points: 0 }
        : c
    ));
    setShowMore(false);
  };
  
  // Toggle ate all lunch for a day
  const handleToggleAteAll = (day) => {
    if (!selectedChild) return;
    const childKey = selectedChild.id;
    const wasChecked = ateAllLunch?.[childKey]?.[day];
    setAteAllLunch(prev => ({
      ...prev,
      [childKey]: {
        ...(prev[childKey] || {}),
        [day]: !prev[childKey]?.[day]
      }
    }));
    // Update progress when marking ate all (not unchecking)
    if (!wasChecked) {
      setWeekProgress(prev => ({ ...prev, ateAll: true }));
    }
  };
  
  // Award points to selected child
  const handleAwardPoints = (points) => {
    if (!selectedChild) return;
    setChildren(prev => prev.map(child => 
      child.id === selectedChild.id 
        ? { ...child, points: (child.points || 0) + points }
        : child
    ));
  };
  
  // Start a new week - reset plans, ate all, and points
  // Generate surprise lunches for the entire week
  const handleStartNewWeek = () => {
    // Save current week to history before resetting
    if (Object.keys(weekPlan).length > 0) {
      const weekSummary = {
        id: Date.now(),
        date: new Date().toISOString(),
        weekEnding: new Date().toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' }),
        childStats: children.map(child => {
          const childPlan = weekPlan[child.id] || {};
          const daysPlanned = Object.values(childPlan).filter(day => 
            Object.values(day || {}).some(items => items?.length > 0)
          ).length;
          return {
            id: child.id,
            name: child.name,
            avatar: child.avatar,
            pointsEarned: child.points || 0,
            daysPlanned,
            ateAllCount: Object.values(ateAllLunch[child.id] || {}).filter(Boolean).length,
            weekPlan: { ...childPlan } // Store the actual lunch plans
          };
        }),
        parentCredits: { ...parentCredits },
        totalMealsPlanned: Object.values(weekPlan).reduce((sum, childPlan) => {
          return sum + Object.values(childPlan || {}).filter(day => 
            Object.values(day || {}).some(items => items?.length > 0)
          ).length;
        }, 0)
      };
      setWeekHistory(prev => [weekSummary, ...prev].slice(0, 12)); // Keep last 12 weeks
    }
    
    // Reset week plan for all children
    setWeekPlan({});
    // Reset ate all lunch tracking
    setAteAllLunch({});
    // Reset parent credits
    setParentCredits({});
    // Reset todo credits
    setTodoCredits({});
    // Reset manual complete status
    setManualCompleteByDay({});
    // Reset weekly progress
    setWeekProgress({
      plannedLunch: false,
      checkedShoppingItem: false,
      completedTodo: false,
      completedChore: false,
      madeLunch: false,
      ateAll: false,
      skipped: false
    });
    // Reset chore progress
    setChoreProgress({});
    // NOTE: Children's points now carry over to the next week for rewards!
    // Clear localStorage for todos and chores
    localStorage.removeItem('lunchbox-todos-checked');
    localStorage.removeItem('lunchbox-todo-credits');
    localStorage.removeItem('lunchbox-chore-progress');
    // Close modal
    setShowNewWeekSummary(false);
    // Show Benny
    showBenny('happy', 'greeting');
  };
  
  // Clear all data (keeps license)
  const handleClearData = () => {
    // Reset all state
    setChildren([]);
    setWeekPlan({});
    setWeekHistory([]);
    setFavorites({});
    setAteAllLunch({});
    setParentCredits({});
    setTodoCredits({});
    setManualCompleteByDay({});
    setSelectedChild(null);
    setChoreProgress({});
    setActiveTab('lunches');
    setWeekProgress({
      plannedLunch: false,
      checkedShoppingItem: false,
      completedTodo: false,
      completedChore: false,
      madeLunch: false,
      ateAll: false,
      skipped: false
    });
    setCustomRewards([]);
    
    // Clear localStorage (except license)
    localStorage.removeItem('lunchbox-children');
    localStorage.removeItem('lunchbox-week-plan');
    localStorage.removeItem('lunchbox-week-history');
    localStorage.removeItem('lunchbox-favorites');
    localStorage.removeItem('lunchbox-ate-all');
    localStorage.removeItem('lunchbox-parent-credits');
    localStorage.removeItem('lunchbox-todo-credits');
    localStorage.removeItem('lunchbox-manual-complete');
    localStorage.removeItem('lunchbox-todos-checked');
    localStorage.removeItem('lunchbox-week-progress');
    localStorage.removeItem('lunchbox-custom-rewards');
    localStorage.removeItem('lunchbox-custom-foods');
    localStorage.removeItem('lunchbox-chore-progress');
    
    // Close modals
    setShowClearDataConfirm(false);
    setShowMore(false);
  };
  
  // Save current day's lunch as a favorite
  const saveFavorite = (childId, day, name) => {
    const childPlan = weekPlan[childId];
    if (!childPlan || !childPlan[day]) return;
    
    const favorite = {
      id: Date.now(),
      name: name || `${day}'s lunch`,
      createdAt: new Date().toISOString(),
      items: { ...childPlan[day] }
    };
    trackEvent('favorite_saved', { favorite_name: favorite.name });
    setFavorites(prev => [...prev, favorite]);
    showBenny('happy', 'celebration');
  };
  
  // Apply a favorite to a day
  const applyFavorite = (favoriteId, childId, day) => {
    const favorite = favorites.find(f => f.id === favoriteId);
    if (!favorite) return;
    
    setWeekPlan(prev => ({
      ...prev,
      [childId]: {
        ...(prev[childId] || {}),
        [day]: { ...favorite.items }
      }
    }));
  };
  
  // Delete a favorite
  const deleteFavorite = (favoriteId) => {
    setFavorites(prev => prev.filter(f => f.id !== favoriteId));
  };
  
  // Copy lunch from one child to another
  const copyLunchToChild = (fromChildId, toChildId, day) => {
    const sourcePlan = weekPlan[fromChildId]?.[day];
    if (!sourcePlan) return;
    
    setWeekPlan(prev => ({
      ...prev,
      [toChildId]: {
        ...(prev[toChildId] || {}),
        [day]: { ...sourcePlan }
      }
    }));
    setCopyLunchModal({ show: false, day: null, fromChild: null });
    showBenny('happy', 'celebration');
  };
  
  // Filter food items by dietary mode
  const filterByDietaryMode = (items) => {
    const childDietaryMode = selectedChild?.dietaryMode || 'none';
    if (childDietaryMode === 'none') return items;
    
    // Don't filter - show all items but they'll be highlighted in the modal
    // The surprise buttons use getAvailableItemsForCategory which properly filters
    return items;
  };
  
  // Check if an item conflicts with dietary preferences (for highlighting in modal)
  const checkDietaryConflict = (item) => {
    const childDietaryMode = selectedChild?.dietaryMode || 'none';
    if (childDietaryMode === 'none') return false;
    
    const mode = DIETARY_MODES[childDietaryMode];
    if (!mode) return false;
    
    // Check allergens from dietary mode
    if (mode.excludeAllergens?.length > 0) {
      if (item.allergens?.some(a => mode.excludeAllergens.includes(a.toLowerCase()))) {
        return true;
      }
    }
    // Check excluded items by name
    if (mode.excludeItems?.length > 0) {
      const itemName = item.name.toLowerCase();
      if (mode.excludeItems.some(excluded => itemName.includes(excluded))) {
        return true;
      }
    }
    return false;
  };

  // Get bento layout from selected child (or default)
  const getChildLayout = () => {
    const layoutId = selectedChild?.bentoLayout || 'classic';
    // If custom layout, return the saved custom layout
    if (layoutId === 'custom' && selectedChild?.customLayout) {
      return selectedChild.customLayout;
    }
    return BENTO_LAYOUTS[layoutId] || BENTO_LAYOUTS.classic;
  };
  
  // Generate surprise lunches for the entire week
  const handleSurpriseWeek = () => {
    if (!selectedChild) return;
    
    trackEventThrottled('surprise_week_used', { child_name: selectedChild.name });
    
    const childKey = selectedChild.id;
    const layout = getChildLayout();
    const newWeekPlan = {};
    
    DAYS.forEach(day => {
      const surprise = generateSurpriseLunchbox(selectedChild, layout);
      newWeekPlan[day] = surprise;
    });
    
    // Update week plan for this child (points only awarded when eating via "Ate it!" button)
    setWeekPlan(prev => ({
      ...prev,
      [childKey]: newWeekPlan
    }));
    
    // Update progress - planning lunches via Surprise Week counts!
    setWeekProgress(prev => ({ ...prev, plannedLunch: true }));
    
    // Show Benny celebrating the surprise
    showBenny('excited', 'surpriseWeek');
  };

  // Initialize day selections when entering day view
  useEffect(() => {
    if (currentView === 'day') {
      const childKey = selectedChild?.id || 'default';
      const savedSelections = weekPlan[childKey]?.[currentDay] || {};
      // Ensure all categories have arrays
      const initialSelections = {};
      Object.keys(FOOD_DATABASE).forEach(cat => {
        initialSelections[cat] = savedSelections[cat] || [];
      });
      setDaySelections(initialSelections);
    }
  }, [currentView, currentDay, selectedChild]);

  const handleSelectFood = (category, items) => {
    const prevCount = daySelections[category]?.length || 0;
    const newCount = items.length;
    
    setDaySelections(prev => ({
      ...prev,
      [category]: items
    }));
    
    // Show Benny when adding food
    if (newCount > prevCount) {
      // If adding sweets, show worried Benny with warning (50% chance)
      if (category === 'sweets' && Math.random() < 0.5) {
        showBenny('worried', 'sweetsWarning');
      } 
      // Otherwise random chance for happy Benny (20% chance)
      else if (Math.random() < 0.2) {
        showBenny('happy', 'foodAdded');
      }
    }
  };

  const saveDayPlan = () => {
    const childKey = selectedChild?.id || 'default';
    
    // Save manual complete status if set
    if (manualComplete) {
      setManualCompleteByDay(prev => ({
        ...prev,
        [childKey]: {
          ...(prev[childKey] || {}),
          [currentDay]: true
        }
      }));
    }
    
    setWeekPlan(prev => ({
      ...prev,
      [childKey]: {
        ...prev[childKey],
        [currentDay]: daySelections
      }
    }));
    setManualComplete(false);
    setCurrentView('planner');
    
    // Update progress when planning lunch
    const itemCount = Object.values(daySelections).reduce((sum, arr) => sum + (arr?.length || 0), 0);
    if (itemCount > 0) {
      trackEvent('lunchbox_planned', { 
        day: currentDay, 
        child_name: selectedChild?.name || 'unknown',
        item_count: itemCount
      });
      setWeekProgress(prev => ({ ...prev, plannedLunch: true }));
    }
    
    // Show Benny celebrating the saved lunchbox
    if (itemCount > 0) {
      showBenny('happy', 'lunchComplete');
    }
  };

  const handleSaveChild = (childData) => {
    setChildren(prev => {
      const existing = prev.find(c => c.id === childData.id);
      if (existing) {
        trackEvent('child_updated', { child_name: childData.name });
        return prev.map(c => c.id === childData.id ? { ...childData, chores: c.chores || [], points: c.points || 0 } : c);
      }
      trackEvent('child_created', { child_name: childData.name });
      return [...prev, { ...childData, chores: [], points: 0 }];
    });
    setEditingChild(null);
    setShowAddChild(false);
    if (!selectedChild) {
      setSelectedChild(childData);
    }
  };

  const handleDeleteChild = (childId) => {
    setChildren(prev => prev.filter(c => c.id !== childId));
    if (selectedChild?.id === childId) {
      setSelectedChild(children.find(c => c.id !== childId) || null);
    }
    setEditingChild(null);
  };

  const childKey = selectedChild?.id || 'default';
  const currentWeekPlan = weekPlan[childKey] || {};

  return (
    <>
      <AnimatedBackground />
      
      <div className="min-h-screen">
        {/* Header */}
        <header className="bg-white/80 backdrop-blur-lg shadow-md sticky top-0 z-40">
          <div className="max-w-6xl mx-auto px-3 py-2 sm:px-4 sm:py-4">
            {/* Mobile: Two rows, Desktop: Single row */}
            <div className="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
              {/* Logo and title - always visible */}
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <BentoIcon size={36} className="hidden sm:block" />
                  <BentoIcon size={28} className="block sm:hidden" />
                  <div>
                    <h1 
                      className="text-lg sm:text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-orange-500 to-pink-500"
                      style={{ fontFamily: 'Fredoka, Comic Sans MS, cursive' }}
                    >
                      PAKT
                    </h1>
                    <p className="text-xs text-gray-500 hidden sm:block">Lunch. Chores. Done.</p>
                  </div>
                </div>
                
                {/* Mobile: Help + Install + Share buttons next to title */}
                <div className="flex gap-1.5 sm:hidden">
                  <button
                    onClick={() => setShowInstallGuide(true)}
                    className="p-2 bg-gradient-to-r from-blue-400 to-cyan-500 text-white rounded-lg shadow-md flex items-center gap-1"
                    title="Install App"
                  >
                    <span className="text-lg">ğŸ“²</span>
                  </button>
                  <button
                    onClick={() => homeTutorial.startTutorial()}
                    className="p-2 bg-gradient-to-r from-amber-400 to-orange-400 text-white rounded-lg shadow-md flex items-center gap-1"
                    title="Help & Tutorial"
                    data-tutorial="help-btn"
                  >
                    <span className="text-lg">â“</span>
                  </button>
                  <button
                    onClick={async () => {
                      if (navigator.share) {
                        try {
                          await navigator.share({
                            title: 'PAKT - Lunch. Chores. Done.',
                            text: 'Check out PAKT - the app that makes school mornings easier! Plan lunchboxes, track chores, and keep kids motivated.',
                            url: 'https://getpakt.app'
                          });
                        } catch (err) {
                          if (err.name !== 'AbortError') console.log('Share failed:', err);
                        }
                      } else {
                        navigator.clipboard.writeText('https://getpakt.app');
                        alert('Link copied to clipboard!');
                      }
                    }}
                    className="p-2 bg-gradient-to-r from-pink-400 to-rose-500 text-white rounded-lg shadow-md flex items-center gap-1"
                    title="Share PAKT"
                  >
                    <span className="text-lg">ğŸ“¤</span>
                  </button>
                </div>
              </div>
              
              {/* Action buttons - grid on mobile, flex on desktop */}
              <div className="grid grid-cols-4 gap-2 sm:flex sm:items-center sm:gap-3">
                {/* Install button - desktop only */}
                <button
                  onClick={() => setShowInstallGuide(true)}
                  className="hidden sm:flex p-3 bg-gradient-to-r from-blue-400 to-cyan-500 text-white rounded-xl font-bold shadow-md hover:shadow-lg transition-all items-center gap-1"
                  title="Install App"
                >
                  <span className="text-lg">ğŸ“²</span>
                  <span className="text-sm">Install</span>
                </button>
                {/* Help button - desktop only (mobile is above) */}
                <button
                  onClick={() => homeTutorial.startTutorial()}
                  className="hidden sm:flex p-3 bg-gradient-to-r from-amber-400 to-orange-400 text-white rounded-xl font-bold shadow-md hover:shadow-lg transition-all items-center gap-1"
                  title="Help & Tutorial"
                  data-tutorial="help-btn"
                >
                  <span className="text-lg">â“</span>
                  <span className="text-sm">Help</span>
                </button>
                {/* Share button - desktop only */}
                <button
                  onClick={async () => {
                    if (navigator.share) {
                      try {
                        await navigator.share({
                          title: 'PAKT - Lunch. Chores. Done.',
                          text: 'Check out PAKT - the app that makes school mornings easier! Plan lunchboxes, track chores, and keep kids motivated.',
                          url: 'https://getpakt.app'
                        });
                      } catch (err) {
                        if (err.name !== 'AbortError') console.log('Share failed:', err);
                      }
                    } else {
                      navigator.clipboard.writeText('https://getpakt.app');
                      alert('Link copied to clipboard!');
                    }
                  }}
                  className="hidden sm:flex p-3 bg-gradient-to-r from-pink-400 to-rose-500 text-white rounded-xl font-bold shadow-md hover:shadow-lg transition-all items-center gap-1"
                  title="Share PAKT"
                >
                  <span className="text-lg">ğŸ“¤</span>
                  <span className="text-sm">Share</span>
                </button>
                <button
                  onClick={() => setShowRewards(true)}
                  className="flex flex-col sm:flex-row items-center justify-center gap-0.5 sm:gap-1 p-2 sm:p-3 bg-gradient-to-r from-amber-500 to-yellow-500 text-white rounded-xl font-bold shadow-md hover:shadow-lg transition-all text-xs sm:text-base"
                  data-tutorial="rewards-btn"
                >
                  <span>ğŸ†</span>
                  <span className="text-[10px] sm:text-sm">Rewards</span>
                </button>
                <button
                  onClick={() => setShowToDos(true)}
                  className="flex flex-col sm:flex-row items-center justify-center gap-0.5 sm:gap-1 p-2 sm:p-3 bg-gradient-to-r from-green-500 to-teal-500 text-white rounded-xl font-bold shadow-md hover:shadow-lg transition-all text-xs sm:text-base"
                  data-tutorial="todos-btn"
                >
                  <span>âœ…</span>
                  <span className="text-[10px] sm:text-sm">To-Do's</span>
                </button>
                <button
                  onClick={() => setShowShoppingList(true)}
                  className="flex flex-col sm:flex-row items-center justify-center gap-0.5 sm:gap-1 p-2 sm:p-3 bg-gradient-to-r from-emerald-400 to-green-500 text-white rounded-xl font-bold shadow-md hover:shadow-lg transition-all text-xs sm:text-base"
                  data-tutorial="shopping-btn"
                >
                  <span>ğŸ›’</span>
                  <span className="text-[10px] sm:text-sm">Shop</span>
                </button>
                <button
                  onClick={() => setShowNewWeekSummary(true)}
                  className="flex flex-col sm:flex-row items-center justify-center gap-0.5 sm:gap-1 p-2 sm:p-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-bold shadow-md hover:shadow-lg transition-all text-xs sm:text-base"
                  data-tutorial="new-week-btn"
                >
                  <span>ğŸ‰</span>
                  <span className="text-[10px] sm:text-sm whitespace-nowrap">New Week</span>
                </button>
              </div>
            </div>
            
            {/* Quick Features Bar */}
            <div className="flex items-center justify-between gap-2 mt-2 pt-2 border-t border-gray-200">
              <div className="flex items-center gap-1.5 overflow-x-auto hide-scrollbar">
                {selectedChild?.dietaryMode && selectedChild.dietaryMode !== 'none' && (
                  <span className="flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 border border-green-300 rounded-full text-xs font-medium whitespace-nowrap">
                    {DIETARY_MODES[selectedChild.dietaryMode]?.icon} {selectedChild.name}: {DIETARY_MODES[selectedChild.dietaryMode]?.name}
                  </span>
                )}
                <button
                  onClick={() => setShowFavorites(true)}
                  className="flex items-center gap-1 px-2 py-1 bg-gray-100 hover:bg-pink-100 text-gray-600 hover:text-pink-600 rounded-full text-xs font-medium whitespace-nowrap transition-all"
                >
                  â¤ï¸ Favorites
                </button>
                <button
                  onClick={() => setShowHistory(true)}
                  className="flex items-center gap-1 px-2 py-1 bg-gray-100 hover:bg-indigo-100 text-gray-600 hover:text-indigo-600 rounded-full text-xs font-medium whitespace-nowrap transition-all"
                >
                  ğŸ“Š History
                </button>
                <button
                  onClick={() => setShowMore(true)}
                  className="flex items-center gap-1 px-2 py-1 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-full text-xs font-medium whitespace-nowrap transition-all"
                >
                  âš™ï¸ More
                </button>
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={() => setShowSupportModal(true)}
                  className="text-[10px] bg-gray-100 text-gray-500 px-2 py-0.5 rounded-full hover:bg-gray-200 transition-colors"
                  title="Contact Support"
                >
                  ğŸ’¬
                </button>
                {licenseStatus.licensed ? (
                  <button 
                    onClick={() => setShowPaywall(true)}
                    className="text-[10px] bg-green-100 text-green-600 px-2 py-0.5 rounded-full hover:bg-green-200 transition-colors cursor-pointer"
                  >
                    PRO âœ“
                  </button>
                ) : licenseStatus.valid && licenseStatus.daysLeft ? (
                  <button 
                    onClick={() => setShowPaywall(true)}
                    className="text-[10px] bg-amber-100 text-amber-600 px-2 py-0.5 rounded-full hover:bg-amber-200 transition-colors"
                  >
                    Trial: {licenseStatus.daysLeft}d left
                  </button>
                ) : null}
                <span className="text-[10px] text-gray-400 hidden sm:block">v{APP_VERSION}</span>
              </div>
            </div>
          </div>
        </header>

        <main className="max-w-6xl mx-auto px-3 py-4 sm:px-4 sm:py-6">
          {/* Children Section */}
          <section className="mb-6 sm:mb-8">
            <div className="flex items-center justify-between mb-3 sm:mb-4">
              <h2 className="text-lg sm:text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-purple-500 via-pink-500 to-orange-500" style={{ fontFamily: 'Fredoka, Comic Sans MS, cursive' }}>My Family</h2>
              <button
                onClick={() => setShowAddChild(true)}
                className="px-3 py-1.5 sm:px-4 sm:py-2 bg-gradient-to-r from-blue-400 to-purple-500 text-white font-bold rounded-xl shadow-md hover:shadow-lg transition-all text-xs sm:text-sm"
                data-tutorial="add-child-btn"
              >
                + Add Child
              </button>
            </div>
            
            {children.length > 0 ? (
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6" data-tutorial="child-cards">
                {children.map(child => (
                  <ChildCard
                    key={child.id}
                    child={child}
                    isSelected={selectedChild?.id === child.id}
                    onClick={() => setSelectedChild(child)}
                    onEdit={setEditingChild}
                  />
                ))}
              </div>
            ) : (
              <div className="bg-white/60 backdrop-blur-sm rounded-2xl p-8 text-center">
                <div className="text-4xl mb-3">ğŸ‘¶</div>
                <p className="text-gray-600 mb-4">Add your children to customize their lunchboxes!</p>
                <button
                  onClick={() => setShowAddChild(true)}
                  className="px-6 py-3 bg-gradient-to-r from-blue-400 to-purple-500 text-white font-bold rounded-xl shadow-md hover:shadow-lg transition-all"
                  data-tutorial="add-child-btn"
                >
                  + Add Your First Child
                </button>
              </div>
            )}
            
            {/* Progress Bar - shows below My Family */}
            {children.length > 0 && (
              <div className="mt-4">
                <ProgressBar 
                  progress={weekProgress}
                  onShowDetails={() => setShowProgressDetails(true)}
                  onSkip={() => setWeekProgress(prev => ({ ...prev, skipped: true }))}
                />
              </div>
            )}
          </section>

          {/* Tab Navigation - only show when child is selected and in planner view */}
          {selectedChild && currentView === 'planner' && (
            <TabNavigation
              activeTab={activeTab}
              onTabChange={setActiveTab}
              hasChores={(selectedChild?.chores || []).length > 0}
            />
          )}

          {/* Main Content */}
          {activeTab === 'chores' && selectedChild && currentView === 'planner' ? (
            <ChoresView
              child={selectedChild}
              children={children}
              choreProgress={choreProgress}
              onToggleChore={handleToggleChore}
            />
          ) : currentView === 'planner' ? (
            <WeeklyPlanner
              weekPlan={currentWeekPlan}
              selectedChild={selectedChild}
              onEditDay={(day) => {
                setCurrentDay(day);
                setCurrentView('day');
              }}
              onViewDay={(day) => setViewingDay(day)}
              ateAllLunch={ateAllLunch[selectedChild?.id] || {}}
              onToggleAteAll={handleToggleAteAll}
              onAwardPoints={handleAwardPoints}
              manualCompleteByDay={manualCompleteByDay}
              parentCredits={parentCredits}
              onUpdateParentCredit={(day, parent) => {
                if (!selectedChild) return;
                const childKey = selectedChild.id;
                setParentCredits(prev => ({
                  ...prev,
                  [childKey]: {
                    ...(prev[childKey] || {}),
                    [day]: { ...(prev[childKey]?.[day] || {}), madeBy: parent }
                  }
                }));
                // Update progress when marking who made lunch
                setWeekProgress(prev => ({ ...prev, madeLunch: true }));
              }}
              onSurpriseWeek={handleSurpriseWeek}
              onCopyLunch={(day, fromChild) => setCopyLunchModal({ show: true, day, fromChild })}
              onSaveFavorite={saveFavorite}
              children={children}
            />
          ) : (
            <InteractiveBentoBox
              selections={daySelections}
              day={currentDay}
              child={selectedChild}
              onSelectCategory={(category) => setSelectedCategory(category)}
              onSave={saveDayPlan}
              onBack={() => { setCurrentView('planner'); setManualComplete(false); }}
              onSurpriseMe={() => {
                trackEventThrottled('surprise_day_used', { day: currentDay, child_name: selectedChild?.name });
                const surprise = generateSurpriseLunchbox(selectedChild, getChildLayout());
                setDaySelections(surprise);
              }}
              layout={getChildLayout()}
              manualComplete={manualComplete}
              onToggleManualComplete={() => setManualComplete(prev => !prev)}
            />
          )}
        </main>
      </div>

      {/* Modals */}
      {(editingChild || showAddChild) && (
        <ChildEditor
          child={editingChild}
          onSave={handleSaveChild}
          onClose={() => { setEditingChild(null); setShowAddChild(false); }}
          onDelete={handleDeleteChild}
          onAddChore={handleAddChore}
          onUpdateChore={handleUpdateChore}
          onDeleteChore={handleDeleteChore}
          onShowCopyChores={(childId) => setShowCopyChores(childId)}
        />
      )}

      {showCopyChores && (
        <CopyChoresModal
          fromChild={children.find(c => c.id === showCopyChores)}
          allChildren={children}
          onCopy={handleCopyChores}
          onClose={() => setShowCopyChores(null)}
        />
      )}

      {showShoppingList && (
        <ShoppingList
          weekPlan={weekPlan}
          children={children}
          onClose={() => setShowShoppingList(false)}
          onItemChecked={() => {
            trackEvent('shopping_item_checked');
            setWeekProgress(prev => ({ ...prev, checkedShoppingItem: true }));
          }}
        />
      )}

      {showInstallGuide && (
        <InstallGuide onClose={() => setShowInstallGuide(false)} />
      )}

      {/* Support Modal */}
      {showSupportModal && (
        <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 text-center">
            <div className="text-4xl mb-4">ğŸ’¬</div>
            <h3 className="text-xl font-bold text-gray-800 mb-2">Need Help?</h3>
            <p className="text-gray-600 mb-4">Reach out to us anytime:</p>
            <a
              href="mailto:support@getpakt.app"
              className="inline-block px-6 py-3 bg-gradient-to-r from-orange-400 to-pink-500 text-white font-bold rounded-xl hover:shadow-lg transition-all mb-4"
            >
              âœ‰ï¸ support@getpakt.app
            </a>
            <p className="text-xs text-gray-400 mb-4">We typically respond within 24 hours</p>
            <button
              onClick={() => setShowSupportModal(false)}
              className="w-full py-2 text-gray-500 hover:bg-gray-100 rounded-xl transition-colors"
            >
              Close
            </button>
          </div>
        </div>
      )}

      {showPaywall && (
        <Paywall 
          onUnlock={() => {
            setLicenseStatus(getLicenseStatus());
            setShowPaywall(false);
          }}
          onClose={() => setShowPaywall(false)}
          isTrialActive={licenseStatus.valid && !licenseStatus.licensed && licenseStatus.daysLeft > 0}
          daysLeft={licenseStatus.daysLeft || 0}
          isLicensed={licenseStatus.licensed}
          storedLicenseKey={(() => {
            try {
              const stored = localStorage.getItem('lunchbox-license');
              return stored ? JSON.parse(stored).key : '';
            } catch { return ''; }
          })()}
        />
      )}

      {showToDos && (
        <MyToDos
          allWeekPlans={weekPlan}
          children={children}
          onClose={() => setShowToDos(false)}
          todoCredits={todoCredits}
          onUpdateTodoCredit={(taskId, parent) => {
            setTodoCredits(prev => ({
              ...prev,
              [taskId]: parent
            }));
          }}
          onTaskChecked={() => {
            trackEvent('todo_item_completed');
            setWeekProgress(prev => ({ ...prev, completedTodo: true }));
          }}
        />
      )}

      {showNewWeekSummary && (
        <NewWeekSummary
          children={children}
          weekPlan={weekPlan}
          ateAllLunch={ateAllLunch}
          parentCredits={parentCredits}
          todoCredits={todoCredits}
          onStartNewWeek={handleStartNewWeek}
          onClose={() => setShowNewWeekSummary(false)}
        />
      )}
      
      {/* Rewards Modal */}
      {showRewards && (
        <RewardsModal
          rewards={customRewards}
          onAddReward={handleAddReward}
          onDeleteReward={handleDeleteReward}
          onRedeemReward={handleRedeemReward}
          children={children}
          onClose={() => setShowRewards(false)}
        />
      )}
      
      {/* New Feature Modals */}
      {showHistory && (
        <WeekHistoryModal
          history={weekHistory}
          onClose={() => setShowHistory(false)}
        />
      )}
      
      {showFavorites && (
        <FavoritesModal
          favorites={favorites}
          onApply={applyFavorite}
          onDelete={deleteFavorite}
          onClose={() => setShowFavorites(false)}
          children={children}
          selectedChild={selectedChild}
          weekPlan={weekPlan}
        />
      )}
      
      {copyLunchModal.show && (
        <CopyLunchModal
          day={copyLunchModal.day}
          fromChild={copyLunchModal.fromChild}
          children={children}
          onCopy={copyLunchToChild}
          onClose={() => setCopyLunchModal({ show: false, day: null, fromChild: null })}
        />
      )}

      {viewingDay && currentWeekPlan[viewingDay] && (
        <BentoViewModal
          selections={currentWeekPlan[viewingDay]}
          day={viewingDay}
          childName={selectedChild?.name}
          layout={getChildLayout()}
          onClose={() => setViewingDay(null)}
        />
      )}

      {selectedCategory && (
        <FoodSelectorModal
          category={selectedCategory}
          child={selectedChild}
          selectedItems={daySelections[selectedCategory] || []}
          onSelect={handleSelectFood}
          onClose={() => setSelectedCategory(null)}
          dietaryFilter={filterByDietaryMode}
          checkDietaryConflict={checkDietaryConflict}
          customFoods={customFoods}
          onAddCustomFood={handleAddCustomFood}
          onEditCustomFood={handleEditCustomFood}
          onDeleteCustomFood={handleDeleteCustomFood}
        />
      )}
      
      {/* Benny Popup */}
      <BennyPopup
        show={bennyPopup.show}
        mood={bennyPopup.mood}
        message={bennyPopup.message}
        onClose={() => setBennyPopup({ show: false, mood: 'happy', message: '' })}
      />
      
      {/* Progress Details Modal */}
      {showProgressDetails && (
        <ProgressDetails
          progress={weekProgress}
          onClose={() => setShowProgressDetails(false)}
          onSkip={() => {
            setWeekProgress(prev => ({ ...prev, skipped: true }));
            setShowProgressDetails(false);
          }}
        />
      )}
      
      {/* More Menu Modal */}
      {showMore && (
        <MoreMenu
          onClose={() => setShowMore(false)}
          onClearData={() => setShowClearDataConfirm(true)}
          onResetPoints={() => setShowResetPoints(true)}
        />
      )}
      
      {/* Reset Points Modal */}
      {showResetPoints && (
        <ResetPointsModal
          children={children}
          onResetPoints={handleResetChildrenPoints}
          onClose={() => setShowResetPoints(false)}
        />
      )}
      
      {/* Clear Data Confirmation Modal */}
      {showClearDataConfirm && (
        <ClearDataConfirm
          onConfirm={handleClearData}
          onCancel={() => setShowClearDataConfirm(false)}
        />
      )}
      
      {/* Tutorial Overlay */}
      {homeTutorial.isActive && (
        <TutorialOverlay
          steps={TUTORIAL_STEPS.home}
          currentStep={homeTutorial.currentStep}
          onNext={homeTutorial.nextStep}
          onPrev={homeTutorial.prevStep}
          onClose={homeTutorial.endTutorial}
        />
      )}
    </>
  );
}

const container = document.getElementById('root');
const root = ReactDOM.createRoot(container);
root.render(React.createElement(LunchboxApp));
  </script>
</body>
</html>
